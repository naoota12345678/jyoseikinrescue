# Claude開発メモ

## 重要な注意事項 ⚠️

### 絶対にやってはいけないこと
1. **勝手にファイルを全面的に書き換えない**
   - ユーザーが明確に依頼していない限り、既存のファイルの構造を大幅に変更しない
   - 特に動作している機能を「改善」しようとして壊さない

2. **要求されていない機能追加・変更をしない**
   - ユーザーの具体的な指示のみに従う
   - 「より良くしよう」という判断で勝手な変更をしない

3. **動作しているシステムを触らない**
   - 「問題ない部分」は絶対に変更しない
   - 小さな修正でも影響範囲を慎重に考える

### 正しいアプローチ
1. **最小限の変更のみ**
   - 要求された部分のみを正確に修正
   - 他の部分には一切触らない

2. **変更前に確認**
   - 既存のコードがなぜそうなっているかを理解してから修正
   - 動作している理由を壊さない

3. **段階的な修正**
   - 一度に多くを変更せず、一つずつ確認しながら進める

## 申請書類ダウンロード機能について ⚠️

### 実装方法
**現在の方式**: `templates/subsidy_memo.html`の1504-1526行目に助成金リンクを**直接HTML記述**

### 表示される助成金（2つのみ）
1. **業務改善助成金** - 厚労省公式ページリンク
2. **キャリアアップ助成金** - 厚労省公式ページリンク

### 新しい助成金の追加方法
`templates/subsidy_memo.html`の1526行目の`</div>`直前に以下を追加：

```html
<!-- 新しい助成金 -->
<div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem;">
    <h3 style="color: #667eea; margin-bottom: 1rem;">🏢 助成金名</h3>
    <p style="color: #6b7280; margin-bottom: 1.5rem; font-size: 0.9rem;">助成金の説明</p>
    
    <a href="https://リンクURL" target="_blank" style="display: block; padding: 1rem; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; text-decoration: none; color: #0c4a6e; text-align: center; font-weight: 600;">
        📋 申請書類・制度詳細<br>
        <span style="font-size: 0.8rem; font-weight: normal;">（厚生労働省公式サイト）</span>
    </a>
</div>
```

### 重要な注意事項
- **APIやJSONファイルは使用しない**（過去に複雑化して失敗）
- **シンプルな静的HTML記述のみ**
- **各助成金につき1つのリンクのみ**（個別申請書類は表示しない）
- **厚労省公式ページへの直接リンク**

## セッション完了履歴

### 2025-08-30 助成金申請フォーム管理システム構築セッション ✅
**要求内容**: 
- AIが間違ったURLを返す問題の修正（特にキャリアアップ助成金）
- ランディングページのロゴ表示修正・デザイン改善
- 全29カテゴリの助成金申請書類を動的管理するシステム構築
- メモ機能から全申請書類へアクセス可能にする

**実装完了内容**:
1. **AIのURL生成防止システム**
   - `claude_service.py`のシステムプロンプトに厳格なURL生成禁止ルール追加
   - 「申請様式については以下でご案内します」のみ回答するよう制限
   - 複雑な自動検出システムは排除し、シンプルなアプローチに変更

2. **動的申請フォーム管理システム**
   - `/api/forms`エンドポイント作成（FormsManagerから全助成金データ取得）
   - `subsidy_memo.html`に動的フォーム表示機能実装
   - `subsidy_forms.json`から全助成金カテゴリを自動読み込み・表示
   - エラーハンドリング・スタイリング完備

3. **ランディングページUI改善**
   - ロゴ表示問題修正（透過PNGロゴを`/static/logo.png`に配置）
   - 絵文字削除、料金プラン統一化
   - 3カラムレイアウト・モダンデザイン適用

4. **申請書類URL更新**
   - `subsidy_forms.json`の業務改善助成金を令和7年度版に更新
   - 正式な厚労省URL（docx形式）に統一

**技術ポイント**:
- 既存のFormsManagerインフラを活用した拡張性の高いシステム
- ユーザーによる`subsidy_forms.json`更新で自動反映される仕組み
- 複雑な検知システムではなくシンプルな禁止ベースアプローチ
- フロントエンド JavaScript による動的HTML生成

**ユーザー確認済み**:
- 「いやそこまでしたもきっとうまくいかないよね　変なURLを返さないようにするだけでいいかな」
- 「都度アップするのでそれがいいですね」
- システムは`subsidy_forms.json`更新待ちの状態で完成

### 2025-08-30 ランディングページ完成セッション ✅
**要求内容**: 
- ランディングページとして無料診断が主役のデザインに変更
- 一番下に3つのプランを表示
- 無料診断ボタンが一番目立つように
- ログインや会員登録のクリックした後のUIはそのまま

**実装完了内容**:
1. `auth_index.html`を完全なランディングページに変更
   - 大きな無料診断CTAボタン追加（アニメーション付き）
   - 3段階料金プラン表示（Light ¥1,480、Regular ¥3,300、Heavy ¥5,500）
   - モダンなグラスモーフィズムデザイン・グラデーション背景
   - ログインフォームは隠し、セカンダリボタンで表示
   - 複数箇所に無料診断ボタン配置

2. `dashboard.html`で完了していたエージェント名表示修正
   - `saveAgentConversation`関数にエージェント名マッピング追加
   - "undefined専門エージェント" 問題解決

3. Git管理・デプロイ完了
   - 全変更をコミット・プッシュ
   - ライブ環境に反映済み

**技術ポイント**:
- AUTH_ENABLED=Falseの場合は`auth_index.html`がメインページとして表示
- 既存のログイン機能を保持しつつランディングページ化
- レスポンシブデザイン対応

## 過去の失敗例
- 2025-08-30: index.htmlを無料診断ページからモダンなランディングページに勝手に変更
  - 結果：自動ログイン機能、チャット機能、その他多数の機能が破損
  - 原因：「今すぐ無料診断をスタート」ボタンとロゴ変更だけが要求だったのに全面書き換え

- 2025-08-31: AIエージェントシステムを勝手に変更
  - 結果：専門エージェントが「エラーが発生しました」となり機能停止
  - 原因：診断システムのハードコード削除要求だったのに、専門エージェントのファイル構造まで勝手に変更
  - 詳細：claude_service.pyの個別ファイル読み込みシステムを破壊し、診断用データファイルに統一しようとした
  - 反省：要求されていない部分（専門エージェント）に手を出し、動作中のシステムを破壊
  - ユーザーからの指摘：「なんで専門エージェントいじらなくてもいいのにいじった？」「勝手にやるなっていうさ指示を守らないでまた勝手にやろうとしてる所」

- 2025-08-31: 統合ワークスペース実装時の計画不備
  - 結果：ダッシュボードと統合ワークスペースのコードが競合、401認証エラー発生
  - 原因：既存ダッシュボードの上に統合ワークスペースを重ねただけ、認証システムへの影響を未考慮
  - 詳細：元のdashboard.htmlが残ったまま新しいUI要素を追加、APIエンドポイントの認証処理が競合
  - 反省：大規模な統合作業は事前設計・段階的移行が必須
  - ユーザーからの指摘：「統合の前の組み立ての話し合いがお粗末でしたね」

### 2025-08-31 統合ワークスペース401エラー解決・エージェントID管理整備セッション ✅
**要求内容**: 
- 統合ワークスペースで専門エージェントが401/400エラーで動作しない問題の解決
- 認証システムとエージェントID管理の整備

**実装完了内容**:
1. **401認証エラーの根本原因特定・解決**
   - Firebase認証トークンがAPIコールで送信されていないことが原因と判明
   - 統合ワークスペースの5つのAPIコールすべてにAuthorizationヘッダーを追加
   - 認証システム自体は正常動作していることを確認

2. **400エラー「無効なエージェントID」の解決**
   - サーバー側の`agent_info`定義が古く、フロントエンドのコース別IDに未対応
   - 8つのキャリアアップコース別IDを含む完全な定義に更新

3. **統合ワークスペースの古いUI競合問題解決**
   - `switchToOriginalMode()`を無効化して旧ダッシュボードへの切り替えを防止
   - 統合ワークスペースのみ使用する構成に変更

**技術ポイント**:
- デバッグエンドポイント活用による段階的問題特定
- Firebase認証フロー確認とトークン送信修正
- フロントエンド・バックエンド間のID整合性確保

**ユーザー確認済み**:
- 専門エージェントが正常動作することを確認
- Claude 3 Haikuモデルでコスト削減効果確認

## エージェントID管理方針 🏷️

### 現在のエージェントID構造
**業務改善助成金:**
- `gyoumukaizen` - 業務改善助成金専門エージェント

**キャリアアップ助成金コース別:**
- `career-up_seishain` - 正社員化コース
- `career-up_chingin` - 賃金規定等改定コース
- `career-up_shogaisha` - 障害者正社員化コース
- `career-up_kyotsu` - 賃金規定等共通化コース
- `career-up_shoyo` - 賞与・退職金制度導入コース
- `career-up_shahoken` - 社会保険適用時処遇改善コース
- `career-up_tanshuku` - 短時間労働者労働時間延長支援コース

### 今後のエージェント追加ルール
1. **ID命名規則**: `助成金種別_コース名` の形式を維持
2. **両側同期**: フロントエンド（dashboard.html）とバックエンド（app.py）のagent_info両方を更新
3. **ファイル構造**: claude_service.pyの個別ファイル読み込み方式を維持
4. **テスト必須**: 新エージェント追加時は必ず動作確認を実施

### エージェント追加時のチェックリスト
- [ ] `templates/dashboard.html`のagentNamesマッピング更新
- [ ] `src/app.py`のagent_info辞書更新  
- [ ] `src/claude_service.py`の_select_system_prompt_by_agent対応
- [ ] 対応データファイルの存在確認
- [ ] 動作テスト実施

## 環境変数・設定

### GitHub Secrets設定済み変数名（絶対に変更しない）
- `CLAUDE_API_KEY` ← **これがメインのAPI KEY（ANTHROPIC_API_KEYではない！）**
- `FIREBASE_CLIENT_EMAIL`
- `FIREBASE_CLIENT_ID` 
- `FIREBASE_PRIVATE_KEY`
- `FIREBASE_PRIVATE_KEY_ID`
- `FIREBASE_PROJECT_ID`
- `GCP_PROJECT_ID`
- `GCP_SA_KEY`
- `SECRET_KEY`
- `STRIPE_SECRET_KEY`
- `STRIPE_WEBHOOK_SECRET`

### アプリケーション設定
- CLAUDE_API_KEY: Claude APIキー（**これを使用、ANTHROPIC_API_KEYは使わない**）
- SECRET_KEY: Flask セッション用
- Firebase認証設定済み
- Stripe決済設定済み

### 重要な注意事項
**新しい環境変数を追加する際は、上記のGitHub Secrets変数名と完全に一致させること。**
**新しい変数名を勝手に作成せず、既存の変数名を必ず使用すること。**
**特にCLAUDE_API_KEYは絶対に変更しない（ANTHROPIC_API_KEYと混同しない）**

### 2025-09-01 メッセージ重複問題解決セッション（複数回試行・教訓多数） 🔧
**問題**: 
- 会話履歴復元時にユーザーメッセージが重複表示される
- 特に「見積もりはどうなりますか？」等の質問が2つ表示される問題

**試行錯誤の経緯**:
1. **第1回修正試行**（innerHTML → addIntegratedMessageToChat変更）
   - 会話復元処理を`innerHTML`直接操作から`addIntegratedMessageToChat`関数経由に変更
   - Set()による重複検出ロジック実装
   - **致命的ミス**: 引数順序を間違えて`addIntegratedMessageToChat(msg.content, 'user')`と実装
   - **症状**: 画面に「user」「assistant」の文字のみ表示、実際の回答はコンソールに出力

2. **第2回修正試行**（引数順序統一試行）
   - 全ての`addIntegratedMessageToChat`呼び出しの引数順序を統一しようとした
   - **結果**: JavaScriptエラーが大量発生、システム全体が機能停止
   - **症状**: コンソールエラー、チャット機能完全停止

3. **git reset による復旧**
   - `git reset --hard 4f3eb61`で問題のあるコミット前に戻す
   - **重要な発見**: 戻した地点でも引数順序問題が既に存在していた
   - **ユーザーの質問**: 「これはなぜgitで元に戻したのに治らなかったのですか」

4. **詳細検証フェーズ**
   - ユーザーからの指摘: 「問題について修正の前にたくさん検証しましょう」
   - 関数定義と呼び出し箇所の徹底調査
   - 引数順序の不整合を完全に特定

5. **最終的な正しい修正**
   - 会話履歴復元部分のみの引数順序を修正
   - `addIntegratedMessageToChat('user', msg.content)` に変更
   - **結果**: 正常に動作、重複も解決

**根本原因**:
- `addIntegratedMessageToChat(sender, message)`の関数定義に対し
- 会話履歴復元時のみ`addIntegratedMessageToChat(message, sender)`と引数順序が逆
- これによりDOM構造が破綻し、重複検出ロジックも機能しない状態

**重要な教訓**:
1. **git reset の限界**: 戻した地点に既に問題があれば解決しない
2. **段階的動作確認の重要性**: 大きな変更時は各段階で十分な動作確認が必要
3. **引数順序の一貫性**: 関数呼び出し箇所での引数順序統一の重要性
4. **表面的動作 vs 正常動作**: 「動いているように見える」≠「正常動作」
5. **修正前の検証**: 問題の根本原因を完全に理解してから修正すべき

**技術的詳細**:
- 不正な引数順序により、メッセージ内容がCSSクラス名として使用される
- 例: `.message.電子申請の仕方が分からないです .message-content` ← 無効なセレクタ
- 重複検出の`querySelectorAll`が機能せず、DOM構造も破綻

**ユーザーからの貴重な指摘**:
- 「もう疲れた」（複数回の失敗修正に対する率直な感想）
- 「問題について修正の前にたくさん検証しましょう」
- 検証の重要性を教えてくれた

**最終解決**: templates/dashboard.html:2310, 2313行目の引数順序修正のみ（最小限変更）

### 2025-09-01 システム機能改善・最適化セッション（継続） ✅

#### 1. 専門エージェント使用時のカウント減少機能追加 
**問題**: 追加パック購入後、専門エージェントを使用してもカウントが減らない

**原因**: 
- `/api/chat`エンドポイント（汎用）には使用回数増加処理があった
- `/api/agent/chat`エンドポイント（専門エージェント）には使用回数増加処理がなかった

**解決策**:
- 専門エージェントエンドポイントに`get_subscription_service().use_question()`を追加
- `updated_usage`をレスポンスに含めてフロントエンド更新に対応
- フロントエンド側は既に`loadUserData()`で更新処理済み

**結果**: 専門エージェント使用時も追加パックのカウントが正常に減るように修正

#### 2. 会話履歴にエージェント名表示を追加
**要求**: 左側の会話履歴の日付時間横にエージェント名を記載

**実装内容**:
- 統合会話履歴表示にエージェント名マッピングを追加
- 8つの専門エージェント全てに短縮名でマッピング:
  - `gyoumukaizen` → 業務改善助成金
  - `career-up_seishain` → キャリアアップ(正社員化)
  - `career-up_chingin` → キャリアアップ(賃金規定)
  - など
- `conversation-meta`レイアウトで統一表示

**結果**: どのエージェントとの会話かが一目で分かるよう改善

#### 3. トークンコスト最適化
**要求**: 左側履歴は30個まま、内部でのやりとりは10回までに変更

**実装内容**:
- 専門エージェント内部でのやりとり履歴を30回から10回に削減
- 左側の会話履歴表示は30個のまま維持（表示のみなのでトークンに影響なし）

**効果**:
- トークン使用量が約1/3に減少
- コスト削減効果：10回目の質問で約2,800トークン（約0.8円）
- 会話1回あたり約0.2円の増加で済む（1円以内）

#### 4. Claude APIエラー時のユーザーフレンドリーメッセージ
**要求**: Claude側の問題で会話がうまくいかない時の適切なエラーメッセージ

**実装内容**:
Claude APIのエラータイプに応じて分岐したメッセージを実装：
- **レート制限**: 「Claude側のサーバーが込み合っています。少し時間をおいて再度質問してください。」
- **タイムアウト**: 「応答に時間がかかりすぎています。少し時間をおいて再度質問してください。」
- **サーバー過負荷**: 「Claude側のサーバーが混雑しています。しばらく時間をおいて再度お試しください。」
- **認証エラー**: 「システムの認証に問題が発生しています。管理者にお問い合わせください。」
- **その他**: 「Claude側で一時的な問題が発生している可能性があります。少し時間をおいて再度お試しください。」

**適用箇所**: 3つのAPI呼び出し箇所全てに統一的なエラーハンドリングを適用

#### 5. エラー時のカウント消費防止機能
**問題**: エラーメッセージが返されてもカウントが減ってしまう

**解決策**:
- エラーメッセージ判定機能を追加（「申し訳ございません」+ 特定の文言で判定）
- エラーでない場合のみ`use_question()`を実行
- エラー時はカウントを消費しない公正な課金システムを実現

**技術ポイント**:
```javascript
is_error_response = (
    "申し訳ございません" in response and 
    ("サーバーが込み合っています" in response or 
     "時間がかかりすぎています" in response or 
     "サーバーが混雑しています" in response or 
     "認証に問題が発生しています" in response or 
     "一時的な問題が発生している" in response)
)
```

**全体的な成果**:
- ユーザビリティの大幅向上（エージェント名表示、適切なエラーメッセージ）
- コスト最適化（トークン使用量削減）
- 公正な課金システム（エラー時カウント保護）
- システムの安定性向上

### 2025-09-01 専門エージェントmockモード問題解決・fileフォルダ配置修正セッション ✅
**問題**: 
1. **専門エージェント（キャリアアップ助成金等）が汎用回答を返す**
2. **Cloud Runで無限再起動ループが発生**
3. **要綱ファイルが読み込めない**

**原因特定**:
1. **環境変数の不一致**
   - Cloud Runで`ANTHROPIC_API_KEY`が設定されていたが、アプリケーションは`CLAUDE_API_KEY`を期待

2. **general_promptでキャリアアップ助成金を拒否**
   - 32-52行目でキャリアアップ助成金を「対応できない内容」として明記
   - 専門エージェントが正しく動作しない原因

3. **Cloud Runでfileフォルダが存在しない**
   - Dockerfileで`file/`フォルダがコピーされていない
   - `/app/file/キャリアアップ助成金/`パスでファイルが見つからない

**実施した修正**:
1. **環境変数修正**（コミット: 47885a4）
   - Cloud RunからANTHROPIC_API_KEY削除
   - CLAUDE_API_KEY設定

2. **general_prompt完全削除**（コミット: 7d57c7d）
   - キャリアアップ助成金拒否ロジックを削除
   - 各専門エージェントが要綱ファイルのみから回答する仕組みを復旧
   - Claudeの古い学習データ使用禁止制約を強化

3. **fileフォルダ配置修正**（コミット: 64c5023）
   - DockerfileにCOPY file/ ./file/追加
   - Cloud Runで要綱ファイルが正しく読み込まれる環境を構築

**動作確認完了**:
- キャリアアップ助成金専門エージェントが正常動作
- 要綱ファイルから正確な専門回答を提供
- Claude 3 Haikuでコスト効率的な運用

**技術的詳細**:
- ファイルサイズ: キャリアアップ助成金（共通+正社員化）約162KB ≈ 40,000-50,000トークン
- Haikuコスト: 約2.1円/回（Sonnetの1/12〜1/15）
- 論理演算子（「かつ」「または」）の解説も保持

**今後の拡張方針**:
- 新エージェント追加は`file/新助成金/`フォルダ作成のみで簡単
- Dockerfileが自動的にファイルをコピー
- 拡張性の高いシンプルな構造

## 料金プランとコスト分析（2025-09-01更新） 💰

### 現在の料金体系
- **Light プラン**: ¥1,480（20回）
- **Regular プラン**: ¥3,300（50回）  
- **Heavy プラン**: ¥5,500（90回）

### Claude 3.5 Sonnet使用時のコスト
**APIコスト（Claude 3.5 Sonnet 20241022）:**
- Input: $3/1M tokens
- Output: $15/1M tokens
- 実際のコスト: 約18-26円/回（要綱サイズによる）

**プラン別収益性:**
| プラン | 料金 | 回数 | 1回単価 | APIコスト | 利益率 |
|--------|------|------|---------|-----------|--------|
| Light | ¥1,480 | 20回 | ¥74 | ¥18-26 | 65-75% |
| Regular | ¥3,300 | 50回 | ¥66 | ¥18-26 | 60-72% |
| Heavy | ¥5,500 | 90回 | ¥61 | ¥18-26 | 57-70% |

### モデル比較
- **Claude 3 Haiku**: 約2.1円/回（高速・低精度）
- **Claude 3.5 Sonnet**: 約18-26円/回（高精度・日付理解良好）

**2025-09-01決定**: Sonnet 3.5を採用（精度重視）

## プロジェクト構造メモ
- `/templates/index.html`: トップページ（無料診断メイン）
- `/templates/dashboard.html`: ログイン後ダッシュボード
- `/templates/subsidy_memo.html`: メモ管理機能
- `/src/app.py`: メインアプリケーション
- `/src/claude_service.py`: Claude API統合