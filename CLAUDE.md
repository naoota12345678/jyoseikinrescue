# Claude開発メモ

## 重要な注意事項 ⚠️

### 絶対にやってはいけないこと
1. **勝手にファイルを全面的に書き換えない**
   - ユーザーが明確に依頼していない限り、既存のファイルの構造を大幅に変更しない
   - 特に動作している機能を「改善」しようとして壊さない

2. **要求されていない機能追加・変更をしない**
   - ユーザーの具体的な指示のみに従う
   - 「より良くしよう」という判断で勝手な変更をしない

3. **動作しているシステムを触らない**
   - 「問題ない部分」は絶対に変更しない
   - 小さな修正でも影響範囲を慎重に考える

### 正しいアプローチ
1. **最小限の変更のみ**
   - 要求された部分のみを正確に修正
   - 他の部分には一切触らない

2. **変更前に確認**
   - 既存のコードがなぜそうなっているかを理解してから修正
   - 動作している理由を壊さない

3. **段階的な修正**
   - 一度に多くを変更せず、一つずつ確認しながら進める

## 申請書類ダウンロード機能について ⚠️

### 実装方法
**現在の方式**: `templates/subsidy_memo.html`の1504-1526行目に助成金リンクを**直接HTML記述**

### 表示される助成金（2つのみ）
1. **業務改善助成金** - 厚労省公式ページリンク
2. **キャリアアップ助成金** - 厚労省公式ページリンク

### 新しい助成金の追加方法
`templates/subsidy_memo.html`の1526行目の`</div>`直前に以下を追加：

```html
<!-- 新しい助成金 -->
<div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem;">
    <h3 style="color: #667eea; margin-bottom: 1rem;">🏢 助成金名</h3>
    <p style="color: #6b7280; margin-bottom: 1.5rem; font-size: 0.9rem;">助成金の説明</p>
    
    <a href="https://リンクURL" target="_blank" style="display: block; padding: 1rem; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; text-decoration: none; color: #0c4a6e; text-align: center; font-weight: 600;">
        📋 申請書類・制度詳細<br>
        <span style="font-size: 0.8rem; font-weight: normal;">（厚生労働省公式サイト）</span>
    </a>
</div>
```

### 重要な注意事項
- **APIやJSONファイルは使用しない**（過去に複雑化して失敗）
- **シンプルな静的HTML記述のみ**
- **各助成金につき1つのリンクのみ**（個別申請書類は表示しない）
- **厚労省公式ページへの直接リンク**

## セッション完了履歴

### 2025-08-30 助成金申請フォーム管理システム構築セッション ✅
**要求内容**: 
- AIが間違ったURLを返す問題の修正（特にキャリアアップ助成金）
- ランディングページのロゴ表示修正・デザイン改善
- 全29カテゴリの助成金申請書類を動的管理するシステム構築
- メモ機能から全申請書類へアクセス可能にする

**実装完了内容**:
1. **AIのURL生成防止システム**
   - `claude_service.py`のシステムプロンプトに厳格なURL生成禁止ルール追加
   - 「申請様式については以下でご案内します」のみ回答するよう制限
   - 複雑な自動検出システムは排除し、シンプルなアプローチに変更

2. **動的申請フォーム管理システム**
   - `/api/forms`エンドポイント作成（FormsManagerから全助成金データ取得）
   - `subsidy_memo.html`に動的フォーム表示機能実装
   - `subsidy_forms.json`から全助成金カテゴリを自動読み込み・表示
   - エラーハンドリング・スタイリング完備

3. **ランディングページUI改善**
   - ロゴ表示問題修正（透過PNGロゴを`/static/logo.png`に配置）
   - 絵文字削除、料金プラン統一化
   - 3カラムレイアウト・モダンデザイン適用

4. **申請書類URL更新**
   - `subsidy_forms.json`の業務改善助成金を令和7年度版に更新
   - 正式な厚労省URL（docx形式）に統一

**技術ポイント**:
- 既存のFormsManagerインフラを活用した拡張性の高いシステム
- ユーザーによる`subsidy_forms.json`更新で自動反映される仕組み
- 複雑な検知システムではなくシンプルな禁止ベースアプローチ
- フロントエンド JavaScript による動的HTML生成

**ユーザー確認済み**:
- 「いやそこまでしたもきっとうまくいかないよね　変なURLを返さないようにするだけでいいかな」
- 「都度アップするのでそれがいいですね」
- システムは`subsidy_forms.json`更新待ちの状態で完成

### 2025-08-30 ランディングページ完成セッション ✅
**要求内容**: 
- ランディングページとして無料診断が主役のデザインに変更
- 一番下に3つのプランを表示
- 無料診断ボタンが一番目立つように
- ログインや会員登録のクリックした後のUIはそのまま

**実装完了内容**:
1. `auth_index.html`を完全なランディングページに変更
   - 大きな無料診断CTAボタン追加（アニメーション付き）
   - 3段階料金プラン表示（Light ¥1,480、Regular ¥3,300、Heavy ¥5,500）
   - モダンなグラスモーフィズムデザイン・グラデーション背景
   - ログインフォームは隠し、セカンダリボタンで表示
   - 複数箇所に無料診断ボタン配置

2. `dashboard.html`で完了していたエージェント名表示修正
   - `saveAgentConversation`関数にエージェント名マッピング追加
   - "undefined専門エージェント" 問題解決

3. Git管理・デプロイ完了
   - 全変更をコミット・プッシュ
   - ライブ環境に反映済み

**技術ポイント**:
- AUTH_ENABLED=Falseの場合は`auth_index.html`がメインページとして表示
- 既存のログイン機能を保持しつつランディングページ化
- レスポンシブデザイン対応

## 過去の失敗例
- 2025-08-30: index.htmlを無料診断ページからモダンなランディングページに勝手に変更
  - 結果：自動ログイン機能、チャット機能、その他多数の機能が破損
  - 原因：「今すぐ無料診断をスタート」ボタンとロゴ変更だけが要求だったのに全面書き換え

- 2025-08-31: AIエージェントシステムを勝手に変更
  - 結果：専門エージェントが「エラーが発生しました」となり機能停止
  - 原因：診断システムのハードコード削除要求だったのに、専門エージェントのファイル構造まで勝手に変更
  - 詳細：claude_service.pyの個別ファイル読み込みシステムを破壊し、診断用データファイルに統一しようとした
  - 反省：要求されていない部分（専門エージェント）に手を出し、動作中のシステムを破壊
  - ユーザーからの指摘：「なんで専門エージェントいじらなくてもいいのにいじった？」「勝手にやるなっていうさ指示を守らないでまた勝手にやろうとしてる所」

- 2025-08-31: 統合ワークスペース実装時の計画不備
  - 結果：ダッシュボードと統合ワークスペースのコードが競合、401認証エラー発生
  - 原因：既存ダッシュボードの上に統合ワークスペースを重ねただけ、認証システムへの影響を未考慮
  - 詳細：元のdashboard.htmlが残ったまま新しいUI要素を追加、APIエンドポイントの認証処理が競合
  - 反省：大規模な統合作業は事前設計・段階的移行が必須
  - ユーザーからの指摘：「統合の前の組み立ての話し合いがお粗末でしたね」

### 2025-08-31 統合ワークスペース401エラー解決・エージェントID管理整備セッション ✅
**要求内容**: 
- 統合ワークスペースで専門エージェントが401/400エラーで動作しない問題の解決
- 認証システムとエージェントID管理の整備

**実装完了内容**:
1. **401認証エラーの根本原因特定・解決**
   - Firebase認証トークンがAPIコールで送信されていないことが原因と判明
   - 統合ワークスペースの5つのAPIコールすべてにAuthorizationヘッダーを追加
   - 認証システム自体は正常動作していることを確認

2. **400エラー「無効なエージェントID」の解決**
   - サーバー側の`agent_info`定義が古く、フロントエンドのコース別IDに未対応
   - 8つのキャリアアップコース別IDを含む完全な定義に更新

3. **統合ワークスペースの古いUI競合問題解決**
   - `switchToOriginalMode()`を無効化して旧ダッシュボードへの切り替えを防止
   - 統合ワークスペースのみ使用する構成に変更

**技術ポイント**:
- デバッグエンドポイント活用による段階的問題特定
- Firebase認証フロー確認とトークン送信修正
- フロントエンド・バックエンド間のID整合性確保

**ユーザー確認済み**:
- 専門エージェントが正常動作することを確認
- Claude 3 Haikuモデルでコスト削減効果確認

## エージェントID管理方針 🏷️

### 現在のエージェントID構造
**業務改善助成金:**
- `gyoumukaizen` - 業務改善助成金専門エージェント

**キャリアアップ助成金コース別:**
- `career-up_seishain` - 正社員化コース
- `career-up_chingin` - 賃金規定等改定コース
- `career-up_shogaisha` - 障害者正社員化コース
- `career-up_kyotsu` - 賃金規定等共通化コース
- `career-up_shoyo` - 賞与・退職金制度導入コース
- `career-up_shahoken` - 社会保険適用時処遇改善コース
- `career-up_tanshuku` - 短時間労働者労働時間延長支援コース

### 今後のエージェント追加ルール
1. **ID命名規則**: `助成金種別_コース名` の形式を維持
2. **両側同期**: フロントエンド（dashboard.html）とバックエンド（app.py）のagent_info両方を更新
3. **ファイル構造**: claude_service.pyの個別ファイル読み込み方式を維持
4. **テスト必須**: 新エージェント追加時は必ず動作確認を実施

### エージェント追加時のチェックリスト
- [ ] `templates/dashboard.html`のagentNamesマッピング更新
- [ ] `src/app.py`のagent_info辞書更新  
- [ ] `src/claude_service.py`の_select_system_prompt_by_agent対応
- [ ] 対応データファイルの存在確認
- [ ] 動作テスト実施

## 環境変数・設定

### GitHub Secrets設定済み変数名（絶対に変更しない）
- `CLAUDE_API_KEY`
- `FIREBASE_CLIENT_EMAIL`
- `FIREBASE_CLIENT_ID` 
- `FIREBASE_PRIVATE_KEY`
- `FIREBASE_PRIVATE_KEY_ID`
- `FIREBASE_PROJECT_ID`
- `GCP_PROJECT_ID`
- `GCP_SA_KEY`
- `SECRET_KEY`
- `STRIPE_SECRET_KEY`
- `STRIPE_WEBHOOK_SECRET`

### アプリケーション設定
- ANTHROPIC_API_KEY: Claude APIキー（モックモード対応）
- SECRET_KEY: Flask セッション用
- Firebase認証設定済み
- Stripe決済設定済み

### 重要な注意事項
**新しい環境変数を追加する際は、上記のGitHub Secrets変数名と完全に一致させること。**
**新しい変数名を勝手に作成せず、既存の変数名を必ず使用すること。**

## プロジェクト構造メモ
- `/templates/index.html`: トップページ（無料診断メイン）
- `/templates/dashboard.html`: ログイン後ダッシュボード
- `/templates/subsidy_memo.html`: メモ管理機能
- `/src/app.py`: メインアプリケーション
- `/src/claude_service.py`: Claude API統合