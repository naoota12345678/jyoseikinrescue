<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ©æˆé‡‘è¨ºæ–­ - åŠ©æˆé‡‘è¨ºæ–­AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #e6f4ff 0%, #f0e6ff 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 1rem;
            padding: 1.5rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        .logo {
            width: 150px;
            height: 150px;
            margin-bottom: 1rem;
        }
        
        .header h1 {
            color: #333;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            color: #666;
            font-size: 0.9rem;
        }
        
        #diagnosisForm {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }
        
        .question {
            margin-bottom: 2rem;
        }
        
        .question h3 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .options {
            display: grid;
            gap: 0.8rem;
        }
        
        .option {
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
        }
        
        .option:hover {
            border-color: #667eea;
            background: #f7f9ff;
        }
        
        .option.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .option input {
            margin-right: 0.8rem;
        }
        
        .submit-btn {
            width: 100%;
            padding: 1.2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
        }
        
        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #results {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        .result-item {
            background: #f8f9ff;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
        }
        
        .result-item h4 {
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .amount {
            color: #28a745;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="/static/logo.png" alt="ãƒ­ã‚´" class="logo">
            <h1>ğŸ¯ ç„¡æ–™åŠ©æˆé‡‘è¨ºæ–­ï¼ˆç´„1åˆ†ï¼‰</h1>
            <p>è³ªå•ã«ç­”ãˆã‚‹ã ã‘ã§ã€ã‚ãªãŸã®ä¼šç¤¾ãŒå—çµ¦ã§ãã‚‹åŠ©æˆé‡‘ãŒã‚ã‹ã‚Šã¾ã™</p>
        </div>
        
        <form id="diagnosisForm">
            <div class="question">
                <h3>1. ä¼šç¤¾ã®æ¥­ç¨®</h3>
                <div class="options">
                    <div class="option" onclick="selectOption(this, 'industry', 'manufacturing')">
                        <input type="radio" name="industry" value="manufacturing"> è£½é€ æ¥­
                    </div>
                    <div class="option" onclick="selectOption(this, 'industry', 'service')">
                        <input type="radio" name="industry" value="service"> ã‚µãƒ¼ãƒ“ã‚¹æ¥­
                    </div>
                    <div class="option" onclick="selectOption(this, 'industry', 'retail')">
                        <input type="radio" name="industry" value="retail"> å°å£²æ¥­ãƒ»é£²é£Ÿæ¥­
                    </div>
                    <div class="option" onclick="selectOption(this, 'industry', 'construction')">
                        <input type="radio" name="industry" value="construction"> å»ºè¨­æ¥­
                    </div>
                    <div class="option" onclick="selectOption(this, 'industry', 'it')">
                        <input type="radio" name="industry" value="it"> ITãƒ»æƒ…å ±é€šä¿¡æ¥­
                    </div>
                    <div class="option" onclick="selectOption(this, 'industry', 'other')">
                        <input type="radio" name="industry" value="other"> ãã®ä»–
                    </div>
                </div>
            </div>
            
            <div class="question">
                <h3>2. å¾“æ¥­å“¡æ•°</h3>
                <div class="options">
                    <div class="option" onclick="selectOption(this, 'employees', '1-5')">
                        <input type="radio" name="employees" value="1-5"> 1ï½5äºº
                    </div>
                    <div class="option" onclick="selectOption(this, 'employees', '6-20')">
                        <input type="radio" name="employees" value="6-20"> 6ï½20äºº
                    </div>
                    <div class="option" onclick="selectOption(this, 'employees', '21-50')">
                        <input type="radio" name="employees" value="21-50"> 21ï½50äºº
                    </div>
                    <div class="option" onclick="selectOption(this, 'employees', '51-100')">
                        <input type="radio" name="employees" value="51-100"> 51ï½100äºº
                    </div>
                    <div class="option" onclick="selectOption(this, 'employees', '101+')">
                        <input type="radio" name="employees" value="101+"> 101äººä»¥ä¸Š
                    </div>
                </div>
            </div>
            
            <div class="question">
                <h3>3. ç¾åœ¨ã®èª²é¡Œï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</h3>
                <div class="options">
                    <div class="option" onclick="selectMultiple(this, 'goals')">
                        <input type="checkbox" name="goals" value="wage"> è³ƒé‡‘ã‚’ä¸Šã’ãŸã„
                    </div>
                    <div class="option" onclick="selectMultiple(this, 'goals')">
                        <input type="checkbox" name="goals" value="employment"> æ­£ç¤¾å“¡ã‚’å¢—ã‚„ã—ãŸã„
                    </div>
                    <div class="option" onclick="selectMultiple(this, 'goals')">
                        <input type="checkbox" name="goals" value="equipment"> è¨­å‚™æŠ•è³‡ã—ãŸã„
                    </div>
                    <div class="option" onclick="selectMultiple(this, 'goals')">
                        <input type="checkbox" name="goals" value="productivity"> ç”Ÿç”£æ€§ã‚’å‘ä¸Šã•ã›ãŸã„
                    </div>
                    <div class="option" onclick="selectMultiple(this, 'goals')">
                        <input type="checkbox" name="goals" value="training"> äººæè‚²æˆã‚’ã—ãŸã„
                    </div>
                </div>
            </div>
            
            <button type="button" onclick="submitDiagnosis()" class="submit-btn">
                è¨ºæ–­çµæœã‚’è¦‹ã‚‹
            </button>
        </form>
        
        <div id="results"></div>
    </div>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyD5O19Sj91HuMBPuLwqrJOaGMzW2OGVzxE",
            authDomain: "jyoseikinrescue.firebaseapp.com",
            projectId: "jyoseikinrescue",
            storageBucket: "jyoseikinrescue.appspot.com",
            messagingSenderId: "453016168690",
            appId: "1:453016168690:web:09bf99bb92a0e4f8af0d5e"
        };
        
        // FirebaseåˆæœŸåŒ–
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        function selectOption(element, name, value) {
            document.querySelectorAll(`input[name="${name}"]`).forEach(input => {
                input.parentElement.classList.remove('selected');
            });
            element.classList.add('selected');
            element.querySelector('input').checked = true;
        }
        
        function selectMultiple(element, name) {
            element.classList.toggle('selected');
            element.querySelector('input').checked = !element.querySelector('input').checked;
        }
        
        async function submitDiagnosis() {
            const form = document.getElementById('diagnosisForm');
            const submitBtn = form.querySelector('.submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'è¨ºæ–­ä¸­...';
            
            const industry = document.querySelector('input[name="industry"]:checked')?.value || '';
            const employees = document.querySelector('input[name="employees"]:checked')?.value || '';
            const goals = Array.from(document.querySelectorAll('input[name="goals"]:checked')).map(cb => cb.value);
            
            const data = {
                industry: industry,
                employees: employees,
                goals: goals
            };
            
            // è¨ºæ–­çµæœã‚’sessionStorageã«ä¿å­˜
            sessionStorage.setItem('diagnosisData', JSON.stringify(data));
            
            try {
                const response = await fetch('/api/diagnosis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                displayResults(result);
            } catch (error) {
                console.error('è¨ºæ–­ã‚¨ãƒ©ãƒ¼:', error);
                alert('è¨ºæ–­ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'è¨ºæ–­çµæœã‚’è¦‹ã‚‹';
            }
        }
        
        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            const results = data.results || [];
            
            // è¨ºæ–­çµæœå…¨ä½“ã‚’sessionStorageã«ä¿å­˜ï¼ˆå…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¨çµæœä¸¡æ–¹ï¼‰
            const diagnosisData = JSON.parse(sessionStorage.getItem('diagnosisData') || '{}');
            const fullDiagnosisData = {
                ...diagnosisData,
                results: results,
                diagnosedAt: new Date().toISOString()
            };
            sessionStorage.setItem('fullDiagnosisData', JSON.stringify(fullDiagnosisData));
            
            resultsDiv.innerHTML = `
                <h2 style="color: #333; text-align: center;">âœ¨ ã‚ãªãŸã®ä¼šç¤¾ãŒå—çµ¦ã§ãã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹åŠ©æˆé‡‘</h2>
                ${results.map(result => `
                    <div class="result-item">
                        <h4>${result.name}</h4>
                        <div style="white-space: pre-line;">${result.description}</div>
                        <p class="amount"><strong>ã€æ”¯çµ¦é¡ã®ç›®å®‰ã€‘</strong> ${result.amount}</p>
                        <p><strong>ã€ãƒã‚¤ãƒ³ãƒˆã€‘</strong> ${result.eligibility}</p>
                    </div>
                `).join('')}
                
                <!-- ä¼šå“¡ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆè¨ºæ–­çµæœè¡¨ç¤ºã¨åŒæ™‚ã«è‡ªå‹•è¡¨ç¤ºï¼‰ -->
                <div style="margin-top: 2rem; padding: 2rem; background: #f8f9ff; border-radius: 12px; border: 2px solid #667eea;">
                    <h3 style="color: #333; text-align: center; margin-bottom: 1.5rem;">ğŸš€ ç„¡æ–™ä¼šå“¡ç™»éŒ²</h3>
                    <p style="text-align: center; color: #666; margin-bottom: 2rem;">è¨ºæ–­çµæœã‚’ä¿å­˜ã—ã¦5å›ç„¡æ–™ã§å°‚é–€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒä½¿ãˆã¾ã™</p>
                    
                    <form id="registrationForm" style="max-width: 400px; margin: 0 auto;">
                        <div style="margin-bottom: 1rem;">
                            <input type="email" id="regEmail" required placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" 
                                   style="width: 100%; padding: 0.8rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <input type="password" id="regPassword" required placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰" 
                                   style="width: 100%; padding: 0.8rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                        </div>
                        <div style="margin-bottom: 1.5rem;">
                            <input type="password" id="regPasswordConfirm" required placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰" 
                                   style="width: 100%; padding: 0.8rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                        </div>
                        
                        <button type="submit" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; font-size: 1.1rem; margin-bottom: 1rem;">
                            âœ¨ ç™»éŒ²ã—ã¦å°‚é–€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ã†
                        </button>
                        
                        <p style="text-align: center; font-size: 0.8rem; color: #666;">
                            ã™ã§ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã®å ´åˆã¯<br>
                            <a href="#" onclick="showLoginForm()" style="color: #667eea; text-decoration: underline;">ã“ã¡ã‚‰ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³</a>
                        </p>
                    </form>
                </div>
                
                <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div id="loginForm" style="display: none; margin-top: 2rem; padding: 2rem; background: #fff3cd; border-radius: 12px; border: 2px solid #ffc107;">
                    <h3 style="color: #333; text-align: center; margin-bottom: 1.5rem;">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</h3>
                    
                    <form id="loginFormElement" style="max-width: 400px; margin: 0 auto;">
                        <div style="margin-bottom: 1rem;">
                            <input type="email" id="loginEmail" required placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" 
                                   style="width: 100%; padding: 0.8rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                        </div>
                        <div style="margin-bottom: 1.5rem;">
                            <input type="password" id="loginPassword" required placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" 
                                   style="width: 100%; padding: 0.8rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                        </div>
                        
                        <button type="submit" style="width: 100%; background: linear-gradient(135deg, #ffc107 0%, #ff8500 100%); color: white; padding: 1rem; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; font-size: 1.1rem; margin-bottom: 1rem;">
                            ğŸšª ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸
                        </button>
                        
                        <p style="text-align: center; font-size: 0.8rem; color: #666;">
                            ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„å ´åˆã¯<br>
                            <a href="#" onclick="showRegistrationForm()" style="color: #ffc107; text-decoration: underline;">ã“ã¡ã‚‰ã‹ã‚‰ç„¡æ–™ç™»éŒ²</a>
                        </p>
                    </form>
                </div>
            `;
            
            resultsDiv.style.display = 'block';
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
            
            // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†ã‚’è¨­å®š
            setupFormHandlers();
        }
        
        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.querySelector('#results > div:first-of-type').style.display = 'none';
        }
        
        function showRegistrationForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.querySelector('#results > div:first-of-type').style.display = 'block';
        }
        
        function setupFormHandlers() {
            // ä¼šå“¡ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã®å‡¦ç†
            const regForm = document.getElementById('registrationForm');
            if (regForm) {
                regForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const email = document.getElementById('regEmail').value;
                    const password = document.getElementById('regPassword').value;
                    const passwordConfirm = document.getElementById('regPasswordConfirm').value;
                    
                    if (password !== passwordConfirm) {
                        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');
                        return;
                    }
                    
                    if (password.length < 6) {
                        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                        return;
                    }
                    
                    try {
                        // Firebase Authenticationã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        const user = userCredential.user;
                        
                        // Firestoreã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜
                        await db.collection('users').doc(user.uid).set({
                            email: email,
                            created_at: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ä½œæˆï¼ˆ5å›ç„¡æ–™ï¼‰
                        await db.collection('subscriptions').doc(user.uid).set({
                            user_id: user.uid,
                            status: 'trial',
                            trial_usage: 0,
                            total_trial_limit: 5,
                            created_at: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // è¨ºæ–­çµæœï¼ˆå…¥åŠ›ãƒ‡ãƒ¼ã‚¿ï¼‹AIã®çµæœï¼‰ã‚’ä¿å­˜
                        const fullDiagnosisData = JSON.parse(sessionStorage.getItem('fullDiagnosisData') || '{}');
                        if (fullDiagnosisData.industry && fullDiagnosisData.results) {
                            await db.collection('diagnosis_results').doc(user.uid).set({
                                ...fullDiagnosisData,
                                user_id: user.uid,
                                created_at: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            // ãƒ¡ãƒ¢ã«ã‚‚è‡ªå‹•ä¿å­˜
                            if (fullDiagnosisData.results.length > 0) {
                                const memoContent = fullDiagnosisData.results.map(r => 
                                    `ã€${r.name}ã€‘\n${r.description}\næ”¯çµ¦é¡: ${r.amount}\n`
                                ).join('\n---\n');
                                
                                await db.collection('memos').add({
                                    user_id: user.uid,
                                    content: memoContent,
                                    title: 'è¨ºæ–­çµæœ: ' + new Date().toLocaleDateString('ja-JP'),
                                    created_at: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            }
                        }

                        // ç™»éŒ²å®Œäº†ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡
                        try {
                            await userCredential.user.sendEmailVerification();
                            console.log('ç™»éŒ²å®Œäº†ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
                        } catch (emailError) {
                            console.error('ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼:', emailError);
                            // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã¯é·ç§»ã™ã‚‹
                        }

                        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                        window.location.href = '/dashboard';
                    } catch (error) {
                        console.error('ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
                        if (error.code === 'auth/email-already-in-use') {
                            alert('ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
                        } else {
                            alert('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                        }
                    }
                });
            }
            
            // ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã®å‡¦ç†
            const loginForm = document.getElementById('loginFormElement');
            if (loginForm) {
                loginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const email = document.getElementById('loginEmail').value;
                    const password = document.getElementById('loginPassword').value;
                    
                    try {
                        await auth.signInWithEmailAndPassword(email, password);
                        
                        // è¨ºæ–­çµæœï¼ˆå…¥åŠ›ãƒ‡ãƒ¼ã‚¿ï¼‹AIã®çµæœï¼‰ã‚’ä¿å­˜
                        const user = auth.currentUser;
                        const fullDiagnosisData = JSON.parse(sessionStorage.getItem('fullDiagnosisData') || '{}');
                        if (user && fullDiagnosisData.industry && fullDiagnosisData.results) {
                            await db.collection('diagnosis_results').doc(user.uid).set({
                                ...fullDiagnosisData,
                                user_id: user.uid,
                                created_at: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            // ãƒ¡ãƒ¢ã«ã‚‚è‡ªå‹•ä¿å­˜
                            if (fullDiagnosisData.results.length > 0) {
                                const memoContent = fullDiagnosisData.results.map(r => 
                                    `ã€${r.name}ã€‘\n${r.description}\næ”¯çµ¦é¡: ${r.amount}\n`
                                ).join('\n---\n');
                                
                                await db.collection('memos').add({
                                    user_id: user.uid,
                                    content: memoContent,
                                    title: 'è¨ºæ–­çµæœ: ' + new Date().toLocaleDateString('ja-JP'),
                                    created_at: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            }
                        }
                        
                        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                        window.location.href = '/dashboard';
                    } catch (error) {
                        console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                        alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                    }
                });
            }
        }
    </script>
</body>
</html>