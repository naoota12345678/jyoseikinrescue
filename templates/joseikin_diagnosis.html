<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>助成金診断システム - 詳細版</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f4eddc;
            min-height: 100vh;
            margin: 0;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .header {
            background: transparent;
            color: #333;
            padding: 2rem 0;
            text-align: center;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .back-button {
            background: #E35614;
            color: white;
            border: 2px solid #E35614;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .back-button:hover {
            background: #D14510;
            border-color: #D14510;
        }
        
        .main-title {
            font-size: 4rem;
            font-weight: 900;
            margin: 2rem 0 1rem 0;
            text-shadow: 2px 4px 8px rgba(0,0,0,0.3);
            letter-spacing: -1px;
        }
        
        .main-subtitle {
            font-size: 1.5rem;
            font-weight: 300;
            opacity: 0.95;
            margin-bottom: 3rem;
        }
        
        .hero-section {
            text-align: center;
            padding: 4rem 0;
            color: #333;
        }
        
        .cta-button {
            display: inline-block;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            color: white;
            padding: 1.2rem 3rem;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            font-size: 1.2rem;
            border: 2px solid rgba(255,255,255,0.3);
            transition: all 0.3s ease;
            margin-bottom: 2rem;
        }
        
        .cta-button:hover {
            background: rgba(255,255,255,0.25);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .logo {
            display: flex;
            align-items: center;
        }
        
        .logo-icon {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-weight: 600;
            position: relative;
        }
        
        .logo-image {
            height: 12rem;
        }
        
        .logo-text {
            font-size: 1.3rem;
            font-weight: bold;
            letter-spacing: 0.05em;
        }
        
        .logo-tagline {
            font-size: 0.7rem;
            font-weight: normal;
            opacity: 0.9;
            margin-left: 1rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .content-wrapper {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 3rem;
            margin: 2rem auto 4rem auto;
            max-width: 900px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
        }
        
        .page-title {
            text-align: center;
            color: #333;
            margin-bottom: 2rem;
            font-size: 1.25rem;
            font-weight: 700;
        }
        
        .page-description {
            text-align: center;
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 3rem;
            line-height: 1.8;
        }
        
        .question {
            margin-bottom: 2rem;
        }
        
        .question h3 {
            margin-bottom: 1rem;
            color: #495057;
        }
        
        .options {
            display: grid;
            gap: 0.5rem;
        }
        
        .option {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .option:hover {
            border-color: #667eea;
            background-color: #f8f9ff;
        }
        
        .option input {
            margin-right: 0.75rem;
        }
        
        .option.selected {
            border-color: #667eea;
            background-color: #f8f9ff;
        }
        
        button {
            background: #E35614;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 2rem;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .results {
            display: none;
        }
        
        .result-item {
            background: #f8f9ff;
            border-left: 4px solid #667eea;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-radius: 8px;
        }
        
        .result-item h4 {
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        
        .amount {
            color: #e74c3c;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        input[type="number"] {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <img src="/static/logo.png" class="logo-image" alt="助成金レスキュー">
            </div>
            <a href="/" class="back-button">← 戻る</a>
        </div>
    </div>
    
    <div class="hero-section">
        <div class="container">
            <p class="main-subtitle">
                9つの質問に答えるだけで、あなたの会社に最適な助成金を瞬時に診断
            </p>
        </div>
    </div>
    
    <div class="container">
        <div class="content-wrapper">
            <h2 class="page-title">助成金適用診断</h2>
            <p class="page-description">
                以下の質問にお答えください。診断は完全無料で、約1分で完了します。<br>
                診断結果には具体的な支給額や申請要件も表示されます。<br>
                すべての項目に回答する必要はありません。分かる範囲でお答えください。
            </p>
            <form id="diagnosisForm">
                <!-- 基本情報 -->
                <div class="question">
                    <h3>1. 会社の基本情報</h3>
                    <label>業種:</label>
                    <div class="options">
                        <div class="option" onclick="selectOption(this, 'industry', 'construction')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="radio" name="industry" value="construction"> 建設業
                            </label>
                        </div>
                        <div class="option" onclick="selectOption(this, 'industry', 'manufacturing')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="radio" name="industry" value="manufacturing"> 製造業
                            </label>
                        </div>
                        <div class="option" onclick="selectOption(this, 'industry', 'service')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="radio" name="industry" value="service"> サービス業
                            </label>
                        </div>
                        <div class="option" onclick="selectOption(this, 'industry', 'it')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="radio" name="industry" value="it"> IT・通信業
                            </label>
                        </div>
                        <div class="option" onclick="selectOption(this, 'industry', 'other')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="radio" name="industry" value="other"> その他
                            </label>
                        </div>
                    </div>
                </div>

                <div class="question">
                    <h3>2. 従業員数</h3>
                    <label>総従業員数:</label>
                    <input type="number" name="totalEmployees" placeholder="例: 25">
                </div>

                <div class="question">
                    <h3>3. 雇用形態別の人数</h3>
                    <label>雇用保険被保険者数:</label>
                    <input type="number" name="insuredEmployees" placeholder="例: 20"><br><br>
                    <label>有期契約労働者数:</label>
                    <input type="number" name="temporaryEmployees" placeholder="例: 5"><br><br>
                    <label>短時間労働者数（週20時間未満）:</label>
                    <input type="number" name="partTimeEmployees" placeholder="例: 3">
                </div>

                <div class="question">
                    <h3>4. 労働者の年齢構成</h3>
                    <div class="options">
                        <div class="option" onclick="selectMultiple(this, 'ageGroups')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="checkbox" name="ageGroups" value="young"> 35歳未満の若年者がいる
                            </label>
                        </div>
                        <div class="option" onclick="selectMultiple(this, 'ageGroups')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="checkbox" name="ageGroups" value="middle"> 50歳以上の中高年者がいる
                            </label>
                        </div>
                        <div class="option" onclick="selectMultiple(this, 'ageGroups')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="checkbox" name="ageGroups" value="senior60"> 60～64歳の高年齢者がいる
                            </label>
                        </div>
                        <div class="option" onclick="selectMultiple(this, 'ageGroups')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="checkbox" name="ageGroups" value="senior65"> 65歳以上の高齢者がいる
                            </label>
                        </div>
                        <div class="option" onclick="selectMultiple(this, 'ageGroups')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="checkbox" name="ageGroups" value="seniorHire"> 65歳以上の継続雇用制度がある・検討中
                            </label>
                        </div>
                    </div>
                </div>

                <div class="question">
                    <h3>5. 特別な配慮が必要な労働者</h3>
                    <div class="options">
                        <div class="option" onclick="selectMultiple(this, 'specialNeeds')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="checkbox" name="specialNeeds" value="disability"> 障害者雇用がある・予定がある
                            </label>
                        </div>
                        <div class="option" onclick="selectMultiple(this, 'specialNeeds')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="checkbox" name="specialNeeds" value="female"> 女性労働者の活躍推進
                            </label>
                        </div>
                        <div class="option" onclick="selectMultiple(this, 'specialNeeds')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="checkbox" name="specialNeeds" value="foreign"> 外国人労働者がいる
                            </label>
                        </div>
                        <div class="option" onclick="selectMultiple(this, 'specialNeeds')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="checkbox" name="specialNeeds" value="singleParent"> 母子・父子家庭の労働者がいる
                            </label>
                        </div>
                    </div>
                </div>

                <div class="question">
                    <h3>6. 現在の経営状況</h3>
                    <div class="options">
                        <div class="option" onclick="selectOption(this, 'businessSituation', 'declining')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="radio" name="businessSituation" value="declining"> 売上減少・事業縮小している
                            </label>
                        </div>
                        <div class="option" onclick="selectOption(this, 'businessSituation', 'stable')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="radio" name="businessSituation" value="stable"> 安定している
                            </label>
                        </div>
                        <div class="option" onclick="selectOption(this, 'businessSituation', 'growing')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="radio" name="businessSituation" value="growing"> 成長・拡大している
                            </label>
                        </div>
                    </div>
                </div>

                <div class="question">
                    <h3>7. 賃金・処遇の状況</h3>
                    <label>事業場内最低賃金（時給）:</label>
                    <input type="number" name="minWage" placeholder="例: 900"><br><br>
                    
                    <div class="options">
                        <div class="option" onclick="selectMultiple(this, 'wageImprovement')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="checkbox" name="wageImprovement" value="raise"> 賃金引上げを検討している
                            </label>
                        </div>
                        <div class="option" onclick="selectMultiple(this, 'wageImprovement')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="checkbox" name="wageImprovement" value="regularization"> 非正規を正社員化したい
                            </label>
                        </div>
                        <div class="option" onclick="selectMultiple(this, 'wageImprovement')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="checkbox" name="wageImprovement" value="bonus"> 賞与・退職金制度を導入したい
                            </label>
                        </div>
                    </div>
                </div>

                <div class="question">
                    <h3>8. 投資・改善の予定</h3>
                    <div class="options">
                        <div class="option" onclick="selectMultiple(this, 'investments')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="checkbox" name="investments" value="equipment"> 設備投資・機器導入
                            </label>
                        </div>
                        <div class="option" onclick="selectMultiple(this, 'investments')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="checkbox" name="investments" value="training"> 職業訓練・研修実施
                            </label>
                        </div>
                        <div class="option" onclick="selectMultiple(this, 'investments')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="checkbox" name="investments" value="it"> IT化・DX推進
                            </label>
                        </div>
                        <div class="option" onclick="selectMultiple(this, 'investments')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="checkbox" name="investments" value="workStyle"> 働き方改革（テレワーク等）
                            </label>
                        </div>
                        <div class="option" onclick="selectMultiple(this, 'investments')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="checkbox" name="investments" value="safety"> 安全衛生対策
                            </label>
                        </div>
                    </div>
                </div>

                <div class="question">
                    <h3>9. 両立支援・職場環境</h3>
                    <div class="options">
                        <div class="option" onclick="selectMultiple(this, 'workLifeBalance')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="checkbox" name="workLifeBalance" value="childcare"> 育児支援制度を充実させたい
                            </label>
                        </div>
                        <div class="option" onclick="selectMultiple(this, 'workLifeBalance')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="checkbox" name="workLifeBalance" value="eldercare"> 介護支援制度を充実させたい
                            </label>
                        </div>
                        <div class="option" onclick="selectMultiple(this, 'workLifeBalance')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="checkbox" name="workLifeBalance" value="health"> 健康経営を推進したい
                            </label>
                        </div>
                        <div class="option" onclick="selectMultiple(this, 'workLifeBalance')">
                            <label style="display: block; width: 100%; cursor: pointer; margin: 0;">
                                <input type="checkbox" name="workLifeBalance" value="smoking"> 受動喫煙防止対策が必要
                            </label>
                        </div>
                    </div>
                </div>

                <button type="button" onclick="diagnose()">📋 助成金診断を実行</button>
            </form>
        </div>

        <div class="content-wrapper results" id="results">
            <h2 style="text-align: center; color: #333; font-size: 2.2rem; font-weight: 700; margin-bottom: 2rem;">🎯 診断結果</h2>
            <div id="resultsList"></div>
        </div>
    </div>

    <script>
        function selectOption(element, name, value) {
            // 同じname属性の他の選択肢を非選択状態に
            document.querySelectorAll(`input[name="${name}"]`).forEach(input => {
                input.closest('.option').classList.remove('selected');
                input.checked = false;
            });
            
            // 選択された項目を選択状態に
            element.classList.add('selected');
            element.querySelector('input').checked = true;
        }

        function selectMultiple(element, name) {
            const input = element.querySelector('input');
            input.checked = !input.checked;
            element.classList.toggle('selected');
        }

        async function diagnose() {
            // 診断実行前に会社情報を保存
            savedCompanyInfo = getCurrentCompanyInfo();
            console.log('診断開始時の会社情報を保存:', savedCompanyInfo);
            
            const formData = new FormData(document.getElementById('diagnosisForm'));
            const data = {};
            
            // 基本データの収集
            for (let [key, value] of formData.entries()) {
                if (data[key]) {
                    if (Array.isArray(data[key])) {
                        data[key].push(value);
                    } else {
                        data[key] = [data[key], value];
                    }
                } else {
                    data[key] = value;
                }
            }

            // ローディング表示
            displayLoading();

            try {
                // Claude AIに診断を依頼
                const response = await fetch('/api/joseikin-diagnosis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        diagnosis_data: data
                    })
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    displayResults(result.applicable_grants);
                } else {
                    displayError('診断中にエラーが発生しました: ' + result.error);
                }
                
            } catch (error) {
                console.error('診断エラー:', error);
                displayError('ネットワークエラーが発生しました。しばらく時間をおいて再度お試しください。');
            }
        }

        function displayLoading() {
            const resultsDiv = document.getElementById('results');
            const resultsList = document.getElementById('resultsList');
            
            resultsList.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <div style="animation: spin 1s linear infinite; width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; margin: 0 auto 1rem;"></div>
                    <p>AI専門家が全29カテゴリーの助成金を診断中...</p>
                    <p style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">令和7年度の最新情報で判定しています</p>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
            
            resultsDiv.style.display = 'block';
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function displayError(message) {
            const resultsList = document.getElementById('resultsList');
            resultsList.innerHTML = `<div style="color: #e74c3c; text-align: center; padding: 2rem;">${message}</div>`;
        }

        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            const resultsList = document.getElementById('resultsList');
            
            // 診断結果をグローバル変数に保存
            currentDiagnosisResults = results;
            
            if (results.length === 0) {
                resultsList.innerHTML = '<p>申し訳ございません。現在の条件では該当する助成金が見つかりませんでした。条件を見直すか、個別相談をご利用ください。</p>';
            } else {
                resultsList.innerHTML = results.map(result => `
                    <div class="result-item">
                        <h4>${result.name}</h4>
                        <div style="white-space: pre-line;">${result.description}</div>
                    </div>
                `).join('') + `
                    <div style="text-align: center; margin-top: 2rem; padding: 2rem; background: #f8f9ff; border-radius: 12px; border: 2px solid #667eea;">
                        <p style="color: #667eea; font-weight: 600; margin-bottom: 1rem;">💡 診断結果が保存されます</p>
                        
                        <div style="text-align: left; margin: 2rem 0; padding: 1.5rem; background: white; border-radius: 8px; border-left: 4px solid #667eea;">
                            <p style="color: #333; margin-bottom: 1rem;">今回の診断結果は、貴社が持つ可能性のほんの一部です。</p>
                            <p style="color: #333; margin-bottom: 1rem;">助成金は、申請の条件（加算要件）を的確に満たすことで、受給額をさらに増やせるケースが多数あります。実際に、弊社のサポートを通じて10年間で1億円以上を受給された企業様もいらっしゃいます。</p>
                            <p style="color: #333; margin-bottom: 1rem;">助成金申請のサイクルを一度確立すれば、それは貴社にとって安定した経営資源となります。このチャンスを最大限に活かすため、一日も早く準備を始めることが重要です。</p>
                            <p style="color: #333; margin-bottom: 1rem;">診断はゴールではなく、スタートです。</p>
                            <p style="color: #333; margin-bottom: 1rem;">「助成金レスキュー」が、複雑な申請プロセスを最短で完了まで徹底サポートいたします。</p>
                            <p style="color: #333; margin-bottom: 0;">まずは無料会員登録から、専門家と一緒に次の一歩を踏み出しましょう。</p>
                        </div>
                        
                        <p style="color: #667eea; font-weight: 600; margin-bottom: 1rem;">申請の準備に進むことをおすすめします</p>
                        <p style="color: #667eea; font-weight: 600; margin-bottom: 1rem;">AIエージェントが完全サポート</p>
                        
                        <h3 style="color: #333; margin: 1.5rem 0;">無料で会員登録</h3>
                        <p style="text-align: center; color: #666; margin-bottom: 2rem;">診断結果を保存して5回無料で専門エージェントが使えます</p>
                        
                        <!-- 会員登録フォーム（直接表示） -->
                        <div id="registrationWrapper" style="display: block;">
                        <form id="diagnosisRegistrationForm" style="max-width: 400px; margin: 0 auto;">
                            <div style="margin-bottom: 1rem;">
                                <input type="email" id="regEmail" required placeholder="メールアドレス" 
                                       style="width: 100%; padding: 0.8rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <input type="password" id="regPassword" required placeholder="パスワード（6文字以上）" 
                                       style="width: 100%; padding: 0.8rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                            </div>
                            <div style="margin-bottom: 1.5rem;">
                                <input type="password" id="regPasswordConfirm" required placeholder="パスワード（確認）" 
                                       style="width: 100%; padding: 0.8rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                            </div>
                            
                            <button type="submit" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; font-size: 1.1rem; margin-bottom: 1rem;">
                                ✨ 登録して専門エージェントを使う
                            </button>
                            
                            <p style="text-align: center; font-size: 0.8rem; color: #666;">
                                すでにアカウントをお持ちの場合は<br>
                                <a href="#" onclick="event.preventDefault(); document.getElementById('registrationWrapper').style.display='none'; document.getElementById('loginForm').style.display='block'; return false;" style="color: #667eea; text-decoration: underline;">こちらからログイン</a>
                            </p>
                        </form>
                        </div>
                        
                        <!-- ログインフォーム（切り替え用） -->
                        <div id="loginForm" style="display: none;">
                            <h3 style="color: #333; text-align: center; margin-bottom: 1.5rem;">🔐 ログイン</h3>
                            
                            <form id="diagnosisLoginForm" style="max-width: 400px; margin: 0 auto;">
                                <div style="margin-bottom: 1rem;">
                                    <input type="email" id="loginEmail" required placeholder="メールアドレス" 
                                           style="width: 100%; padding: 0.8rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                                </div>
                                <div style="margin-bottom: 1.5rem;">
                                    <input type="password" id="loginPassword" required placeholder="パスワード" 
                                           style="width: 100%; padding: 0.8rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                                </div>
                                
                                <button type="submit" style="width: 100%; background: linear-gradient(135deg, #ffc107 0%, #ff8500 100%); color: white; padding: 1rem; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; font-size: 1.1rem;">
                                    🚪 ログインしてダッシュボードへ
                                </button>
                            </form>
                            
                            <p style="text-align: center; margin-top: 1rem; font-size: 0.9rem; color: #666;">
                                まだアカウントをお持ちでない場合は<br>
                                <a href="#" onclick="event.preventDefault(); document.getElementById('loginForm').style.display='none'; document.getElementById('registrationWrapper').style.display='block'; return false;" style="color: #667eea; text-decoration: underline;">こちらから新規会員登録</a>
                            </p>
                        </div>
                    </div>
                    <div style="text-align: center; margin: 2rem 0; padding: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white;">
                        <h3 style="color: white; margin-bottom: 1rem; font-size: 1.3rem;">🚀 助成金レスキューで申請してみましょう！</h3>
                        <p style="color: rgba(255,255,255,0.9); font-size: 1.1rem; margin-bottom: 0;">各専門助成金エージェントで申請できます</p>
                    </div>
                    
                    <!-- ロードマップ -->
                    <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif; background-color: #f4f7f9; padding: 1.5em; border-radius: 12px; margin: 1.5rem 0;">

                      <!-- タイトル -->
                      <div style="text-align: center; margin-bottom: 2.5em;">
                        <h2 style="font-size: 1.8em; color: #2c3e50; margin: 0 0 0.5em 0; font-weight: 600;">助成金獲得までの最短ロードマップ</h2>
                        <p style="font-size: 1em; color: #555; margin: 0;">AIエージェントと二人三脚で、計画から受給までを賢く進めましょう。</p>
                      </div>

                      <!-- ステップ -->
                      <div style="display: flex; flex-direction: column; gap: 1.5em; max-width: 600px; margin: 0 auto;">

                        <!-- ステップ1 -->
                        <div style="background: #fff; padding: 1.5em; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.07); border-left: 4px solid #3498db;">
                          <div style="font-size: 1.2em; font-weight: bold; color: #3498db; margin-bottom: 0.5em;">STEP 1</div>
                          <h3 style="margin: 0 0 0.8em 0; font-size: 1.2em; color: #333;">発見 & 無料相談</h3>
                          <p style="font-size: 0.9em; color: #666; line-height: 1.6; margin-bottom: 1em;">まずは無料診断から。会員登録で専門エージェントへの相談が<strong style="color: #e74c3c;">5回無料</strong>になります。</p>
                          <span style="display: inline-block; background-color: #eaf5fc; color: #3498db; padding: 0.3em 0.8em; border-radius: 15px; font-size: 0.9em; font-weight: bold;">費用：無料</span>
                        </div>
                        
                        <!-- ステップ2 -->
                        <div style="background: #fff; padding: 1.5em; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.07); border-left: 4px solid #f39c12;">
                          <div style="font-size: 1.2em; font-weight: bold; color: #f39c12; margin-bottom: 0.5em;">STEP 2</div>
                          <h3 style="margin: 0 0 0.8em 0; font-size: 1.2em; color: #333;">計画 & 申請サポート</h3>
                          <p style="font-size: 0.9em; color: #666; line-height: 1.6; margin-bottom: 1em;">サブスク登録後は、<strong style="color: #e74c3c;">月20回</strong>まで相談可能。AIエージェントが疑問に全て答えます。相談回数が足りない月は<strong style="color: #e74c3c;">追加パッケージ</strong>のご購入も可能。また、複数申請向けに<strong style="color: #e74c3c;">月50回/90回の上位プラン</strong>もご用意しています。</p>
                          <span style="display: inline-block; background-color: #fef5e7; color: #f39c12; padding: 0.3em 0.8em; border-radius: 15px; font-size: 0.9em; font-weight: bold;">費用：月額1,480円〜</span>
                        </div>

                        <!-- ステップ3 -->
                        <div style="background: #fff; padding: 1.5em; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.07); border-left: 4px solid #2ecc71;">
                          <div style="font-size: 1.2em; font-weight: bold; color: #2ecc71; margin-bottom: 0.5em;">STEP 3</div>
                          <h3 style="margin: 0 0 0.8em 0; font-size: 1.2em; color: #333;">受給開始</h3>
                          <p style="font-size: 0.9em; color: #666; line-height: 1.6; margin-bottom: 1em;"><strong style="color:#333; display: inline-block; white-space: nowrap;">【例：キャリアアップ助成金の場合】</strong><br>準備から約8ヶ月で1期目(40万円)、その6ヶ月後に2期目(40万円)を受給！</p>
                          <span style="display: inline-block; background-color: #eafaf1; color: #2ecc71; padding: 0.3em 0.8em; border-radius: 15px; font-size: 0.9em; font-weight: bold;">合計80万円の例も！</span>
                        </div>
                      </div>

                      <!-- まとめ・投資対効果 -->
                      <div style="background: #fff; margin-top: 2.5em; padding: 2em; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.07); text-align: center;">
                        <h3 style="margin: 0 0 1em 0; font-size: 1.4em; color: #2c3e50;">【投資シミュレーション】<br>14ヶ月間の利用でこれだけお得に！</h3>
                        <div style="display: flex; justify-content: center; align-items: center; gap: 1.5em; flex-wrap: wrap;">
                          <div>
                            <div style="font-size: 1em; color: #7f8c8d;">総受給額 (例)</div>
                            <div style="font-size: 2.2em; font-weight: bold; color: #2ecc71;">800,000<span style="font-size:0.7em;">円</span></div>
                          </div>
                          <div style="font-size: 1.5em; color: #7f8c8d;">-</div>
                          <div>
                            <div style="font-size: 1em; color: #7f8c8d;">サービス費用 (14ヶ月)</div>
                            <div style="font-size: 2.2em; font-weight: bold; color: #e74c3c;">20,720<span style="font-size:0.7em;">円</span></div>
                          </div>
                          <div style="font-size: 1.5em; color: #7f8c8d;">=</div>
                          <div>
                            <div style="font-size: 1em; color: #7f8c8d;">あなたの純利益</div>
                            <div style="font-size: 2.8em; font-weight: bold; color: #2980b9; background: #ecf5ff; padding: 0.1em 0.4em; border-radius: 8px;">+779,280<span style="font-size:0.6em;">円</span></div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- 高額助成金の場合の比較ブロック -->
                      <div style="background: #eafaf1; border-left: 5px solid #2ecc71; margin-top: 2.5em; padding: 2em; border-radius: 10px; text-align: center;">
                        <h3 style="margin: 0 0 1em 0; font-size: 1.4em; color: #2c3e50;">
                          <span style="display: block; font-size: 0.8em; color: #16a085;">＼もし受給額が600万円なら… その差は歴然です！／</span>
                        </h3>
                        <div style="display: flex; justify-content: center; align-items: stretch; gap: 1.5em; flex-wrap: wrap;">
                          <!-- 一般的な社労士報酬 -->
                          <div style="flex: 1; min-width: 220px; background: #fff; padding: 1.5em 1em; border-radius: 8px; border: 1px solid #ddd;">
                            <div style="font-size: 1.1em; color: #7f8c8d;">一般的な成功報酬 (25%)</div>
                            <div style="font-size: 2.5em; font-weight: bold; color: #e74c3c; margin-top: 0.2em;">1,500,000<span style="font-size:0.6em;">円</span></div>
                          </div>
                          <!-- 当社サービス費用 -->
                          <div style="flex: 1; min-width: 220px; background: #fff; padding: 1.5em 1em; border-radius: 8px; border: 1px solid #ddd;">
                            <div style="font-size: 1.1em; color: #7f8c8d;">当サポート費用 (14ヶ月例)</div>
                            <div style="font-size: 2.5em; font-weight: bold; color: #2980b9; margin-top: 0.2em;">20,720<span style="font-size:0.6em;">円</span></div>
                          </div>
                        </div>
                        <p style="margin-top: 1.5em; margin-bottom: 0; color: #333; font-size: 1.1em; font-weight: 600;">圧倒的なコストパフォーマンスで、あなたの挑戦を全力で応援します。</p>
                      </div>
                      
                      <!-- 【NEW】専門家相談オプション -->
                      <div style="background: #fff; border: 2px dashed #3498db; margin-top: 2.5em; padding: 2em; border-radius: 10px; text-align: center;">
                        <h3 style="margin: 0 0 1em 0; font-size: 1.4em; color: #2c3e50;">
                          <span style="display: block; font-size: 0.8em; color: #2980b9;">＼もしもの時も万全のサポート体制／</span>
                          専門家への直接相談オプション
                        </h3>
                        <p style="margin: 0 auto 1.5em auto; max-width: 600px; color: #333; line-height: 1.7;">
                          複雑なケースやトラブルでお困りの際は、助成金に特化した社会保険労務士へ直接ご相談いただけます（予約制）。専門家による的確なアドバイスとその後の<strong style="color: #2980b9;">詳細レポート</strong>は、あなたの事業の大きな助けになります。
                        </p>
                        <div style="display: inline-block; background: #ecf5ff; padding: 0.8em 1.5em; border-radius: 8px; margin-bottom: 1em;">
                          <div style="font-size: 1em; color: #34495e;">相談料</div>
                          <div style="font-size: 2em; font-weight: bold; color: #2c3e50;">13,000<span style="font-size:0.6em;">円</span><span style="font-size:0.8em; font-weight:normal;"> / 30分</span></div>
                        </div>
                        <p style="margin-top: 1.5em; margin-bottom: 0; color: #333; font-size: 1.1em; font-weight: 600;">このオプションを利用しても、ご自身で進めても、大変お得です。</p>
                      </div>

                      <!-- 注釈 -->
                      <div style="text-align: right; margin-top: 1.5em; font-size: 0.9em; color: #777;">
                        ※受給額や期間は助成金の種類や申請のタイミングによって変動します。
                      </div>

                    </div>
                `;
            }
            
            resultsDiv.style.display = 'block';
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
            
            // 診断結果をlocalStorageに確実に保存
            const aiResultData = {
                type: 'diagnosis',
                timestamp: new Date().toISOString(),
                content: results,
                summary: '診断結果'
            };
            
            let aiResults = JSON.parse(localStorage.getItem('aiDiagnosisResults') || '[]');
            aiResults.unshift(aiResultData);
            localStorage.setItem('aiDiagnosisResults', JSON.stringify(aiResults));
            console.log('診断結果をlocalStorageに保存しました:', aiResultData);
            
            // フォーム送信処理を追加
            setupFormHandlers();
        }
        
        function setupFormHandlers() {
            // 会員登録フォームの処理
            const regForm = document.getElementById('diagnosisRegistrationForm');
            if (regForm && !regForm.dataset.handlerAdded) {
                regForm.dataset.handlerAdded = 'true';
                regForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const email = document.getElementById('regEmail').value;
                    const password = document.getElementById('regPassword').value;
                    const passwordConfirm = document.getElementById('regPasswordConfirm').value;
                    
                    if (password !== passwordConfirm) {
                        alert('パスワードが一致しません。');
                        return;
                    }
                    
                    if (password.length < 6) {
                        alert('パスワードは6文字以上で入力してください。');
                        return;
                    }
                    
                    try {
                        // Firebase Authentication で会員登録
                        const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                        
                        // サーバー側でユーザー情報とサブスクリプションを作成
                        const token = await userCredential.user.getIdToken();
                        const registerResponse = await fetch('/api/auth/register', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                uid: userCredential.user.uid,
                                email: userCredential.user.email,
                                display_name: userCredential.user.displayName || ''
                            })
                        });
                        
                        if (!registerResponse.ok) {
                            console.error('Server registration failed:', await registerResponse.text());
                        }
                        
                        // 診断結果をアカウントに紐付けて保存
                        await saveDiagnosisResultsForUser(userCredential.user.uid);
                        
                        window.location.href = '/dashboard';
                        
                    } catch (error) {
                        console.error('Registration error:', error);
                        alert('会員登録に失敗しました: ' + error.message);
                    }
                });
            }
            
            // ログインフォームの処理
            const loginForm = document.getElementById('diagnosisLoginForm');
            if (loginForm && !loginForm.dataset.handlerAdded) {
                loginForm.dataset.handlerAdded = 'true';
                loginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const email = document.getElementById('loginEmail').value;
                    const password = document.getElementById('loginPassword').value;
                    
                    try {
                        // Firebase Authentication でログイン
                        const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                        
                        // 診断結果をアカウントに紐付けて保存
                        await saveDiagnosisResultsForUser(userCredential.user.uid);
                        
                        window.location.href = '/dashboard';
                        
                    } catch (error) {
                        console.error('Login error:', error);
                        alert('ログインに失敗しました: ' + error.message);
                    }
                });
            }
        }
        
        // 診断結果をログインユーザーのアカウントに保存
        async function saveDiagnosisResultsForUser(userId) {
            const sessionData = sessionStorage.getItem('pendingDiagnosisResults');
            if (!sessionData) return;
            
            try {
                const diagnosisData = JSON.parse(sessionData);
                
                // 診断結果をサーバーに保存
                const token = await firebase.auth().currentUser.getIdToken();
                const response = await fetch('/api/diagnosis/save-temp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        results: diagnosisData.results,
                        companyInfo: diagnosisData.companyInfo
                    })
                });
                
                if (response.ok) {
                    // セッションデータをクリア
                    sessionStorage.removeItem('pendingDiagnosisResults');
                    console.log('診断結果をアカウントに保存しました');
                } else {
                    console.error('診断結果の保存に失敗しました');
                }
            } catch (error) {
                console.error('診断結果保存エラー:', error);
            }
        }

        async function goToAIConsultation() {
            // 診断結果が存在する場合は保存
            if (currentDiagnosisResults) {
                await saveDiagnosisResults(currentDiagnosisResults);
            }
            
            // 認証状態をチェック
            try {
                const response = await fetch('/api/auth/user');
                if (response.ok) {
                    // 認証済みの場合はダッシュボードに
                    window.location.href = '/dashboard';
                } else {
                    // 未認証の場合は会員登録ページへ
                    window.location.href = '/auth';
                }
            } catch (error) {
                // エラーの場合は会員登録ページへ
                window.location.href = '/auth';
            }
        }
        
        function goToExpertConsultation() {
            // 専門家相談の場合（メールでお問い合わせ）
            let subject = "助成金専門家相談のお問い合わせ";
            let body = "助成金専門家相談をご希望です。\n\n";
            
            // 診断結果がある場合は含める
            if (currentDiagnosisResults && currentDiagnosisResults.length > 0) {
                body += "【診断結果】\n";
                currentDiagnosisResults.forEach((result, index) => {
                    body += `${index + 1}. ${result.name}\n`;
                    body += `   支給額: ${result.amount}\n`;
                    body += `   適用可能性: ${result.applicability}\n\n`;
                });
                body += "\n";
            }
            
            // 会社情報がある場合は含める
            if (savedCompanyInfo) {
                body += "【会社情報】\n";
                if (savedCompanyInfo.industry) body += `業種: ${savedCompanyInfo.industry}\n`;
                if (savedCompanyInfo.totalEmployees) body += `従業員数: ${savedCompanyInfo.totalEmployees}名\n`;
                if (savedCompanyInfo.minWage) body += `事業場内最低賃金: ${savedCompanyInfo.minWage}円\n`;
                body += "\n";
            }
            
            body += "【相談内容】\n";
            body += "こちらに具体的な相談内容をご記入ください。\n\n";
            body += "【連絡先】\n";
            body += "お名前: \n";
            body += "電話番号: \n";
            body += "希望連絡時間: \n";
            
            // mailtoリンクを開く
            const mailtoLink = `mailto:info@jyoseikin.jp?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
        }
        
        function goToConsultation() {
            // 後方互換性のため残す
            goToAIConsultation();
        }
        
        let currentDiagnosisResults = null;
        let isUserLoggedIn = false;
        let savedCompanyInfo = null; // 診断実行時の会社情報を保存
        
        // ページ読み込み完了時のフェードイン
        window.addEventListener('load', function() {
            document.body.style.opacity = '1';
        });
        
        // 認証状態をチェック（Firebase設定）
        const firebaseConfig = {
            apiKey: "AIzaSyDzRzS-C104mWNloO94GNH7Jv93F5gWVto",
            authDomain: "jyoseikinrescue.firebaseapp.com",
            projectId: "jyoseikinrescue",
            storageBucket: "jyoseikinrescue.firebasestorage.app",
            messagingSenderId: "453016168690",
            appId: "1:453016168690:web:6658e01bdd588ea63f886b",
            measurementId: "G-V8WP53NEH4"
        };
        
        // Firebase初期化（診断ページでも認証状態をチェック）
        if (typeof firebase !== 'undefined') {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            const auth = firebase.auth();
            
            auth.onAuthStateChanged(function(user) {
                isUserLoggedIn = !!user;
                updateButtonDisplay();
            });
        }
        
        // 診断結果ページ内の会員登録フォーム表示
        function showRegistrationForm() {
            console.log('showRegistrationForm called'); // デバッグ用ログ
            
            // 診断結果をsessionStorageに保存
            saveDiagnosisToSession();
            
            // フォーム要素を取得
            const regForm = document.getElementById('registrationForm');
            const loginForm = document.getElementById('loginForm');
            
            console.log('Registration form element:', regForm); // デバッグ用ログ
            console.log('Login form element:', loginForm); // デバッグ用ログ
            
            if (regForm) {
                // 登録フォームを表示
                regForm.style.display = 'block';
                console.log('Registration form displayed'); // デバッグ用ログ
                
                // ログインフォームを非表示
                if (loginForm) {
                    loginForm.style.display = 'none';
                }
                
                // フォームまでスクロール
                regForm.scrollIntoView({ behavior: 'smooth' });
                console.log('Scrolled to registration form'); // デバッグ用ログ
            } else {
                console.error('Registration form not found!'); // エラーログ
            }
        }
        
        function showLoginForm() {
            // 診断結果をsessionStorageに保存
            saveDiagnosisToSession();
            
            // ログインフォームを表示
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registrationForm').style.display = 'none';
            
            // フォームまでスクロール
            document.getElementById('loginForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        function saveDiagnosisToSession() {
            if (currentDiagnosisResults) {
                const diagnosisData = {
                    results: currentDiagnosisResults,
                    companyInfo: getCurrentCompanyInfo(),
                    timestamp: new Date().toISOString()
                };
                sessionStorage.setItem('pendingDiagnosisResults', JSON.stringify(diagnosisData));
                console.log('診断結果をsessionStorageに保存しました');
            }
        }

        async function saveDiagnosisAndRegister() {
            // 診断結果を自動保存（localStorageに保存）
            if (currentDiagnosisResults) {
                const aiResultData = {
                    type: 'diagnosis',
                    timestamp: new Date().toISOString(),
                    content: currentDiagnosisResults,
                    summary: '診断結果'
                };
                
                let aiResults = JSON.parse(localStorage.getItem('aiDiagnosisResults') || '[]');
                aiResults.unshift(aiResultData);
                localStorage.setItem('aiDiagnosisResults', JSON.stringify(aiResults));
                console.log('診断結果を自動保存しました');
            }
            
            // 認証状態をチェック
            if (isUserLoggedIn) {
                // ログイン済みの場合は直接ダッシュボードへ
                window.location.href = '/dashboard';
            } else {
                // 未ログインの場合は選択画面を表示
                const choice = confirm('診断結果を保存しました。\n\n「OK」→ 会員登録（無料）\n「キャンセル」→ ログイン画面へ');
                if (choice) {
                    // 会員登録へ
                    window.location.href = '/?register=true';
                } else {
                    // ログイン画面へ
                    window.location.href = '/';
                }
            }
        }
        
        async function saveDiagnosisResults(results) {
            try {
                const companyInfo = getCurrentCompanyInfo();
                const diagnosisData = {
                    subsidies: results.map(result => ({
                        subsidy_name: result.name,
                        target: result.eligibility,
                        amount: result.amount,
                        description: result.description,
                        plan_required: result.plan_required || false,
                        plan_deadline: result.plan_deadline || null,
                        plan_documents: result.plan_documents || [],
                        payment_deadline: result.payment_deadline || null,
                        payment_documents: result.payment_documents || ['実績報告書', '領収書'],
                        diagnosis_summary: `${result.name}が適用可能です。支給額: ${result.amount}`,
                        // 診断時の企業情報と結果をメモとして保存
                        initial_memo: `【助成金診断結果】
業種: ${companyInfo.industry || '未設定'}
従業員数: ${companyInfo.employees || '未設定'}
現在の状況: ${companyInfo.situation || '未設定'}
目標: ${companyInfo.goals ? companyInfo.goals.join(', ') : '未設定'}

【診断結果】
${result.name}が適用可能
支給額: ${result.amount}
対象要件: ${result.eligibility}

【詳細説明】
${result.description}`
                    })),
                    timestamp: new Date().toISOString(),
                    company_info: companyInfo
                };
                
                const response = await fetch('/api/diagnosis/save-temp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(diagnosisData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    // セッションIDをローカルストレージに保存
                    localStorage.setItem('pendingDiagnosisSession', result.session_id);
                    console.log('診断結果を保存しました:', result.session_id);
                } else {
                    console.error('診断結果の保存に失敗しました');
                }
            } catch (error) {
                console.error('診断結果保存エラー:', error);
            }
        }
        
        function getCurrentCompanyInfo() {
            // フォームから現在の企業情報を取得
            return {
                industry: document.getElementById('industry')?.value || '',
                employees: document.getElementById('employees')?.value || '',
                situation: document.getElementById('situation')?.value || '',
                goals: Array.from(document.querySelectorAll('input[name="goals"]:checked')).map(cb => cb.value)
            };
        }
        
        // ボタンの表示を更新
        function updateButtonDisplay() {
            const saveToMemoSection = document.getElementById('saveToMemoSection');
            if (saveToMemoSection && isUserLoggedIn) {
                saveToMemoSection.style.display = 'block';
            }
        }
        
        // ログイン済みユーザー用の直接保存機能
        async function saveToMemoDirectly() {
            if (!currentDiagnosisResults || !isUserLoggedIn) {
                alert('診断結果がないか、ログインが必要です。');
                return;
            }
            
            // 診断結果を自動保存（localStorageに保存）
            const aiResultData = {
                type: 'diagnosis',
                timestamp: new Date().toISOString(),
                content: currentDiagnosisResults,
                summary: '診断結果'
            };
            
            let aiResults = JSON.parse(localStorage.getItem('aiDiagnosisResults') || '[]');
            aiResults.unshift(aiResultData);
            localStorage.setItem('aiDiagnosisResults', JSON.stringify(aiResults));
            
            console.log('診断結果を保存しました:', aiResultData);
            
            // 直接ダッシュボードに遷移（ポップアップなし）
            window.location.href = '/dashboard';
        }
    </script>
</body>
</html>