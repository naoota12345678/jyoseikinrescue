import os
import anthropic
from typing import Dict, List
import logging
from forms_manager import FormsManager

logger = logging.getLogger(__name__)

class ClaudeService:
    # å…±é€šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¦ç´ ï¼ˆã™ã¹ã¦ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ä½¿ç”¨ï¼‰
    COMMON_TIMELINE_UNDERSTANDING = """
ã€åŠ©æˆé‡‘ç”³è«‹ã®æ™‚ç³»åˆ—ç†è§£ - æœ€é‡è¦ã€‘
è³ªå•è€…ãŒã€Œã“ã‚Œã‹ã‚‰ã€œã™ã‚‹äºˆå®šã€ã€Œã€œã«ã—ã¾ã™ã€ã¨è¨€ã£ãŸå ´åˆï¼š
â†’ ã“ã‚Œã¯å°†æ¥ã®è¨ˆç”»ã§ã‚ã‚Šã€ã¾ã å®Ÿæ–½ã—ã¦ã„ãªã„
â†’ è¨ˆç”»ç”³è«‹æ™‚ç‚¹ã§ã¯ã€Œå®Ÿæ–½å‰ã€ã¨ã—ã¦æ‰±ã†
â†’ ã€Œæ—¢ã«å®Ÿæ–½æ¸ˆã¿ã€ã¨èª¤è§£ã—ãªã„

ä¾‹ï¼šã€Œ1010å††ã‹ã‚‰1075å††ã«ã—ã¾ã™ã€
â†’ è¨ˆç”»ç”³è«‹æ™‚ç‚¹ï¼š1010å††ï¼ˆç¾åœ¨ï¼‰
â†’ å¼•ä¸Šã’å¾Œï¼š1075å††ï¼ˆå°†æ¥ï¼‰
â†’ å·®é¡ï¼š65å††ã®å¼•ä¸Šã’äºˆå®š

ã€çŠ¶æ…‹å¤‰åŒ–ã®ç¢ºèªåŸå‰‡ã€‘
å¸¸ã«ä»¥ä¸‹ã®3æ™‚ç‚¹ã‚’æ˜ç¢ºã«åŒºåˆ¥ï¼š
1. ç¾åœ¨ã®çŠ¶æ…‹ï¼ˆè¨ˆç”»ç”³è«‹æ™‚ç‚¹ï¼‰
2. å®Ÿæ–½ä¸­ã®çŠ¶æ…‹ï¼ˆè¨ˆç”»å®Ÿè¡ŒæœŸé–“ï¼‰
3. å®Œäº†å¾Œã®çŠ¶æ…‹ï¼ˆæ”¯çµ¦ç”³è«‹æ™‚ç‚¹ï¼‰"""
    
    COMMON_LOGICAL_OPERATORS = """
ã€è«–ç†æ¼”ç®—å­ã®å³å¯†ãªç†è§£ - å¿…é ˆã€‘
ãƒ»ã€ŒAã‹ã¤Bã€= Aã¨Bã®ä¸¡æ–¹ã®æ¡ä»¶ã‚’æº€ãŸã™å¿…è¦ãŒã‚ã‚‹
ãƒ»ã€ŒAã¾ãŸã¯Bã€= Aã‹Bã®ã©ã¡ã‚‰ã‹ä¸€æ–¹ã®æ¡ä»¶ã‚’æº€ãŸã›ã°ã‚ˆã„
ãƒ»ã€ŒAãŠã‚ˆã³Bã€= Aã¨Bã®ä¸¡æ–¹ã®æ¡ä»¶ã‚’æº€ãŸã™å¿…è¦ãŒã‚ã‚‹
ãƒ»ã€ŒAã‚‚ã—ãã¯Bã€= Aã‹Bã®ã©ã¡ã‚‰ã‹ä¸€æ–¹ã®æ¡ä»¶ã‚’æº€ãŸã›ã°ã‚ˆã„"""
    
    COMMON_DATE_EXPRESSIONS = """
ã€æ—¥ä»˜è¡¨ç¾ã®å³å¯†ãªç†è§£ - å¿…é ˆã€‘
ãƒ»ã€Œå‰æ—¥ã€= ãã®æ—¥ã®1æ—¥å‰ï¼ˆä¾‹ï¼š4æœˆ1æ—¥ã®å‰æ—¥ = 3æœˆ31æ—¥ï¼‰
ãƒ»ã€Œç¿Œæ—¥ã€= ãã®æ—¥ã®1æ—¥å¾Œï¼ˆä¾‹ï¼š3æœˆ31æ—¥ã®ç¿Œæ—¥ = 4æœˆ1æ—¥ï¼‰
ãƒ»ã€Œå…¨æ—¥ã€= ãã®æ—¥ã®0æ™‚ã‹ã‚‰24æ™‚ã¾ã§ï¼ˆä¾‹ï¼š3æœˆ31æ—¥ã®å…¨æ—¥ = 3æœˆ31æ—¥ã®0æ™‚ï½24æ™‚ï¼‰
ãƒ»æ—¥ä»˜ã¯çµ¶å¯¾ã«å‹æ‰‹ã«å¤‰æ›´ã—ãªã„"""
    
    def __init__(self):
        api_key = os.getenv('CLAUDE_API_KEY') or os.getenv('ANTHROPIC_API_KEY')
        if not api_key:
            logger.warning("CLAUDE_API_KEY/ANTHROPIC_API_KEY is not set, using mock responses")
            self.client = None
            self.mock_mode = True
        else:
            self.mock_mode = False
            try:
                self.client = anthropic.Anthropic(
                    api_key=api_key
                )
                logger.info(f"Anthropic client initialized successfully with {'CLAUDE_API_KEY' if os.getenv('CLAUDE_API_KEY') else 'ANTHROPIC_API_KEY'}")
            except Exception as e:
                logger.error(f"Failed to initialize Anthropic client: {str(e)}")
                raise
        
        self.model = "claude-3-5-sonnet-20241022"  # Haikuã‹ã‚‰æœ€æ–°ã®Sonnet 3.5ã«å¤‰æ›´
        
        # Forms ManageråˆæœŸåŒ–
        self.forms_manager = FormsManager()
        
        
        # æ¥­å‹™æ”¹å–„åŠ©æˆé‡‘å°‚é–€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        self.business_improvement_prompt = self._load_business_improvement_prompt()
    
    def _get_common_prompt_base(self) -> str:
        """ã™ã¹ã¦ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ä½¿ç”¨ã™ã‚‹å…±é€šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿”ã™"""
        return f"""
{self.COMMON_LOGICAL_OPERATORS}

{self.COMMON_DATE_EXPRESSIONS}

{self.COMMON_TIMELINE_UNDERSTANDING}
"""
    
    def _load_business_improvement_prompt(self) -> str:
        """æ¥­å‹™æ”¹å–„åŠ©æˆé‡‘ã®è©³ç´°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ï¼ˆå…¨4ãƒ•ã‚¡ã‚¤ãƒ«çµ±åˆç‰ˆï¼‰"""
        try:
            import os
            base_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
            
            # 4ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¨ã¦èª­ã¿è¾¼ã¿
            files = [
                'gyoumukaizen07.txt',  # äº¤ä»˜è¦ç¶±
                'gyoumukaizenmanyual.txt',  # ç”³è«‹ãƒãƒ‹ãƒ¥ã‚¢ãƒ«
                'æ¥­å‹™æ”¹å–„åŠ©æˆé‡‘ï¼±ï¼†ï¼¡.txt',  # Q&A
                'æ¥­å‹™æ”¹å–„åŠ©æˆé‡‘ äº¤ä»˜ç”³è«‹æ›¸ç­‰ã®æ›¸ãæ–¹ã¨ç•™æ„äº‹é … ã«ã¤ã„ã¦.txt'  # ç”³è«‹æ›¸ã®æ›¸ãæ–¹
            ]
            
            all_content = ""
            for file_name in files:
                file_path = os.path.join(base_dir, file_name)
                try:
                    with open(file_path, 'r', encoding='utf-8') as f:
                        content = f.read()
                        all_content += f"\n\nã€{file_name}ã€‘\n{content}\n"
                        logger.info(f"Successfully loaded file: {file_name} ({len(content)} chars)")
                except FileNotFoundError:
                    logger.error(f"File not found: {file_path}")
                    continue
                except Exception as e:
                    logger.error(f"Error reading file {file_path}: {str(e)}")
                    continue
            
            if all_content:
                common_prompt = self._get_common_prompt_base()
                return f"""
ã‚ãªãŸã¯æ¥­å‹™æ”¹å–„åŠ©æˆé‡‘ã®å°‚é–€å®¶ã§ã™ã€‚ä»¥ä¸‹ã®å…¬å¼æ–‡æ›¸ã‚’å®Œå…¨ã«ç†è§£ã—ãŸä¸Šã§ã€ä¼æ¥­ã‹ã‚‰ã®ç›¸è«‡ã«æ­£ç¢ºã«å›ç­”ã—ã¦ãã ã•ã„ã€‚

ã€æœ€é‡è¦åˆ¶ç´„ - çµ¶å¯¾å³å®ˆã€‘
1. æä¾›ã•ã‚ŒãŸå…¬å¼æ–‡æ›¸ã®æƒ…å ±ã®ã¿ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
2. ã‚ãªãŸã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã«å«ã¾ã‚Œã‚‹å¤ã„åŠ©æˆé‡‘æƒ…å ±ã¯ä¸€åˆ‡ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„
3. é‡‘é¡ã€è¦ä»¶ã€åˆ¶åº¦å†…å®¹ã¯å…¨ã¦ä¸‹è¨˜è³‡æ–™é€šã‚Šã«æ­£ç¢ºã«è¨˜è¼‰ã—ã¦ãã ã•ã„
4. è³‡æ–™ã«è¨˜è¼‰ã•ã‚Œã¦ã„ãªã„æƒ…å ±ã¯ã€Œè©³ç´°ã¯åšç”ŸåŠ´åƒçœã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€ã¨å›ç­”ã—ã¦ãã ã•ã„

{common_prompt}

ã€æ¥­å‹™æ”¹å–„åŠ©æˆé‡‘ å®Œå…¨ç‰ˆè³‡æ–™ - ã“ã®æƒ…å ±ã®ã¿ä½¿ç”¨ã€‘
{all_content}

ä»¥ä¸‹ã®å½¢å¼ã§æ§‹é€ åŒ–ã•ã‚ŒãŸè¨ºæ–­ã‚’è¡Œã£ã¦ãã ã•ã„ï¼š

âœ… **åŸºæœ¬æ¡ä»¶ãƒã‚§ãƒƒã‚¯**
â€»å…¬å¼è³‡æ–™ã«åŸºã¥ãè¦ä»¶ç¢ºèªã‚’è¡Œã£ã¦ãã ã•ã„

ğŸ“‹ **ä¼æ¥­çŠ¶æ³ã®è¨ºæ–­**
â€»æä¾›ã•ã‚ŒãŸå…¬å¼è³‡æ–™ã«åŸºã¥ã„ã¦ä¼æ¥­ã®é©ç”¨å¯èƒ½æ€§ã‚’è¨ºæ–­ã—ã¦ãã ã•ã„

ğŸ’° **åŠ©æˆé¡ã®ç®—å®š**
â€»å…¬å¼è³‡æ–™è¨˜è¼‰ã®ç®—å®šæ–¹æ³•ã«å¾“ã£ã¦æ­£ç¢ºã«è¨ˆç®—ã—ã¦ãã ã•ã„

âš ï¸ **æ³¨æ„äº‹é …ãƒ»ãƒªã‚¹ã‚¯**
â€»å…¬å¼è³‡æ–™ã«è¨˜è¼‰ã•ã‚ŒãŸæ³¨æ„äº‹é …ã‚’é©åˆ‡ã«æ¡ˆå†…ã—ã¦ãã ã•ã„

å¿…ãšäº¤ä»˜è¦ç¶±ã«åŸºã¥ã„ã¦æ­£ç¢ºãªæƒ…å ±ã‚’æä¾›ã—ã€ä¼æ¥­ã®çŠ¶æ³ã«å¿œã˜ãŸå…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

ã€ç”³è«‹æ›¸é¡ã«ã¤ã„ã¦ - é‡è¦ã€‘
ç”³è«‹æ›¸é¡ã«ã¤ã„ã¦è³ªå•ã•ã‚ŒãŸå ´åˆã®å¯¾å¿œï¼š
- **çµ¶å¯¾ã«URLã‚’è‡ªåˆ†ã§ç”Ÿæˆã—ãªã„ã§ãã ã•ã„**
- ã¾ãšã€Œç”³è«‹æ§˜å¼ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã§ã”æ¡ˆå†…ã—ã¾ã™ã€‚ã€ã¨æ•è©ã‚’è¿°ã¹ã¦ã‹ã‚‰ã€ç”³è«‹ã«å¿…è¦ãªæ›¸é¡ã‚’ä»¥ä¸‹ã®2ç¨®é¡ã«åˆ†é¡ã—ã¦èª¬æ˜ã—ã¦ãã ã•ã„ï¼š

ğŸ“‹ **åšåŠ´çœæŒ‡å®šã®ç”³è«‹æ§˜å¼**ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¿…è¦ï¼‰
ãƒ»ã€Œæ§˜å¼ç¬¬â—‹å·ã€ã¨è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹æ³•å®šæ›¸å¼
ãƒ»æ”¯çµ¦ç”³è«‹æ›¸ã€äº‹æ¥­æ‰€ç¢ºèªç¥¨ã€å¯¾è±¡è€…ç¢ºèªç¥¨ç­‰
â†’ ã€Œã“ã®ã‚µã‚¤ãƒˆä¸Šéƒ¨ã®ã€ç”³è«‹æ›¸é¡ã€ãƒœã‚¿ãƒ³ã‹ã‚‰å„åŠ©æˆé‡‘ã®ç”³è«‹æ§˜å¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€

ğŸ“„ **ä¼æ¥­ã§æº–å‚™ã™ã‚‹æ·»ä»˜æ›¸é¡**
ãƒ»å°±æ¥­è¦å‰‡ã€åŠ´åƒå”ç´„ã€è³ƒé‡‘å°å¸³ã€å‡ºå‹¤ç°¿ã€é›‡ç”¨å¥‘ç´„æ›¸ç­‰
ãƒ»ä¼æ¥­ãŒæ—¥å¸¸çš„ã«ä½œæˆãƒ»ç®¡ç†ã—ã¦ã„ã‚‹æ›¸é¡
â†’ ã€Œå„ä¼æ¥­ã§ä½œæˆãƒ»ç®¡ç†ã•ã‚Œã¦ã„ã‚‹æ›¸é¡ã§ã™ã€

- æ§˜å¼ç•ªå·ã¨ç”¨é€”ã€è¨˜å…¥æ–¹æ³•ã‚„æ³¨æ„ç‚¹ã¯è©³ã—ãè§£èª¬ã—ã¦OK

ã€å³å®ˆäº‹é …ã€‘
- URLã¯çµ¶å¯¾ã«ç”Ÿæˆã—ãªã„ï¼ˆä¾‹ï¼šhttps://www.mhlw.go.jp/... ãªã©ã¯æ›¸ã‹ãªã„ï¼‰
- ã€Œåšç”ŸåŠ´åƒçœã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã§ã€ãªã©ã®å…·ä½“çš„ãªã‚µã‚¤ãƒˆåã‚‚æ›¸ã‹ãªã„
- ç”³è«‹æ§˜å¼ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ–¹æ³•ã‚’èã‹ã‚ŒãŸã‚‰ã€Œä»¥ä¸‹ã§ã”æ¡ˆå†…ã—ã¾ã™ã€ã¨ã ã‘ç­”ãˆã‚‹
"""
            else:
                # ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã‚ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                return "æ¥­å‹™æ”¹å–„åŠ©æˆé‡‘ã®è¦ç¶±ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚"
                
        except Exception as e:
            logger.error(f"Error loading business improvement prompt: {str(e)}")
            return "æ¥­å‹™æ”¹å–„åŠ©æˆé‡‘ã®è¦ç¶±ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚"
    
    def _select_system_prompt(self, question: str) -> str:
        """è³ªå•å†…å®¹ã«å¿œã˜ã¦é©åˆ‡ãªã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é¸æŠï¼ˆå»ƒæ­¢äºˆå®šï¼‰"""
        # ã“ã®é–¢æ•°ã¯å°‚é–€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ–¹å¼ã«ç§»è¡Œã—ãŸãŸã‚ä½¿ç”¨ã•ã‚Œã¾ã›ã‚“
        return self.business_improvement_prompt
    
    def _select_system_prompt_by_agent(self, agent_type: str, question: str) -> str:
        """ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é¸æŠ"""
        # æ–‡å­—åˆ—ã®å‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤
        agent_type = agent_type.strip()
        
        if agent_type == 'hanntei':
            # åŠ©æˆé‡‘åˆ¤å®šã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
            return self._get_hanntei_prompt()
        elif agent_type == 'gyoumukaizen':
            return self.business_improvement_prompt
        elif agent_type.startswith('career-up'):
            # ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒƒãƒ—åŠ©æˆé‡‘ã®ã‚³ãƒ¼ã‚¹åˆ¥å¯¾å¿œ
            return self._get_career_up_prompt(agent_type)
        elif agent_type.startswith('jinzai-kaihatsu'):
            # äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘ã®å„ã‚³ãƒ¼ã‚¹ã«å¯¾å¿œ
            return self._get_jinzai_kaihatsu_prompt(agent_type)
        else:
            # ãã®ä»–ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯æ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨
            logger.warning(f"Unknown agent type: '{agent_type}', falling back to general prompt")
            return self._select_system_prompt(question)
    
    def _get_hanntei_prompt(self) -> str:
        """åŠ©æˆé‡‘åˆ¤å®šã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ"""
        try:
            import os
            base_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
            
            # åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
            prompt_file = os.path.join(base_dir, 'file/åŠ©æˆé‡‘åˆ¤å®š/åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ.txt')
            database_file = os.path.join(base_dir, 'file/åŠ©æˆé‡‘åˆ¤å®š/åŠ©æˆé‡‘ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹2025.txt')
            
            system_prompt = ""
            database_content = ""
            
            if os.path.exists(prompt_file):
                with open(prompt_file, 'r', encoding='utf-8') as f:
                    system_prompt = f.read()
            
            if os.path.exists(database_file):
                with open(database_file, 'r', encoding='utf-8') as f:
                    database_content = f.read()
            
            # å…±é€šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ™ãƒ¼ã‚¹ã¨çµ„ã¿åˆã‚ã›
            common_prompt = self._get_common_prompt_base()
            
            return f"""{common_prompt}

{system_prompt}

ã€2025å¹´åº¦åŠ©æˆé‡‘ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€‘
{database_content}
"""
        except Exception as e:
            logger.error(f"Error loading hanntei prompt: {str(e)}")
            return "åŠ©æˆé‡‘åˆ¤å®šã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚"
    
    def _get_jinzai_kaihatsu_prompt(self, course: str) -> str:
        """äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘ã®å„ã‚³ãƒ¼ã‚¹ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ"""
        course_info = {
            'jinzai-ikusei': 'äººæè‚²æˆæ”¯æ´ã‚³ãƒ¼ã‚¹',
            'kyoiku-kunren-kyuka': 'æ•™è‚²è¨“ç·´ä¼‘æš‡ç­‰ä»˜ä¸ã‚³ãƒ¼ã‚¹',
            'hito-toshi': 'äººã¸ã®æŠ•è³‡ä¿ƒé€²ã‚³ãƒ¼ã‚¹',
            'reskilling': 'äº‹æ¥­å±•é–‹ç­‰ãƒªã‚¹ã‚­ãƒªãƒ³ã‚°æ”¯æ´ã‚³ãƒ¼ã‚¹',
            'sonota': 'ãã®ä»–ã®ã‚³ãƒ¼ã‚¹'
        }
        
        course_name = course_info.get(course, 'äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘')
        common_prompt = self._get_common_prompt_base()
        
        return f"""
ã‚ãªãŸã¯{course_name}ã®å°‚é–€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚

ã€æœ€é‡è¦åˆ¶ç´„ - çµ¶å¯¾å³å®ˆã€‘
1. æä¾›ã•ã‚ŒãŸå…¬å¼æ–‡æ›¸ã®æƒ…å ±ã®ã¿ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
2. ã‚ãªãŸã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã«å«ã¾ã‚Œã‚‹å¤ã„åŠ©æˆé‡‘æƒ…å ±ã¯ä¸€åˆ‡ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„
3. é‡‘é¡ã€è¦ä»¶ã€åˆ¶åº¦å†…å®¹ã¯å…¨ã¦ä¸‹è¨˜è³‡æ–™é€šã‚Šã«æ­£ç¢ºã«è¨˜è¼‰ã—ã¦ãã ã•ã„
4. è³‡æ–™ã«è¨˜è¼‰ã•ã‚Œã¦ã„ãªã„æƒ…å ±ã¯ã€Œè©³ç´°ã¯åšç”ŸåŠ´åƒçœã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€ã¨å›ç­”ã—ã¦ãã ã•ã„

{common_prompt}

ã€å°‚é–€åˆ†é‡ã€‘
- {course_name}ã«é–¢ã™ã‚‹è³ªå•ã®ã¿å›ç­”
- ç ”ä¿®ãƒ»æ•™è‚²è¨“ç·´ãƒ»äººæè‚²æˆã«é–¢ã™ã‚‹åŠ©æˆé‡‘åˆ¶åº¦
- ç”³è«‹æ‰‹ç¶šãã€è¦ä»¶ã€æ”¯çµ¦é¡ã®è©³ç´°èª¬æ˜

ã€å›ç­”æ–¹é‡ã€‘
1. {course_name}ã«ç‰¹åŒ–ã—ãŸæ­£ç¢ºãªæƒ…å ±ã‚’æä¾›
2. ç”³è«‹è¦ä»¶ã‚’è©³ã—ãèª¬æ˜
3. æ”¯çµ¦é¡ãƒ»åŠ©æˆç‡ã‚’å…·ä½“çš„ã«è¨˜è¼‰
4. ç”³è«‹æ‰‹ç¶šãã®æµã‚Œã‚’èª¬æ˜
5. ã‚ˆãã‚ã‚‹è³ªå•ã«ã‚‚å¯¾å¿œ

ã€æ³¨æ„äº‹é …ã€‘
- åšç”ŸåŠ´åƒçœç®¡è½„ã®åŠ©æˆé‡‘ã®ã¿å¯¾å¿œ
- è£œåŠ©é‡‘ã«ã¤ã„ã¦ã®è³ªå•ã«ã¯ã€Œå°‚é–€å¤–ã§ã™ã€ã¨å›ç­”
- ä¸æ˜ãªç‚¹ã¯æœ€æ–°ã®å…¬å¼æƒ…å ±ã®ç¢ºèªã‚’æ¨å¥¨

è³ªå•è€…ã®ä¼æ¥­æƒ…å ±ã‚’è¸ã¾ãˆã€{course_name}ã«ã¤ã„ã¦å°‚é–€çš„ã§å®Ÿç”¨çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚
"""
    
    def _get_career_up_prompt(self, agent_type: str) -> str:
        """ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒƒãƒ—åŠ©æˆé‡‘ã®ã‚³ãƒ¼ã‚¹åˆ¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ"""
        course_map = {
            'career-up_seishain': ('æ­£ç¤¾å“¡åŒ–ã‚³ãƒ¼ã‚¹', 'file/ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒƒãƒ—åŠ©æˆé‡‘/1000 æ­£ç¤¾å“¡åŒ–ã‚³ãƒ¼ã‚¹.txt'),
            'career-up_shogaisha': ('éšœå®³è€…æ­£ç¤¾å“¡åŒ–ã‚³ãƒ¼ã‚¹', 'file/ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒƒãƒ—åŠ©æˆé‡‘/2000 éšœå®³è€…æ­£ç¤¾å“¡åŒ–ã‚³ãƒ¼ã‚¹.txt'),
            'career-up_chingin': ('è³ƒé‡‘è¦å®šç­‰æ”¹å®šã‚³ãƒ¼ã‚¹', 'file/ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒƒãƒ—åŠ©æˆé‡‘/3000 è³ƒé‡‘è¦å®šç­‰æ”¹å®šã‚³ãƒ¼ã‚¹.txt'),
            'career-up_kyotsu': ('è³ƒé‡‘è¦å®šç­‰å…±é€šåŒ–ã‚³ãƒ¼ã‚¹', 'file/ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒƒãƒ—åŠ©æˆé‡‘/4000 è³ƒé‡‘è¦å®šç­‰å…±é€šåŒ–ã‚³ãƒ¼ã‚¹.txt'),
            'career-up_shoyo': ('è³ä¸ãƒ»é€€è·é‡‘åˆ¶åº¦å°å…¥ã‚³ãƒ¼ã‚¹', 'file/ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒƒãƒ—åŠ©æˆé‡‘/5000 è³ä¸ãƒ»é€€è·é‡‘åˆ¶åº¦å°å…¥ã‚³ãƒ¼ã‚¹.txt'),
            'career-up_shahoken': ('ç¤¾ä¼šä¿é™ºé©ç”¨æ™‚å‡¦é‡æ”¹å–„ã‚³ãƒ¼ã‚¹', 'file/ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒƒãƒ—åŠ©æˆé‡‘/6000 ç¤¾ä¼šä¿é™ºé©ç”¨æ™‚å‡¦é‡æ”¹å–„ã‚³ãƒ¼ã‚¹.txt'),
            'career-up_tanshuku': ('çŸ­æ™‚é–“åŠ´åƒè€…åŠ´åƒæ™‚é–“å»¶é•·æ”¯æ´ã‚³ãƒ¼ã‚¹', 'file/ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒƒãƒ—åŠ©æˆé‡‘/7000 çŸ­æ™‚é–“åŠ´åƒè€…åŠ´åƒæ™‚é–“å»¶é•·æ”¯æ´ã‚³ãƒ¼ã‚¹.txt')
        }
        
        if agent_type not in course_map:
            logger.warning(f"Agent type {agent_type} not found in course_map")
            return f"ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¿ã‚¤ãƒ— {agent_type} ã¯å®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
            
        course_name, file_name = course_map[agent_type]
        try:
            import os
            base_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
            
            # å…±é€šéƒ¨åˆ†ã‚’èª­ã¿è¾¼ã¿
            common_file_path = os.path.join(base_dir, 'file/ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒƒãƒ—åŠ©æˆé‡‘/å…±é€šéƒ¨åˆ†ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒƒãƒ—jyoseikinæ”¯çµ¦è¦é ˜_å…±é€š.txt')
            with open(common_file_path, 'r', encoding='utf-8') as f:
                common_content = f.read()
            
            # ã‚³ãƒ¼ã‚¹å›ºæœ‰éƒ¨åˆ†ã‚’èª­ã¿è¾¼ã¿
            course_file_path = os.path.join(base_dir, file_name)
            with open(course_file_path, 'r', encoding='utf-8') as f:
                course_content = f.read()
                
            # å…±é€šéƒ¨åˆ†ã¨ã‚³ãƒ¼ã‚¹å›ºæœ‰éƒ¨åˆ†ã‚’çµåˆ
            full_content = f"{common_content}\n\n=== {course_name} è©³ç´° ===\n{course_content}"
            common_prompt = self._get_common_prompt_base()
                
            return f"""
ã‚ãªãŸã¯ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒƒãƒ—åŠ©æˆé‡‘ã®{course_name}å°‚é–€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚

ã€æœ€é‡è¦åˆ¶ç´„ - çµ¶å¯¾å³å®ˆã€‘
1. æä¾›ã•ã‚ŒãŸå…¬å¼æ–‡æ›¸ã®æƒ…å ±ã®ã¿ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
2. ã‚ãªãŸã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã«å«ã¾ã‚Œã‚‹å¤ã„åŠ©æˆé‡‘æƒ…å ±ã¯ä¸€åˆ‡ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„
3. é‡‘é¡ã€è¦ä»¶ã€åˆ¶åº¦å†…å®¹ã¯å…¨ã¦ä¸‹è¨˜è³‡æ–™é€šã‚Šã«æ­£ç¢ºã«è¨˜è¼‰ã—ã¦ãã ã•ã„
4. è³‡æ–™ã«è¨˜è¼‰ã•ã‚Œã¦ã„ãªã„æƒ…å ±ã¯ã€Œè©³ç´°ã¯åšç”ŸåŠ´åƒçœã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€ã¨å›ç­”ã—ã¦ãã ã•ã„

{common_prompt}

ã€å°‚é–€åˆ†é‡ã€‘
- {course_name}ã«é–¢ã™ã‚‹è³ªå•ã®ã¿å›ç­”
- éæ­£è¦é›‡ç”¨åŠ´åƒè€…ã®ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒƒãƒ—æ”¯æ´åˆ¶åº¦
- è¨ˆç”»ç”³è«‹ã‹ã‚‰æ”¯çµ¦ç”³è«‹ã¾ã§å…¨ãƒ•ã‚§ãƒ¼ã‚ºå¯¾å¿œ

ã€{course_name} è©³ç´°è³‡æ–™ - ã“ã®æƒ…å ±ã®ã¿ä½¿ç”¨ã€‘
{full_content}

ã€å›ç­”æ–¹é‡ã€‘
1. {course_name}ã«ç‰¹åŒ–ã—ãŸæ­£ç¢ºãªæƒ…å ±ã‚’æä¾›
2. æ”¯çµ¦è¦ä»¶ã‚’è©³ã—ãèª¬æ˜
3. æ”¯çµ¦é¡ãƒ»åŠ©æˆç‡ã‚’å…·ä½“çš„ã«è¨˜è¼‰
4. ç”³è«‹æ‰‹ç¶šãã®æµã‚Œã‚’èª¬æ˜ï¼ˆè¨ˆç”»ç”³è«‹â†’å®Ÿæ–½â†’æ”¯çµ¦ç”³è«‹ï¼‰
5. å¿…è¦æ›¸é¡ã¨æ·»ä»˜è³‡æ–™ã®æ¡ˆå†…

ã€æ§‹é€ åŒ–ã•ã‚ŒãŸå›ç­”å½¢å¼ã€‘
âœ… **å¯¾è±¡åŠ´åƒè€…ã®è¦ä»¶**
- æœ‰æœŸé›‡ç”¨åŠ´åƒè€…/ç„¡æœŸé›‡ç”¨åŠ´åƒè€…/æ´¾é£åŠ´åƒè€…ã®åŒºåˆ†
- é›‡ç”¨æœŸé–“ãƒ»å‹¤ç¶šå¹´æ•°ç­‰ã®æ¡ä»¶

ğŸ“‹ **æ”¯çµ¦å¯¾è±¡äº‹æ¥­ä¸»ã®è¦ä»¶**
- ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒƒãƒ—è¨ˆç”»ã®ä½œæˆãƒ»æå‡º
- è»¢æ›åˆ¶åº¦ã®æ•´å‚™
- è³ƒé‡‘å¢—é¡è¦ä»¶

ğŸ’° **æ”¯çµ¦é¡ã®ç®—å®š**
- ä¸­å°ä¼æ¥­ãƒ»å¤§ä¼æ¥­åˆ¥ã®æ”¯çµ¦é¡
- åŠ ç®—æªç½®ã®é©ç”¨æ¡ä»¶

ğŸ“ **ç”³è«‹æ‰‹ç¶šãã®æµã‚Œ**
- ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒƒãƒ—è¨ˆç”»æ›¸æå‡º
- è»¢æ›ãƒ»ç›´æ¥é›‡ç”¨ã®å®Ÿæ–½
- æ”¯çµ¦ç”³è«‹æ›¸æå‡º

âš ï¸ **æ³¨æ„äº‹é …ãƒ»ä½µçµ¦èª¿æ•´**
- ä»–ã®åŠ©æˆé‡‘ã¨ã®é–¢ä¿‚
- æ”¯çµ¦ç”³è«‹æœŸé™

ã€ç”³è«‹æ›¸é¡ã«ã¤ã„ã¦ - é‡è¦ã€‘
ç”³è«‹æ›¸é¡ã«ã¤ã„ã¦è³ªå•ã•ã‚ŒãŸå ´åˆã®å¯¾å¿œï¼š
- **çµ¶å¯¾ã«URLã‚’è‡ªåˆ†ã§ç”Ÿæˆã—ãªã„ã§ãã ã•ã„**
- ã¾ãšã€Œç”³è«‹æ§˜å¼ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã§ã”æ¡ˆå†…ã—ã¾ã™ã€‚ã€ã¨æ•è©ã‚’è¿°ã¹ã¦ã‹ã‚‰ã€ç”³è«‹ã«å¿…è¦ãªæ›¸é¡ã‚’ä»¥ä¸‹ã®2ç¨®é¡ã«åˆ†é¡ã—ã¦èª¬æ˜ã—ã¦ãã ã•ã„ï¼š

ğŸ“‹ **åšåŠ´çœæŒ‡å®šã®ç”³è«‹æ§˜å¼**ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¿…è¦ï¼‰
ãƒ»ã€Œæ§˜å¼ç¬¬â—‹å·ã€ã¨è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹æ³•å®šæ›¸å¼
ãƒ»æ”¯çµ¦ç”³è«‹æ›¸ã€äº‹æ¥­æ‰€ç¢ºèªç¥¨ã€å¯¾è±¡è€…ç¢ºèªç¥¨ç­‰
â†’ ã€Œã“ã®ã‚µã‚¤ãƒˆä¸Šéƒ¨ã®ã€ç”³è«‹æ›¸é¡ã€ãƒœã‚¿ãƒ³ã‹ã‚‰å„åŠ©æˆé‡‘ã®ç”³è«‹æ§˜å¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€

ğŸ“„ **ä¼æ¥­ã§æº–å‚™ã™ã‚‹æ·»ä»˜æ›¸é¡**
ãƒ»å°±æ¥­è¦å‰‡ã€åŠ´åƒå”ç´„ã€è³ƒé‡‘å°å¸³ã€å‡ºå‹¤ç°¿ã€é›‡ç”¨å¥‘ç´„æ›¸ç­‰
ãƒ»ä¼æ¥­ãŒæ—¥å¸¸çš„ã«ä½œæˆãƒ»ç®¡ç†ã—ã¦ã„ã‚‹æ›¸é¡
â†’ ã€Œå„ä¼æ¥­ã§ä½œæˆãƒ»ç®¡ç†ã•ã‚Œã¦ã„ã‚‹æ›¸é¡ã§ã™ã€

- æ§˜å¼ç•ªå·ã¨ç”¨é€”ã€è¨˜å…¥æ–¹æ³•ã‚„æ³¨æ„ç‚¹ã¯è©³ã—ãè§£èª¬ã—ã¦OK

ã€å³å®ˆäº‹é …ã€‘
- URLã¯çµ¶å¯¾ã«ç”Ÿæˆã—ãªã„ï¼ˆä¾‹ï¼šhttps://www.mhlw.go.jp/... ãªã©ã¯æ›¸ã‹ãªã„ï¼‰
- ã€Œåšç”ŸåŠ´åƒçœã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã§ã€ãªã©ã®å…·ä½“çš„ãªã‚µã‚¤ãƒˆåã‚‚æ›¸ã‹ãªã„
- ç”³è«‹æ§˜å¼ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ–¹æ³•ã‚’èã‹ã‚ŒãŸã‚‰ã€Œä»¥ä¸‹ã§ã”æ¡ˆå†…ã—ã¾ã™ã€ã¨ã ã‘ç­”ãˆã‚‹

å¿…ãšæ”¯çµ¦è¦é ˜ã«åŸºã¥ã„ã¦æ­£ç¢ºãªæƒ…å ±ã‚’æä¾›ã—ã€ä¼æ¥­ã®çŠ¶æ³ã«å¿œã˜ãŸå…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
"""
        except Exception as e:
            logger.error(f"Error loading career-up course file {file_name}: {str(e)}")
            return f"""
ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚{course_name}ã®è©³ç´°è³‡æ–™ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚
ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒƒãƒ—åŠ©æˆé‡‘ã«é–¢ã™ã‚‹ä¸€èˆ¬çš„ãªæƒ…å ±ã¯æä¾›ã§ãã¾ã™ãŒã€è©³ç´°ãªè¦ä»¶ã«ã¤ã„ã¦ã¯åšç”ŸåŠ´åƒçœã®å…¬å¼ã‚µã‚¤ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚
"""
    
    def _get_jinzai_kaihatsu_prompt(self, agent_type: str) -> str:
        """äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘ã®ã‚³ãƒ¼ã‚¹åˆ¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ"""
        course_map = {
            # äººæè‚²æˆæ”¯æ´ã‚³ãƒ¼ã‚¹ã®3ã¤ã®ã‚µãƒ–ã‚³ãƒ¼ã‚¹
            'jinzai-kaihatsu_jinzai-ikusei_kunren': ('äººæè‚²æˆæ”¯æ´ã‚³ãƒ¼ã‚¹ï¼ˆäººæè‚²æˆè¨“ç·´ï¼‰', 'file/äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘/äººæè‚²æˆæ”¯æ´ã‚³ãƒ¼ã‚¹/0600 äººæè‚²æˆè¨“ç·´.txt'),
            'jinzai-kaihatsu_jinzai-ikusei_nintei': ('äººæè‚²æˆæ”¯æ´ã‚³ãƒ¼ã‚¹ï¼ˆèªå®šå®Ÿç¿’ä½µç”¨è·æ¥­è¨“ç·´ï¼‰', 'file/äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘/äººæè‚²æˆæ”¯æ´ã‚³ãƒ¼ã‚¹/0700 èªå®šå®Ÿç¿’ä½µç”¨è·æ¥­è¨“ç·´.txt'),
            'jinzai-kaihatsu_jinzai-ikusei_yuki': ('äººæè‚²æˆæ”¯æ´ã‚³ãƒ¼ã‚¹ï¼ˆæœ‰æœŸå®Ÿç¿’å‹è¨“ç·´ï¼‰', 'file/äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘/äººæè‚²æˆæ”¯æ´ã‚³ãƒ¼ã‚¹/0800 æœ‰æœŸå®Ÿç¿’å‹è¨“ç·´.txt'),
            
            # ä»–ã®ã‚³ãƒ¼ã‚¹
            'jinzai-kaihatsu_kyoiku-kyuka': ('æ•™è‚²è¨“ç·´ä¼‘æš‡ç­‰ä»˜ä¸ã‚³ãƒ¼ã‚¹', 'file/äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘/æ•™è‚²è¨“ç·´ä¼‘æš‡ç­‰ä»˜ä¸ã‚³ãƒ¼ã‚¹/æ•™è‚²è¨“ç·´ä¼‘æš‡ç­‰ä»˜ä¸ã‚³ãƒ¼ã‚¹.txt'),
            
            # äººã¸ã®æŠ•è³‡ä¿ƒé€²ã‚³ãƒ¼ã‚¹ã®4ã¤ã®ã‚µãƒ–ã‚³ãƒ¼ã‚¹
            'jinzai-kaihatsu_toushi_teigaku': ('äººã¸ã®æŠ•è³‡ä¿ƒé€²ã‚³ãƒ¼ã‚¹ï¼ˆå®šé¡åˆ¶è¨“ç·´ï¼‰', 'file/äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘/äººã¸ã®æŠ•è³‡ä¿ƒé€²ã‚³ãƒ¼ã‚¹/0600 å®šé¡åˆ¶è¨“ç·´.txt'),
            'jinzai-kaihatsu_toushi_jihatsu': ('äººã¸ã®æŠ•è³‡ä¿ƒé€²ã‚³ãƒ¼ã‚¹ï¼ˆè‡ªç™ºçš„è·æ¥­èƒ½åŠ›é–‹ç™ºè¨“ç·´ï¼‰', 'file/äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘/äººã¸ã®æŠ•è³‡ä¿ƒé€²ã‚³ãƒ¼ã‚¹/0700 è‡ªç™ºçš„è·æ¥­èƒ½åŠ›é–‹ç™ºè¨“ç·´.txt'),
            'jinzai-kaihatsu_toushi_digital': ('äººã¸ã®æŠ•è³‡ä¿ƒé€²ã‚³ãƒ¼ã‚¹ï¼ˆé«˜åº¦ãƒ‡ã‚¸ã‚¿ãƒ«äººæç­‰è¨“ç·´ï¼‰', 'file/äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘/äººã¸ã®æŠ•è³‡ä¿ƒé€²ã‚³ãƒ¼ã‚¹/0800 é«˜åº¦ãƒ‡ã‚¸ã‚¿ãƒ«äººæç­‰è¨“ç·´.txt'),
            'jinzai-kaihatsu_toushi_it': ('äººã¸ã®æŠ•è³‡ä¿ƒé€²ã‚³ãƒ¼ã‚¹ï¼ˆæƒ…å ±æŠ€è¡“åˆ†é‡èªå®šå®Ÿç¿’ä½µç”¨è·æ¥­è¨“ç·´ï¼‰', 'file/äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘/äººã¸ã®æŠ•è³‡ä¿ƒé€²ã‚³ãƒ¼ã‚¹/0900 æƒ…å ±æŠ€è¡“åˆ†é‡èªå®šå®Ÿç¿’ä½µç”¨è·æ¥­è¨“ç·´.txt'),
            'jinzai-kaihatsu_toushi': ('äººã¸ã®æŠ•è³‡ä¿ƒé€²ã‚³ãƒ¼ã‚¹', ''),
            'jinzai-kaihatsu_reskilling': ('äº‹æ¥­å±•é–‹ç­‰ãƒªã‚¹ã‚­ãƒªãƒ³ã‚°æ”¯æ´ã‚³ãƒ¼ã‚¹', 'file/äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘/ãƒªã‚¹ã‚­ãƒªãƒ³ã‚°ã‚³ãƒ¼ã‚¹/ãƒªã‚¹ã‚­ãƒªãƒ³ã‚°ã‚³ãƒ¼ã‚¹_20250906_160343_AI_plain.txt'),
            'reskilling': ('äº‹æ¥­å±•é–‹ç­‰ãƒªã‚¹ã‚­ãƒªãƒ³ã‚°æ”¯æ´ã‚³ãƒ¼ã‚¹', 'file/äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘/ãƒªã‚¹ã‚­ãƒªãƒ³ã‚°ã‚³ãƒ¼ã‚¹/ãƒªã‚¹ã‚­ãƒªãƒ³ã‚°ã‚³ãƒ¼ã‚¹_20250906_160343_AI_plain.txt'),
            'jinzai-kaihatsu_kensetsu-nintei': ('å»ºè¨­åŠ´åƒè€…èªå®šè¨“ç·´ã‚³ãƒ¼ã‚¹', ''),
            'jinzai-kaihatsu_kensetsu-gino': ('å»ºè¨­åŠ´åƒè€…æŠ€èƒ½å®Ÿç¿’ã‚³ãƒ¼ã‚¹', ''),
            'jinzai-kaihatsu_shogai': ('éšœå®³è€…è·æ¥­èƒ½åŠ›é–‹ç™ºã‚³ãƒ¼ã‚¹', '')
        }
        
        if agent_type not in course_map:
            logger.warning(f"Agent type {agent_type} not found in jinzai-kaihatsu course_map")
            return f"ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¿ã‚¤ãƒ— {agent_type} ã¯å®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
            
        course_name, file_name = course_map[agent_type]
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆï¼ˆæº–å‚™ä¸­ã®ã‚³ãƒ¼ã‚¹ï¼‰
        if not file_name:
            return f"""
ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚{course_name}ã¯ç¾åœ¨æº–å‚™ä¸­ã§ã™ã€‚
äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘ã®ä»–ã®ã‚³ãƒ¼ã‚¹ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚
"""
        
        try:
            import os
            base_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
            
            # æ•™è‚²è¨“ç·´ä¼‘æš‡ç­‰ä»˜ä¸ã‚³ãƒ¼ã‚¹ã®ç‰¹åˆ¥å‡¦ç†
            if agent_type == 'jinzai-kaihatsu_kyoiku-kyuka':
                # æ•™è‚²è¨“ç·´ä¼‘æš‡ç­‰ä»˜ä¸ã‚³ãƒ¼ã‚¹å°‚ç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
                course_file_path = os.path.join(base_dir, file_name)
                with open(course_file_path, 'r', encoding='utf-8') as f:
                    course_content = f.read()
                
                # 3ã¤ã®Q&Aãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
                qa_files = [
                    'file/äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘/æ•™è‚²è¨“ç·´ä¼‘æš‡ç­‰ä»˜ä¸ã‚³ãƒ¼ã‚¹/äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘äº‹æ¥­ä¸»æ§˜å‘ã‘ Q&A_20250906_094600_AI_plain.txt',
                    'file/äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘/æ•™è‚²è¨“ç·´ä¼‘æš‡ç­‰ä»˜ä¸ã‚³ãƒ¼ã‚¹/è³ƒé‡‘è¦ä»¶ãƒ»è³‡æ ¼ç­‰æ‰‹å½“è¦ä»¶ã«ã¤ã„ã¦Q&A_20250906_095243_AI_plain.txt'
                ]
                
                qa_content = ""
                for qa_file in qa_files:
                    qa_file_path = os.path.join(base_dir, qa_file)
                    if os.path.exists(qa_file_path):
                        with open(qa_file_path, 'r', encoding='utf-8') as f:
                            qa_content += f"\n\nã€{os.path.basename(qa_file)}ã€‘\n{f.read()}\n"
                
                common_content = ""  # æ•™è‚²è¨“ç·´ä¼‘æš‡ç­‰ä»˜ä¸ã‚³ãƒ¼ã‚¹ã¯ç‹¬è‡ªã®æ§‹æˆ
                
            elif agent_type.startswith('jinzai-kaihatsu_toushi_'):
                # äººã¸ã®æŠ•è³‡ä¿ƒé€²ã‚³ãƒ¼ã‚¹ã®ç‰¹åˆ¥å‡¦ç†ï¼ˆ4ã¤ã®ã‚µãƒ–ã‚³ãƒ¼ã‚¹ï¼‰
                # ã‚³ãƒ¼ã‚¹å›ºæœ‰éƒ¨åˆ†ã‚’èª­ã¿è¾¼ã¿
                course_file_path = os.path.join(base_dir, file_name)
                with open(course_file_path, 'r', encoding='utf-8') as f:
                    course_content = f.read()
                
                # å…±é€šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
                common_file_path = os.path.join(base_dir, 'file/äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘/äººã¸ã®æŠ•è³‡ä¿ƒé€²ã‚³ãƒ¼ã‚¹/äººã¸ã®æŠ•è³‡ä¿ƒé€²ã‚³ãƒ¼ã‚¹_å…±é€š.txt')
                with open(common_file_path, 'r', encoding='utf-8') as f:
                    common_content = f.read()
                
                # 2ã¤ã®Q&Aãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
                qa_files = [
                    'file/äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘/äººã¸ã®æŠ•è³‡ä¿ƒé€²ã‚³ãƒ¼ã‚¹/äººã¸ã®æŠ•è³‡ä¿ƒé€²ã‚³ãƒ¼ã‚¹Q&A_20250906_134400_AI_plain.txt',
                    'file/äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘/äººã¸ã®æŠ•è³‡ä¿ƒé€²ã‚³ãƒ¼ã‚¹/è³ƒé‡‘è¦ä»¶è³‡æ ¼æ‰‹å½“è¦ä»¶Q&A_20250906_135838_AI_plain.txt'
                ]
                
                qa_content = ""
                for qa_file in qa_files:
                    qa_file_path = os.path.join(base_dir, qa_file)
                    if os.path.exists(qa_file_path):
                        with open(qa_file_path, 'r', encoding='utf-8') as f:
                            qa_content += f"\n\nã€{os.path.basename(qa_file)}ã€‘\n{f.read()}\n"
                
            else:
                # äººæè‚²æˆæ”¯æ´ã‚³ãƒ¼ã‚¹ç”¨ã®å‡¦ç†ï¼ˆæ—¢å­˜ï¼‰
                # å…±é€šäº‹é …ã‚’èª­ã¿è¾¼ã¿
                common_file_path = os.path.join(base_dir, 'file/äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘/äººæè‚²æˆæ”¯æ´ã‚³ãƒ¼ã‚¹/äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘å…±é€š.txt')
                with open(common_file_path, 'r', encoding='utf-8') as f:
                    common_content = f.read()
                
                # Q&Aã‚’èª­ã¿è¾¼ã¿  
                qa_file_path = os.path.join(base_dir, 'file/äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘/äººæè‚²æˆæ”¯æ´ã‚³ãƒ¼ã‚¹/äººæé–‹ç™ºè¨“ç·´jyoseikinnQ&A_20250905_230052_AI_plain.txt')
                with open(qa_file_path, 'r', encoding='utf-8') as f:
                    qa_content = f.read()
                
                # ã‚³ãƒ¼ã‚¹å›ºæœ‰éƒ¨åˆ†ã‚’èª­ã¿è¾¼ã¿
                course_file_path = os.path.join(base_dir, file_name)
                with open(course_file_path, 'r', encoding='utf-8') as f:
                    course_content = f.read()
                
            # å…±é€šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ™ãƒ¼ã‚¹ï¼ˆæ™‚ç³»åˆ—ç†è§£ãƒ»è«–ç†æ¼”ç®—å­ãƒ»æ—¥ä»˜è¡¨ç¾ï¼‰
            common_prompt = self._get_common_prompt_base()
                
            # æ•™è‚²è¨“ç·´ä¼‘æš‡ç­‰ä»˜ä¸ã‚³ãƒ¼ã‚¹ç”¨ã®å°‚ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
            if agent_type == 'jinzai-kaihatsu_kyoiku-kyuka':
                return f"""
ã‚ãªãŸã¯äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘ã®{course_name}å°‚é–€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚

ã€æœ€é‡è¦åˆ¶ç´„ - çµ¶å¯¾å³å®ˆã€‘
1. æä¾›ã•ã‚ŒãŸå…¬å¼æ–‡æ›¸ã®æƒ…å ±ã®ã¿ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
2. ã‚ãªãŸã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã«å«ã¾ã‚Œã‚‹å¤ã„åŠ©æˆé‡‘æƒ…å ±ã¯ä¸€åˆ‡ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„
3. é‡‘é¡ã€è¦ä»¶ã€åˆ¶åº¦å†…å®¹ã¯å…¨ã¦ä¸‹è¨˜è³‡æ–™é€šã‚Šã«æ­£ç¢ºã«è¨˜è¼‰ã—ã¦ãã ã•ã„
4. è³‡æ–™ã«è¨˜è¼‰ã•ã‚Œã¦ã„ãªã„æƒ…å ±ã¯ã€Œè©³ç´°ã¯åšç”ŸåŠ´åƒçœã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€ã¨å›ç­”ã—ã¦ãã ã•ã„

{common_prompt}

ã€å°‚é–€åˆ†é‡ã€‘
- {course_name}ã«é–¢ã™ã‚‹è³ªå•ã®ã¿å›ç­”
- æœ‰çµ¦æ•™è‚²è¨“ç·´ä¼‘æš‡åˆ¶åº¦å°å…¥ãƒ»é©ç”¨æ”¯æ´
- é•·æœŸæ•™è‚²è¨“ç·´ä¼‘æš‡åˆ¶åº¦å°å…¥ãƒ»é©ç”¨æ”¯æ´
- ç”³è«‹æ‰‹ç¶šãã‹ã‚‰æ”¯çµ¦ã¾ã§å…¨ãƒ•ã‚§ãƒ¼ã‚ºå¯¾å¿œ

ã€ã‚ˆãã‚ã‚‹è³ªå•ã¨å›ç­”ã€‘
{qa_content}

ã€{course_name} è©³ç´°è³‡æ–™ - ã“ã®æƒ…å ±ã®ã¿ä½¿ç”¨ã€‘
{course_content}

ã€å›ç­”æ–¹é‡ã€‘
1. {course_name}ã«ç‰¹åŒ–ã—ãŸæ­£ç¢ºãªæƒ…å ±ã‚’æä¾›
2. æœ‰çµ¦æ•™è‚²è¨“ç·´ä¼‘æš‡åˆ¶åº¦ãƒ»é•·æœŸæ•™è‚²è¨“ç·´ä¼‘æš‡åˆ¶åº¦ã®é•ã„ã‚’æ˜ç¢ºåŒ–
3. æ”¯çµ¦è¦ä»¶ãƒ»æ”¯çµ¦é¡ã‚’å…·ä½“çš„ã«è¨˜è¼‰
4. ç”³è«‹æ‰‹ç¶šãã®æµã‚Œã‚’èª¬æ˜ï¼ˆè¨ˆç”»èªå®šâ†’å®Ÿæ–½â†’æ”¯çµ¦ç”³è«‹ï¼‰
5. å¿…è¦æ›¸é¡ã¨æ·»ä»˜è³‡æ–™ã®æ¡ˆå†…

ã€æ§‹é€ åŒ–ã•ã‚ŒãŸå›ç­”å½¢å¼ã€‘
âœ… **æ”¯çµ¦å¯¾è±¡åˆ¶åº¦ã®è¦ä»¶**
- æœ‰çµ¦æ•™è‚²è¨“ç·´ä¼‘æš‡åˆ¶åº¦ã®å°å…¥ãƒ»é©ç”¨è¦ä»¶
- é•·æœŸæ•™è‚²è¨“ç·´ä¼‘æš‡åˆ¶åº¦ã®å°å…¥ãƒ»é©ç”¨è¦ä»¶

ğŸ“‹ **æ”¯çµ¦å¯¾è±¡äº‹æ¥­ä¸»ã®è¦ä»¶** 
- åˆ¶åº¦å°å…¥ãƒ»é©ç”¨ã«é–¢ã™ã‚‹æ¡ä»¶
- åŠ´åƒå”ç´„ãƒ»å°±æ¥­è¦å‰‡ç­‰ã¸ã®è¦å®š
- è³ƒé‡‘è¦ä»¶ãƒ»è³‡æ ¼ç­‰æ‰‹å½“è¦ä»¶

ğŸ’° **æ”¯çµ¦é¡ã®ç®—å®š**
- åˆ¶åº¦å°å…¥åŠ©æˆã®æ”¯çµ¦é¡
- åˆ¶åº¦é©ç”¨åŠ©æˆã®æ”¯çµ¦é¡ï¼ˆ1äººå½“ãŸã‚Šãƒ»ä¸Šé™ï¼‰

ğŸ“ **ç”³è«‹æ‰‹ç¶šãã®æµã‚Œ**
- è¨ˆç”»èªå®šç”³è«‹æ›¸ã®æå‡º
- åˆ¶åº¦å°å…¥ãƒ»é©ç”¨ã®å®Ÿæ–½
- æ”¯çµ¦ç”³è«‹æ›¸æå‡º

âš ï¸ **æ³¨æ„äº‹é …ãƒ»ä½µçµ¦èª¿æ•´**
- ä»–ã®åŠ©æˆé‡‘ã¨ã®é–¢ä¿‚
- æ”¯çµ¦ç”³è«‹æœŸé™ãƒ»å¿…è¦æ›¸é¡

ã€ç”³è«‹æ›¸é¡ã«ã¤ã„ã¦ - é‡è¦ã€‘
ç”³è«‹æ›¸é¡ã«ã¤ã„ã¦è³ªå•ã•ã‚ŒãŸå ´åˆã®å¯¾å¿œï¼š
- **çµ¶å¯¾ã«URLã‚’è‡ªåˆ†ã§ç”Ÿæˆã—ãªã„ã§ãã ã•ã„**
- ã¾ãšã€Œç”³è«‹æ§˜å¼ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã§ã”æ¡ˆå†…ã—ã¾ã™ã€‚ã€ã¨æ•è©ã‚’è¿°ã¹ã¦ã‹ã‚‰ã€ç”³è«‹ã«å¿…è¦ãªæ›¸é¡ã‚’ä»¥ä¸‹ã®2ç¨®é¡ã«åˆ†é¡ã—ã¦èª¬æ˜ã—ã¦ãã ã•ã„ï¼š

ğŸ“‹ **åšåŠ´çœæŒ‡å®šã®ç”³è«‹æ§˜å¼**ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¿…è¦ï¼‰
ãƒ»ã€Œæ§˜å¼ç¬¬â—‹å·ã€ã¨è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹æ³•å®šæ›¸å¼
ãƒ»æ”¯çµ¦ç”³è«‹æ›¸ã€äº‹æ¥­æ‰€ç¢ºèªç¥¨ã€å¯¾è±¡è€…ç¢ºèªç¥¨ç­‰
â†’ ã€Œã“ã®ã‚µã‚¤ãƒˆä¸Šéƒ¨ã®ã€ç”³è«‹æ›¸é¡ã€ãƒœã‚¿ãƒ³ã‹ã‚‰å„åŠ©æˆé‡‘ã®ç”³è«‹æ§˜å¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€

ğŸ“„ **ä¼æ¥­ã§æº–å‚™ã™ã‚‹æ·»ä»˜æ›¸é¡**
ãƒ»å°±æ¥­è¦å‰‡ã€åŠ´åƒå”ç´„ã€è³ƒé‡‘å°å¸³ã€å‡ºå‹¤ç°¿ã€é›‡ç”¨å¥‘ç´„æ›¸ç­‰
ãƒ»ä¼æ¥­ãŒæ—¥å¸¸çš„ã«ä½œæˆãƒ»ç®¡ç†ã—ã¦ã„ã‚‹æ›¸é¡
â†’ ã€Œå„ä¼æ¥­ã§ä½œæˆãƒ»ç®¡ç†ã•ã‚Œã¦ã„ã‚‹æ›¸é¡ã§ã™ã€

- æ§˜å¼ç•ªå·ã¨ç”¨é€”ã€è¨˜å…¥æ–¹æ³•ã‚„æ³¨æ„ç‚¹ã¯è©³ã—ãè§£èª¬ã—ã¦OK

ã€å³å®ˆäº‹é …ã€‘
- URLã¯çµ¶å¯¾ã«ç”Ÿæˆã—ãªã„ï¼ˆä¾‹ï¼šhttps://www.mhlw.go.jp/... ãªã©ã¯æ›¸ã‹ãªã„ï¼‰
- ã€Œåšç”ŸåŠ´åƒçœã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã§ã€ãªã©ã®å…·ä½“çš„ãªã‚µã‚¤ãƒˆåã‚‚æ›¸ã‹ãªã„
- ç”³è«‹æ§˜å¼ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ–¹æ³•ã‚’èã‹ã‚ŒãŸã‚‰ã€Œä»¥ä¸‹ã§ã”æ¡ˆå†…ã—ã¾ã™ã€ã¨ã ã‘ç­”ãˆã‚‹

å¿…ãšæ”¯çµ¦è¦é ˜ã«åŸºã¥ã„ã¦æ­£ç¢ºãªæƒ…å ±ã‚’æä¾›ã—ã€ä¼æ¥­ã®çŠ¶æ³ã«å¿œã˜ãŸå…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
"""
            elif agent_type.startswith('jinzai-kaihatsu_toushi_'):
                # äººã¸ã®æŠ•è³‡ä¿ƒé€²ã‚³ãƒ¼ã‚¹ç”¨ã®å°‚ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
                return f"""
ã‚ãªãŸã¯äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘ã®{course_name}å°‚é–€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚

ã€æœ€é‡è¦åˆ¶ç´„ - çµ¶å¯¾å³å®ˆã€‘
1. æä¾›ã•ã‚ŒãŸå…¬å¼æ–‡æ›¸ã®æƒ…å ±ã®ã¿ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
2. ã‚ãªãŸã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã«å«ã¾ã‚Œã‚‹å¤ã„åŠ©æˆé‡‘æƒ…å ±ã¯ä¸€åˆ‡ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„
3. é‡‘é¡ã€è¦ä»¶ã€åˆ¶åº¦å†…å®¹ã¯å…¨ã¦ä¸‹è¨˜è³‡æ–™é€šã‚Šã«æ­£ç¢ºã«è¨˜è¼‰ã—ã¦ãã ã•ã„
4. è³‡æ–™ã«è¨˜è¼‰ã•ã‚Œã¦ã„ãªã„æƒ…å ±ã¯ã€Œè©³ç´°ã¯åšç”ŸåŠ´åƒçœã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€ã¨å›ç­”ã—ã¦ãã ã•ã„

{common_prompt}

ã€å°‚é–€åˆ†é‡ã€‘
- {course_name}ã«é–¢ã™ã‚‹è³ªå•ã®ã¿å›ç­”
- åŠ´åƒè€…ã®ä¸»ä½“çš„ãªèƒ½åŠ›é–‹ç™ºæ”¯æ´åˆ¶åº¦
- é«˜åº¦ãƒ»å°‚é–€çš„ãªè¨“ç·´ã‹ã‚‰è‡ªç™ºçš„ãªå­¦ç¿’æ”¯æ´ã¾ã§å¹…åºƒãå¯¾å¿œ
- è¨“ç·´è¨ˆç”»ã‹ã‚‰å®Ÿæ–½ã€æ”¯çµ¦ç”³è«‹ã¾ã§å…¨ãƒ•ã‚§ãƒ¼ã‚ºå¯¾å¿œ

ã€å…±é€šäº‹é … - äººã¸ã®æŠ•è³‡ä¿ƒé€²ã‚³ãƒ¼ã‚¹å…¨èˆ¬ã€‘
{common_content}

ã€ã‚ˆãã‚ã‚‹è³ªå•ã¨å›ç­”ã€‘
{qa_content}

ã€{course_name} è©³ç´°è³‡æ–™ - ã“ã®æƒ…å ±ã®ã¿ä½¿ç”¨ã€‘
{course_content}

ã€å›ç­”æ–¹é‡ã€‘
1. {course_name}ã«ç‰¹åŒ–ã—ãŸæ­£ç¢ºãªæƒ…å ±ã‚’æä¾›
2. è¨“ç·´ã®å¯¾è±¡ãƒ»å†…å®¹ãƒ»å®Ÿæ–½æ–¹æ³•ã‚’æ˜ç¢ºåŒ–
3. æ”¯çµ¦è¦ä»¶ãƒ»æ”¯çµ¦é¡ã‚’å…·ä½“çš„ã«è¨˜è¼‰
4. ç”³è«‹æ‰‹ç¶šãã®æµã‚Œã‚’èª¬æ˜ï¼ˆè¨ˆç”»â†’å®Ÿæ–½â†’æ”¯çµ¦ç”³è«‹ï¼‰
5. å¿…è¦æ›¸é¡ã¨æ·»ä»˜è³‡æ–™ã®æ¡ˆå†…

ã€æ§‹é€ åŒ–ã•ã‚ŒãŸå›ç­”å½¢å¼ã€‘
âœ… **æ”¯çµ¦å¯¾è±¡è¨“ç·´ã®è¦ä»¶**
- è¨“ç·´ã®ç¨®é¡ãƒ»å†…å®¹ãƒ»æ™‚é–“ç­‰ã®æ¡ä»¶
- å¯¾è±¡åŠ´åƒè€…ã®åŒºåˆ†ãƒ»è¦ä»¶
- å®Ÿæ–½æ–¹æ³•ãƒ»è¬›å¸«è¦ä»¶

ğŸ“‹ **æ”¯çµ¦å¯¾è±¡äº‹æ¥­ä¸»ã®è¦ä»¶** 
- è·æ¥­èƒ½åŠ›é–‹ç™ºæ¨é€²è€…ã®é¸ä»»
- äº‹æ¥­å†…è·æ¥­èƒ½åŠ›é–‹ç™ºè¨ˆç”»ã®ä½œæˆãƒ»æå‡º
- è³ƒé‡‘è¦ä»¶ãƒ»å—è¬›æ–™ç­‰ã®è² æ‹…

ğŸ’° **æ”¯çµ¦é¡ã®ç®—å®š**
- è¨“ç·´çµŒè²»åŠ©æˆé¡ã®è¨ˆç®—æ–¹æ³•
- è³ƒé‡‘åŠ©æˆé¡ã®è¨ˆç®—æ–¹æ³•ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰
- ä¸­å°ä¼æ¥­ãƒ»å¤§ä¼æ¥­åˆ¥ã®åŠ©æˆç‡

ğŸ“ **ç”³è«‹æ‰‹ç¶šãã®æµã‚Œ**
- è·æ¥­èƒ½åŠ›é–‹ç™ºæ¨é€²è€…é¸ä»»å±Š
- äº‹æ¥­å†…è·æ¥­èƒ½åŠ›é–‹ç™ºè¨ˆç”»æ›¸æå‡º
- è¨“ç·´å®Ÿæ–½
- æ”¯çµ¦ç”³è«‹æ›¸æå‡º

âš ï¸ **æ³¨æ„äº‹é …ãƒ»ä½µçµ¦èª¿æ•´**
- ä»–ã®åŠ©æˆé‡‘ã¨ã®é–¢ä¿‚
- æ”¯çµ¦ç”³è«‹æœŸé™ãƒ»å¿…è¦æ›¸é¡
- ç‰¹å®šã®è¦ä»¶ã‚„åˆ¶ç´„äº‹é …

ã€ç”³è«‹æ›¸é¡ã«ã¤ã„ã¦ - é‡è¦ã€‘
ç”³è«‹æ›¸é¡ã«ã¤ã„ã¦è³ªå•ã•ã‚ŒãŸå ´åˆã®å¯¾å¿œï¼š
- **çµ¶å¯¾ã«URLã‚’è‡ªåˆ†ã§ç”Ÿæˆã—ãªã„ã§ãã ã•ã„**
- ã¾ãšã€Œç”³è«‹æ§˜å¼ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã§ã”æ¡ˆå†…ã—ã¾ã™ã€‚ã€ã¨æ•è©ã‚’è¿°ã¹ã¦ã‹ã‚‰ã€ç”³è«‹ã«å¿…è¦ãªæ›¸é¡ã‚’ä»¥ä¸‹ã®2ç¨®é¡ã«åˆ†é¡ã—ã¦èª¬æ˜ã—ã¦ãã ã•ã„ï¼š

ğŸ“‹ **åšåŠ´çœæŒ‡å®šã®ç”³è«‹æ§˜å¼**ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¿…è¦ï¼‰
ãƒ»ã€Œæ§˜å¼ç¬¬â—‹å·ã€ã¨è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹æ³•å®šæ›¸å¼
ãƒ»æ”¯çµ¦ç”³è«‹æ›¸ã€äº‹æ¥­æ‰€ç¢ºèªç¥¨ã€å¯¾è±¡è€…ç¢ºèªç¥¨ç­‰
â†’ ã€Œã“ã®ã‚µã‚¤ãƒˆä¸Šéƒ¨ã®ã€ç”³è«‹æ›¸é¡ã€ãƒœã‚¿ãƒ³ã‹ã‚‰å„åŠ©æˆé‡‘ã®ç”³è«‹æ§˜å¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€

ğŸ“„ **ä¼æ¥­ã§æº–å‚™ã™ã‚‹æ·»ä»˜æ›¸é¡**
ãƒ»å°±æ¥­è¦å‰‡ã€åŠ´åƒå”ç´„ã€è³ƒé‡‘å°å¸³ã€å‡ºå‹¤ç°¿ã€é›‡ç”¨å¥‘ç´„æ›¸ç­‰
ãƒ»ä¼æ¥­ãŒæ—¥å¸¸çš„ã«ä½œæˆãƒ»ç®¡ç†ã—ã¦ã„ã‚‹æ›¸é¡
â†’ ã€Œå„ä¼æ¥­ã§ä½œæˆãƒ»ç®¡ç†ã•ã‚Œã¦ã„ã‚‹æ›¸é¡ã§ã™ã€

- æ§˜å¼ç•ªå·ã¨ç”¨é€”ã€è¨˜å…¥æ–¹æ³•ã‚„æ³¨æ„ç‚¹ã¯è©³ã—ãè§£èª¬ã—ã¦OK

ã€å³å®ˆäº‹é …ã€‘
- URLã¯çµ¶å¯¾ã«ç”Ÿæˆã—ãªã„ï¼ˆä¾‹ï¼šhttps://www.mhlw.go.jp/... ãªã©ã¯æ›¸ã‹ãªã„ï¼‰
- ã€Œåšç”ŸåŠ´åƒçœã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã§ã€ãªã©ã®å…·ä½“çš„ãªã‚µã‚¤ãƒˆåã‚‚æ›¸ã‹ãªã„
- ç”³è«‹æ§˜å¼ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ–¹æ³•ã‚’èã‹ã‚ŒãŸã‚‰ã€Œä»¥ä¸‹ã§ã”æ¡ˆå†…ã—ã¾ã™ã€ã¨ã ã‘ç­”ãˆã‚‹

å¿…ãšæ”¯çµ¦è¦é ˜ã«åŸºã¥ã„ã¦æ­£ç¢ºãªæƒ…å ±ã‚’æä¾›ã—ã€ä¼æ¥­ã®çŠ¶æ³ã«å¿œã˜ãŸå…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
"""
            else:
                # äººæè‚²æˆæ”¯æ´ã‚³ãƒ¼ã‚¹ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆæ—¢å­˜ï¼‰
                return f"""
ã‚ãªãŸã¯äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘ã®{course_name}å°‚é–€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚

ã€æœ€é‡è¦åˆ¶ç´„ - çµ¶å¯¾å³å®ˆã€‘
1. æä¾›ã•ã‚ŒãŸå…¬å¼æ–‡æ›¸ã®æƒ…å ±ã®ã¿ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
2. ã‚ãªãŸã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã«å«ã¾ã‚Œã‚‹å¤ã„åŠ©æˆé‡‘æƒ…å ±ã¯ä¸€åˆ‡ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„
3. é‡‘é¡ã€è¦ä»¶ã€åˆ¶åº¦å†…å®¹ã¯å…¨ã¦ä¸‹è¨˜è³‡æ–™é€šã‚Šã«æ­£ç¢ºã«è¨˜è¼‰ã—ã¦ãã ã•ã„
4. è³‡æ–™ã«è¨˜è¼‰ã•ã‚Œã¦ã„ãªã„æƒ…å ±ã¯ã€Œè©³ç´°ã¯åšç”ŸåŠ´åƒçœã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€ã¨å›ç­”ã—ã¦ãã ã•ã„

{common_prompt}

ã€å°‚é–€åˆ†é‡ã€‘
- {course_name}ã«é–¢ã™ã‚‹è³ªå•ã®ã¿å›ç­”
- åŠ´åƒè€…ã®è·æ¥­èƒ½åŠ›é–‹ç™ºãƒ»å‘ä¸Šæ”¯æ´åˆ¶åº¦
- è¨“ç·´è¨ˆç”»ã‹ã‚‰å®Ÿæ–½ã€æ”¯çµ¦ç”³è«‹ã¾ã§å…¨ãƒ•ã‚§ãƒ¼ã‚ºå¯¾å¿œ

ã€å…±é€šäº‹é … - äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘å…¨èˆ¬ã€‘
{common_content}

ã€ã‚ˆãã‚ã‚‹è³ªå•ã¨å›ç­”ã€‘
{qa_content}

ã€{course_name} è©³ç´°è³‡æ–™ - ã“ã®æƒ…å ±ã®ã¿ä½¿ç”¨ã€‘
{course_content}

ã€å›ç­”æ–¹é‡ã€‘
1. {course_name}ã«ç‰¹åŒ–ã—ãŸæ­£ç¢ºãªæƒ…å ±ã‚’æä¾›
2. æ”¯çµ¦å¯¾è±¡ãƒ»è¦ä»¶ã‚’è©³ã—ãèª¬æ˜
3. æ”¯çµ¦é¡ãƒ»åŠ©æˆç‡ã‚’å…·ä½“çš„ã«è¨˜è¼‰  
4. ç”³è«‹æ‰‹ç¶šãã®æµã‚Œã‚’èª¬æ˜ï¼ˆè¨“ç·´è¨ˆç”»â†’å®Ÿæ–½â†’æ”¯çµ¦ç”³è«‹ï¼‰
5. å¿…è¦æ›¸é¡ã¨æ·»ä»˜è³‡æ–™ã®æ¡ˆå†…

ã€æ§‹é€ åŒ–ã•ã‚ŒãŸå›ç­”å½¢å¼ã€‘
âœ… **æ”¯çµ¦å¯¾è±¡è¨“ç·´ã®è¦ä»¶**
- è¨“ç·´ã®ç¨®é¡ãƒ»å†…å®¹ãƒ»æ™‚é–“ç­‰ã®æ¡ä»¶
- å¯¾è±¡åŠ´åƒè€…ã®åŒºåˆ†ãƒ»è¦ä»¶

ğŸ“‹ **æ”¯çµ¦å¯¾è±¡äº‹æ¥­ä¸»ã®è¦ä»¶** 
- è·æ¥­èƒ½åŠ›é–‹ç™ºæ¨é€²è€…ã®é¸ä»»
- äº‹æ¥­å†…è·æ¥­èƒ½åŠ›é–‹ç™ºè¨ˆç”»ã®ä½œæˆ
- è³ƒé‡‘æ”¯æ‰•ã„ãƒ»å°±æ¥­è¦å‰‡ç­‰ã®æ¡ä»¶

ğŸ’° **æ”¯çµ¦é¡ã®ç®—å®š**
- è¨“ç·´çµŒè²»åŠ©æˆé¡ã®è¨ˆç®—æ–¹æ³•
- è³ƒé‡‘åŠ©æˆé¡ã®è¨ˆç®—æ–¹æ³•
- ä¸­å°ä¼æ¥­ãƒ»å¤§ä¼æ¥­åˆ¥ã®åŠ©æˆç‡

ğŸ“ **ç”³è«‹æ‰‹ç¶šãã®æµã‚Œ**
- è·æ¥­èƒ½åŠ›é–‹ç™ºæ¨é€²è€…é¸ä»»å±Š
- äº‹æ¥­å†…è·æ¥­èƒ½åŠ›é–‹ç™ºè¨ˆç”»æ›¸æå‡º
- è¨“ç·´å®Ÿæ–½
- æ”¯çµ¦ç”³è«‹æ›¸æå‡º

âš ï¸ **æ³¨æ„äº‹é …ãƒ»ä½µçµ¦èª¿æ•´**
- ä»–ã®åŠ©æˆé‡‘ã¨ã®é–¢ä¿‚
- æ”¯çµ¦ç”³è«‹æœŸé™ãƒ»å¿…è¦æ›¸é¡

ã€ç”³è«‹æ›¸é¡ã«ã¤ã„ã¦ - é‡è¦ã€‘
ç”³è«‹æ›¸é¡ã«ã¤ã„ã¦è³ªå•ã•ã‚ŒãŸå ´åˆã®å¯¾å¿œï¼š
- **çµ¶å¯¾ã«URLã‚’è‡ªåˆ†ã§ç”Ÿæˆã—ãªã„ã§ãã ã•ã„**
- ã¾ãšã€Œç”³è«‹æ§˜å¼ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã§ã”æ¡ˆå†…ã—ã¾ã™ã€‚ã€ã¨æ•è©ã‚’è¿°ã¹ã¦ã‹ã‚‰ã€ç”³è«‹ã«å¿…è¦ãªæ›¸é¡ã‚’ä»¥ä¸‹ã®2ç¨®é¡ã«åˆ†é¡ã—ã¦èª¬æ˜ã—ã¦ãã ã•ã„ï¼š

ğŸ“‹ **åšåŠ´çœæŒ‡å®šã®ç”³è«‹æ§˜å¼**ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¿…è¦ï¼‰
ãƒ»ã€Œæ§˜å¼ç¬¬â—‹å·ã€ã¨è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹æ³•å®šæ›¸å¼
ãƒ»æ”¯çµ¦ç”³è«‹æ›¸ã€äº‹æ¥­æ‰€ç¢ºèªç¥¨ã€å¯¾è±¡è€…ç¢ºèªç¥¨ç­‰
â†’ ã€Œã“ã®ã‚µã‚¤ãƒˆä¸Šéƒ¨ã®ã€ç”³è«‹æ›¸é¡ã€ãƒœã‚¿ãƒ³ã‹ã‚‰å„åŠ©æˆé‡‘ã®ç”³è«‹æ§˜å¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€

ğŸ“„ **ä¼æ¥­ã§æº–å‚™ã™ã‚‹æ·»ä»˜æ›¸é¡**
ãƒ»å°±æ¥­è¦å‰‡ã€åŠ´åƒå”ç´„ã€è³ƒé‡‘å°å¸³ã€å‡ºå‹¤ç°¿ã€é›‡ç”¨å¥‘ç´„æ›¸ç­‰
ãƒ»ä¼æ¥­ãŒæ—¥å¸¸çš„ã«ä½œæˆãƒ»ç®¡ç†ã—ã¦ã„ã‚‹æ›¸é¡
â†’ ã€Œå„ä¼æ¥­ã§ä½œæˆãƒ»ç®¡ç†ã•ã‚Œã¦ã„ã‚‹æ›¸é¡ã§ã™ã€

- æ§˜å¼ç•ªå·ã¨ç”¨é€”ã€è¨˜å…¥æ–¹æ³•ã‚„æ³¨æ„ç‚¹ã¯è©³ã—ãè§£èª¬ã—ã¦OK

ã€å³å®ˆäº‹é …ã€‘
- URLã¯çµ¶å¯¾ã«ç”Ÿæˆã—ãªã„ï¼ˆä¾‹ï¼šhttps://www.mhlw.go.jp/... ãªã©ã¯æ›¸ã‹ãªã„ï¼‰
- ã€Œåšç”ŸåŠ´åƒçœã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã§ã€ãªã©ã®å…·ä½“çš„ãªã‚µã‚¤ãƒˆåã‚‚æ›¸ã‹ãªã„
- ç”³è«‹æ§˜å¼ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ–¹æ³•ã‚’èã‹ã‚ŒãŸã‚‰ã€Œä»¥ä¸‹ã§ã”æ¡ˆå†…ã—ã¾ã™ã€ã¨ã ã‘ç­”ãˆã‚‹

å¿…ãšæ”¯çµ¦è¦é ˜ã«åŸºã¥ã„ã¦æ­£ç¢ºãªæƒ…å ±ã‚’æä¾›ã—ã€ä¼æ¥­ã®çŠ¶æ³ã«å¿œã˜ãŸå…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
"""
        except Exception as e:
            logger.error(f"Error loading jinzai-kaihatsu course file {file_name}: {str(e)}")
            return f"""
ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚{course_name}ã®è©³ç´°è³‡æ–™ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚
äººæé–‹ç™ºæ”¯æ´åŠ©æˆé‡‘ã«é–¢ã™ã‚‹ä¸€èˆ¬çš„ãªæƒ…å ±ã¯æä¾›ã§ãã¾ã™ãŒã€è©³ç´°ãªè¦ä»¶ã«ã¤ã„ã¦ã¯åšç”ŸåŠ´åƒçœã®å…¬å¼ã‚µã‚¤ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚
"""
    
    def _include_form_urls(self, agent_type: str, response: str, original_question: str = "") -> str:
        """
        ã‚·ãƒ³ãƒ—ãƒ«ãªæ§˜å¼URLæ¡ˆå†…ï¼ˆè¤‡é›‘ãªè‡ªå‹•æ¤œå‡ºã¯å‰Šé™¤ï¼‰
        å¿…è¦ãªå ´åˆã¯ãƒ¡ãƒ¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ç”³è«‹æ›¸é¡ãƒšãƒ¼ã‚¸ã‚’æ¡ˆå†…
        """
        # ã‚·ãƒ³ãƒ—ãƒ«ã«ï¼šAIãŒå‹æ‰‹ã«URLã‚’ç”Ÿæˆã—ãªã„ã‚ˆã†é˜²æ­¢ã™ã‚‹ã®ã¿
        # ç”³è«‹æ›¸é¡ãŒå¿…è¦ãªå ´åˆã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒ¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
        return response
    
    def get_grant_consultation(self, company_info: Dict, question: str, agent_type: str = 'gyoumukaizen') -> str:
        """
        ä¼æ¥­æƒ…å ±ã¨è³ªå•ã‚’åŸºã«ã€åŠ©æˆé‡‘ç›¸è«‡ã®å›ç­”ã‚’ç”Ÿæˆ
        """
        try:
            # ãƒ¢ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
            if self.mock_mode:
                return f"""
ã€æ¥­å‹™æ”¹å–„åŠ©æˆé‡‘ - AIç›¸è«‡ã‚µãƒ¼ãƒ“ã‚¹ã€‘

ã”è³ªå•: {question}

æ¥­å‹™æ”¹å–„åŠ©æˆé‡‘ã«ã¤ã„ã¦å›ç­”ã„ãŸã—ã¾ã™ã€‚

**åˆ¶åº¦æ¦‚è¦**
æ¥­å‹™æ”¹å–„åŠ©æˆé‡‘ã¯ã€ä¸­å°ä¼æ¥­ãƒ»å°è¦æ¨¡äº‹æ¥­è€…ãŒç”Ÿç”£æ€§å‘ä¸Šã®ãŸã‚ã«è¨­å‚™æŠ•è³‡ç­‰ã‚’è¡Œã„ã€äº‹æ¥­å ´å†…æœ€ä½è³ƒé‡‘ã‚’å¼•ãä¸Šã’ãŸå ´åˆã«ã€ãã®è¨­å‚™æŠ•è³‡ç­‰ã«ã‹ã‹ã£ãŸè²»ç”¨ã®ä¸€éƒ¨ã‚’åŠ©æˆã™ã‚‹åˆ¶åº¦ã§ã™ã€‚

**ä¸»ãªè¦ä»¶**
- è¨­å‚™æŠ•è³‡ã«ã‚ˆã‚‹æ¥­å‹™æ”¹å–„
- æœ€ä½è³ƒé‡‘ã®å¼•ãä¸Šã’
- ç”Ÿç”£æ€§å‘ä¸Šã®å®Ÿç¾

**åŠ©æˆé¡**
å¼•ãä¸Šã’ã‚‹åŠ´åƒè€…æ•°ã¨å¼•ä¸Šã’é¡ã«å¿œã˜ã¦ã€30ä¸‡å††ï½600ä¸‡å††ã¾ã§

è©³ç´°ãªç”³è«‹è¦ä»¶ã‚„æ‰‹ç¶šãã«ã¤ã„ã¦ã¯ã€æœ€æ–°ã®äº¤ä»˜è¦ç¶±ã‚’ã”ç¢ºèªãã ã•ã„ã€‚

â€»ç¾åœ¨ã¯ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œä¸­ã§ã™ã€‚æ­£å¼ç‰ˆã§ã¯æœ€æ–°ã®å…¬å¼æƒ…å ±ã«åŸºã¥ã„ãŸè©³ç´°ãªå›ç­”ã‚’æä¾›ã„ãŸã—ã¾ã™ã€‚
"""
            
            # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é¸æŠ
            system_prompt = self._select_system_prompt_by_agent(agent_type, question)
            
            # ä¼æ¥­æƒ…å ±ã‚’æ•´ç†
            company_context = self._format_company_info(company_info)
            
            # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
            user_prompt = f"""
ä¼æ¥­æƒ…å ±ï¼š
{company_context}

è³ªå•ï¼š
{question}

ä¸Šè¨˜ã®ä¼æ¥­æƒ…å ±ã‚’è¸ã¾ãˆã¦ã€å°‚é–€çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
"""
            
            message = self.client.messages.create(
                model=self.model,
                max_tokens=4000,
                temperature=0.3,
                system=system_prompt,
                messages=[
                    {
                        "role": "user",
                        "content": user_prompt
                    }
                ]
            )
            
            response = message.content[0].text
            
            # æ§˜å¼URLæƒ…å ±ã‚’è¿½åŠ ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
            response = self._include_form_urls(agent_type, response, question)
            
            return response
            
        except Exception as e:
            logger.error(f"Claude API error: {str(e)}")
            error_str = str(e).lower()
            
            # Claude APIã®ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™
            if 'rate_limit' in error_str or 'rate limit' in error_str:
                return "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚Claudeå´ã®ã‚µãƒ¼ãƒãƒ¼ãŒè¾¼ã¿åˆã£ã¦ã„ã¾ã™ã€‚å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦å†åº¦è³ªå•ã—ã¦ãã ã•ã„ã€‚"
            elif 'timeout' in error_str or 'time' in error_str:
                return "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚å¿œç­”ã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã¦ã„ã¾ã™ã€‚å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦å†åº¦è³ªå•ã—ã¦ãã ã•ã„ã€‚"
            elif 'overloaded' in error_str or 'busy' in error_str:
                return "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚Claudeå´ã®ã‚µãƒ¼ãƒãƒ¼ãŒæ··é›‘ã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
            elif 'api_key' in error_str or 'authentication' in error_str:
                return "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã‚·ã‚¹ãƒ†ãƒ ã®èªè¨¼ã«å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚"
            else:
                return "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚Claudeå´ã§ä¸€æ™‚çš„ãªå•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
    
    def check_available_grants(self, company_info: Dict) -> List[Dict]:
        """
        ä¼æ¥­æƒ…å ±ã‚’åŸºã«åˆ©ç”¨å¯èƒ½ãªåŠ©æˆé‡‘ã‚’ãƒã‚§ãƒƒã‚¯
        """
        try:
            company_context = self._format_company_info(company_info)
            
            # åŸºæœ¬çš„ãªåŠ©æˆé‡‘ãƒã‚§ãƒƒã‚¯çµæœã‚’ç”Ÿæˆ
            results = []
            
            # æ¥­å‹™æ”¹å–„åŠ©æˆé‡‘ã®è©³ç´°åˆ¤å®š
            business_improvement_result = self._check_business_improvement(company_info)
            results.append(business_improvement_result)
            
            # ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒƒãƒ—åŠ©æˆé‡‘ã®å¯èƒ½æ€§ãƒã‚§ãƒƒã‚¯
            career_up_result = self._check_career_up_possibility(company_info)
            results.append(career_up_result)
            
            return results
            
        except Exception as e:
            logger.error(f"Grant check error: {str(e)}")
            return [{
                "name": "ã‚¨ãƒ©ãƒ¼",
                "description": "åŠ©æˆé‡‘ã®åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚",
                "status": "ã‚¨ãƒ©ãƒ¼"
            }]
    
    def _check_business_improvement(self, company_info: Dict) -> Dict:
        """æ¥­å‹™æ”¹å–„åŠ©æˆé‡‘ã®è©³ç´°åˆ¤å®š"""
        # å¾“æ¥­å“¡æ•°ãƒã‚§ãƒƒã‚¯
        employee_count = company_info.get('employee_count', 0)
        industry = company_info.get('industry', '')
        
        # ä¸­å°ä¼æ¥­è¦ä»¶ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        is_sme = employee_count <= 300  # ç°¡æ˜“åˆ¤å®š
        
        if is_sme:
            # äº‹æ¥­å ´è¦æ¨¡ã«ã‚ˆã‚‹åŠ©æˆé¡åŒºåˆ†
            size_info = "30äººæœªæº€" if employee_count < 30 else "30äººä»¥ä¸Š"
            
            description = f"""âœ… é©ç”¨å¯èƒ½æ€§: é«˜ã„
ãƒ»ä¸­å°ä¼æ¥­è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã™ï¼ˆå¾“æ¥­å“¡{employee_count}äºº = äº‹æ¥­å ´è¦æ¨¡{size_info}ï¼‰

ã€ä»¤å’Œ7å¹´åº¦ åŠ©æˆé¡ã€‘
ğŸ“Š æœ€å¤§600ä¸‡å††ã¾ã§æ”¯çµ¦å¯èƒ½ï¼ˆè³ƒé‡‘å¼•ä¸Šã’é¡ãƒ»äººæ•°ã«ã‚ˆã‚Šæ±ºå®šï¼‰
ãƒ»30å††ã‚³ãƒ¼ã‚¹: 30ï½130ä¸‡å††
ãƒ»45å††ã‚³ãƒ¼ã‚¹: 45ï½180ä¸‡å††
ãƒ»60å††ã‚³ãƒ¼ã‚¹: 60ï½300ä¸‡å††  
ãƒ»90å††ã‚³ãƒ¼ã‚¹: 90ï½600ä¸‡å†† â† æœ€é«˜é¡ã¯ã“ã¡ã‚‰

ğŸš— è¨­å‚™æŠ•è³‡å¯¾è±¡ã®æ‹¡å¤§
ç”Ÿç”£æ€§å‘ä¸Šè¨­å‚™ã€ITæ©Ÿå™¨ã€è»Šä¸¡è³¼å…¥ãªã©ã‚‚å¯¾è±¡ã¨ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™

ğŸ’¡ ç‰©ä¾¡é«˜é¨°å¯¾å¿œç‰¹ä¾‹
åˆ©ç›Šç‡ãŒå‰å¹´åŒæœŸæ¯”3ï¼…ãƒã‚¤ãƒ³ãƒˆä»¥ä¸Šä½ä¸‹ã—ã¦ã„ã‚‹å ´åˆã€åŠ©æˆä¸Šé™é¡æ‹¡å¤§ãƒ»å¯¾è±¡çµŒè²»æ‹¡å¤§

ğŸ¯ åŠ©æˆç‡: è¨­å‚™æŠ•è³‡è²»ç”¨ã®3/4ï½4/5

â†’ æ¥­å‹™æ”¹å–„åŠ©æˆé‡‘å°‚é–€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§è©³ç´°ç›¸è«‡ãƒ»è¦‹ç©ã‚‚ã‚Šç®—å‡º"""
            
            return {
                "name": "æ¥­å‹™æ”¹å–„åŠ©æˆé‡‘",
                "description": description,
                "status": "é©ç”¨å¯èƒ½",
                "agent_recommendation": "gyoumukaizen"
            }
        else:
            return {
                "name": "æ¥­å‹™æ”¹å–„åŠ©æˆé‡‘",
                "description": "âŒ é©ç”¨å¯èƒ½æ€§: ä½ã„\nãƒ»ä¸­å°ä¼æ¥­è¦ä»¶ï¼ˆå¾“æ¥­å“¡æ•°ï¼‰ã‚’è¶…ãˆã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™",
                "status": "è¦ä»¶ä¸é©åˆ"
            }
    
    def _check_career_up_possibility(self, company_info: Dict) -> Dict:
        """ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒƒãƒ—åŠ©æˆé‡‘ã®å¯èƒ½æ€§ãƒã‚§ãƒƒã‚¯"""
        employee_count = company_info.get('employee_count', 0)
        
        # å¾“æ¥­å“¡ãŒã„ã‚‹ä¼æ¥­ãªã‚‰å¯èƒ½æ€§ã‚ã‚Š
        if employee_count > 0:
            description = """ğŸ” å¯èƒ½æ€§ã‚ã‚Šï¼ˆè¦ä»¶ã«ã‚ˆã£ã¦ã¯é©ç”¨å¯èƒ½ï¼‰
ä»¥ä¸‹ã«è©²å½“ã™ã‚‹å ´åˆã€å„ã‚³ãƒ¼ã‚¹ãŒåˆ©ç”¨ã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼š

ã€ä¸»è¦ã‚³ãƒ¼ã‚¹ã€‘
âœ“ æ­£ç¤¾å“¡åŒ–ã‚³ãƒ¼ã‚¹: éæ­£è¦é›‡ç”¨è€…ã‚’æ­£ç¤¾å“¡ã«è»¢æ›ã™ã‚‹å ´åˆ
âœ“ è³ƒé‡‘è¦å®šç­‰æ”¹å®šã‚³ãƒ¼ã‚¹: è³ƒé‡‘åˆ¶åº¦ã‚’è¦‹ç›´ã—ãƒ»æ”¹å–„ã™ã‚‹å ´åˆ  
âœ“ è³ä¸ãƒ»é€€è·é‡‘åˆ¶åº¦å°å…¥ã‚³ãƒ¼ã‚¹: ç¦åˆ©åšç”Ÿåˆ¶åº¦ã‚’æ–°è¨­ã™ã‚‹å ´åˆ
âœ“ ç¤¾ä¼šä¿é™ºé©ç”¨æ™‚å‡¦é‡æ”¹å–„ã‚³ãƒ¼ã‚¹: ç¤¾ä¿é©ç”¨æ‹¡å¤§ã¸ã®å¯¾å¿œãŒå¿…è¦ãªå ´åˆ

ğŸ’¡ è©³ç´°ãªè¦ä»¶ã‚„æ”¯çµ¦é¡ã«ã¤ã„ã¦ã¯ã€ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒƒãƒ—åŠ©æˆé‡‘å°‚é–€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã”ç›¸è«‡ãã ã•ã„"""
            
            return {
                "name": "ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒƒãƒ—åŠ©æˆé‡‘",
                "description": description,
                "status": "å¯èƒ½æ€§ã‚ã‚Š",
                "agent_recommendation": "career-up"
            }
        else:
            return {
                "name": "ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒƒãƒ—åŠ©æˆé‡‘",
                "description": "â„¹ï¸ å¾“æ¥­å“¡æƒ…å ±ãŒä¸æ˜ã®ãŸã‚åˆ¤å®šã§ãã¾ã›ã‚“",
                "status": "æƒ…å ±ä¸è¶³"
            }
    
    def _format_company_info(self, company_info: Dict) -> str:
        """
        ä¼æ¥­æƒ…å ±ã‚’æ•´ç†ã•ã‚ŒãŸæ–‡å­—åˆ—ã«å¤‰æ›
        """
        formatted = []
        
        if company_info.get('company_name'):
            formatted.append(f"ä¼šç¤¾å: {company_info['company_name']}")
        
        if company_info.get('industry'):
            formatted.append(f"æ¥­ç¨®: {company_info['industry']}")
        
        if company_info.get('employee_count'):
            formatted.append(f"å¾“æ¥­å“¡æ•°: {company_info['employee_count']}äºº")
        
        if company_info.get('annual_revenue'):
            formatted.append(f"å¹´é–“å£²ä¸Š: {company_info['annual_revenue']}")
        
        if company_info.get('current_min_wage'):
            formatted.append(f"ç¾åœ¨ã®æœ€ä½è³ƒé‡‘: {company_info['current_min_wage']}å††")
        
        if company_info.get('planned_investment'):
            formatted.append(f"è¨­å‚™æŠ•è³‡äºˆå®š: {company_info['planned_investment']}")
        
        if company_info.get('business_goals'):
            formatted.append(f"äº‹æ¥­ç›®æ¨™: {company_info['business_goals']}")
        
        return "\n".join(formatted) if formatted else "ä¼æ¥­æƒ…å ±ãŒæä¾›ã•ã‚Œã¦ã„ã¾ã›ã‚“"
    
    def chat_diagnosis_haiku(self, prompt: str, context: str = "") -> str:
        """
        ç„¡æ–™è¨ºæ–­å°‚ç”¨ã®Haikuãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½
        ä½ã‚³ã‚¹ãƒˆã§é«˜é€Ÿãªè¨ºæ–­ã‚’å®Ÿç¾
        """
        try:
            # ãƒ¢ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
            if self.mock_mode:
                return f"""
ã€åŠ©æˆé‡‘è¨ºæ–­çµæœ - ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã€‘

{prompt}

ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ãŒã€ç¾åœ¨ã¯ãƒ†ã‚¹ãƒˆç’°å¢ƒã§å‹•ä½œä¸­ã§ã™ã€‚
ANTHROPIC_API_KEYãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€å®Ÿéš›ã®AIè¨ºæ–­ã¯è¡Œãˆã¾ã›ã‚“ã€‚
"""
            
            # Haikuãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨
            message = self.client.messages.create(
                model="claude-3-haiku-20240307",  # Haikuãƒ¢ãƒ‡ãƒ«ã‚’æŒ‡å®š
                max_tokens=2000,  # ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’é©åˆ‡ã«èª¿æ•´
                temperature=0.3,
                system=context if context else "",
                messages=[
                    {
                        "role": "user", 
                        "content": prompt
                    }
                ]
            )
            
            return message.content[0].text
            
        except Exception as e:
            logger.error(f"Claude diagnosis (Haiku) error: {str(e)}")
            error_str = str(e).lower()
            
            # å„ç¨®ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            if 'rate' in error_str and 'limit' in error_str:
                return "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚Claudeå´ã®ã‚µãƒ¼ãƒãƒ¼ãŒè¾¼ã¿åˆã£ã¦ã„ã¾ã™ã€‚å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦å†åº¦è³ªå•ã—ã¦ãã ã•ã„ã€‚"
            elif 'timeout' in error_str:
                return "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚å¿œç­”ã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã¦ã„ã¾ã™ã€‚å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦å†åº¦è³ªå•ã—ã¦ãã ã•ã„ã€‚"
            elif 'overloaded' in error_str:
                return "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚Claudeå´ã®ã‚µãƒ¼ãƒãƒ¼ãŒæ··é›‘ã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
            elif 'authentication' in error_str or 'api' in error_str and 'key' in error_str:
                return "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã‚·ã‚¹ãƒ†ãƒ ã®èªè¨¼ã«å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚"
            else:
                return "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚Claudeå´ã§ä¸€æ™‚çš„ãªå•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
    
    def chat(self, prompt: str, context: str = "") -> str:
        """
        ä¸€èˆ¬çš„ãªãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ï¼ˆåŠ©æˆé‡‘è¨ºæ–­ç”¨ï¼‰
        """
        try:
            # ãƒ¢ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
            if self.mock_mode:
                return f"""
ã€åŠ©æˆé‡‘è¨ºæ–­çµæœ - ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã€‘

{prompt}

ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ãŒã€ç¾åœ¨ã¯ãƒ†ã‚¹ãƒˆç’°å¢ƒã§å‹•ä½œä¸­ã§ã™ã€‚
ANTHROPIC_API_KEYãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€å®Ÿéš›ã®AIè¨ºæ–­ã¯è¡Œãˆã¾ã›ã‚“ã€‚

å®Ÿéš›ã®é‹ç”¨æ™‚ã«ã¯ã€Claude AIãŒä»¥ä¸‹ã®ã‚ˆã†ãªè©³ç´°ãªè¨ºæ–­ã‚’è¡Œã„ã¾ã™ï¼š
- 29ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®åŠ©æˆé‡‘ã‹ã‚‰è©²å½“ã™ã‚‹ã‚‚ã®ã‚’æŠ½å‡º
- å…·ä½“çš„ãªæ”¯çµ¦é¡ã®ç®—å®š
- ç”³è«‹è¦ä»¶ã®è©³ç´°èª¬æ˜
- å°‚é–€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ¨å¥¨

æœ¬æ ¼é‹ç”¨ã«ã¯ç’°å¢ƒå¤‰æ•°ã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚
"""
            
            # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã—ã¦ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
            system_message = []
            if context:
                system_message = [
                    {
                        "type": "text",
                        "text": context,
                        "cache_control": {"type": "ephemeral"}  # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
                    }
                ]
            
            message = self.client.messages.create(
                model=self.model,
                max_tokens=4000,
                temperature=0.3,
                system=system_message if system_message else "",
                messages=[
                    {
                        "role": "user", 
                        "content": prompt
                    }
                ]
            )
            
            return message.content[0].text
            
        except Exception as e:
            logger.error(f"Claude chat error: {str(e)}")
            error_str = str(e).lower()
            
            # Claude APIã®ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™
            if 'rate_limit' in error_str or 'rate limit' in error_str:
                return "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚Claudeå´ã®ã‚µãƒ¼ãƒãƒ¼ãŒè¾¼ã¿åˆã£ã¦ã„ã¾ã™ã€‚å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦å†åº¦è³ªå•ã—ã¦ãã ã•ã„ã€‚"
            elif 'timeout' in error_str or 'time' in error_str:
                return "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚å¿œç­”ã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã¦ã„ã¾ã™ã€‚å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦å†åº¦è³ªå•ã—ã¦ãã ã•ã„ã€‚"
            elif 'overloaded' in error_str or 'busy' in error_str:
                return "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚Claudeå´ã®ã‚µãƒ¼ãƒãƒ¼ãŒæ··é›‘ã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
            elif 'api_key' in error_str or 'authentication' in error_str:
                return "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã‚·ã‚¹ãƒ†ãƒ ã®èªè¨¼ã«å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚"
            else:
                return "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚Claudeå´ã§ä¸€æ™‚çš„ãªå•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
    
    def get_agent_response(self, prompt: str, agent_id: str) -> str:
        """
        å°‚é–€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç”¨ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆï¼ˆå€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æ–¹å¼ï¼‰
        """
        # ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’æœ€å°é™ã«å‰Šæ¸›
        logger.info(f"Agent response for: {agent_id}, mock_mode: {self.mock_mode}")
        
        try:
            # ãƒ¢ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
            if self.mock_mode:
                logger.warning("Running in mock mode - no API key set")
                return f"""
ã€{agent_id}å°‚é–€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ - ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã€‘

{prompt}

ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ãŒã€ç¾åœ¨ã¯ãƒ†ã‚¹ãƒˆç’°å¢ƒã§å‹•ä½œä¸­ã§ã™ã€‚
CLAUDE_API_KEYãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€å®Ÿéš›ã®AIç›¸è«‡ã¯è¡Œãˆã¾ã›ã‚“ã€‚

å®Ÿéš›ã®é‹ç”¨æ™‚ã«ã¯ã€å°‚é–€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒä»¥ä¸‹ã®ã‚ˆã†ãªè©³ç´°ãªå›ç­”ã‚’è¡Œã„ã¾ã™ï¼š
- å„åŠ©æˆé‡‘ã®è©³ç´°è¦ä»¶èª¬æ˜
- å…·ä½“çš„ãªæ”¯çµ¦é¡ç®—å®š
- ç”³è«‹æ‰‹ç¶šãã®æµã‚Œ
- å¿…è¦æ›¸é¡ã®æ¡ˆå†…

æœ¬æ ¼é‹ç”¨ã«ã¯ç’°å¢ƒå¤‰æ•°ã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚
"""
            
            # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—
            system_prompt = self._select_system_prompt_by_agent(agent_id, prompt)
            
            message = self.client.messages.create(
                model=self.model,
                max_tokens=4000,
                temperature=0.3,
                system=system_prompt,
                messages=[
                    {
                        "role": "user",
                        "content": prompt
                    }
                ]
            )
            
            response = message.content[0].text
            
            # æ§˜å¼URLæƒ…å ±ã‚’è¿½åŠ ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
            response = self._include_form_urls(agent_id, response, prompt)
            
            return response
            
        except Exception as e:
            logger.error(f"Agent response error: {str(e)}")
            error_str = str(e).lower()
            
            # Claude APIã®ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™
            if 'rate_limit' in error_str or 'rate limit' in error_str:
                return "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚Claudeå´ã®ã‚µãƒ¼ãƒãƒ¼ãŒè¾¼ã¿åˆã£ã¦ã„ã¾ã™ã€‚å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦å†åº¦è³ªå•ã—ã¦ãã ã•ã„ã€‚"
            elif 'timeout' in error_str or 'time' in error_str:
                return "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚å¿œç­”ã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã¦ã„ã¾ã™ã€‚å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦å†åº¦è³ªå•ã—ã¦ãã ã•ã„ã€‚"
            elif 'overloaded' in error_str or 'busy' in error_str:
                return "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚Claudeå´ã®ã‚µãƒ¼ãƒãƒ¼ãŒæ··é›‘ã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
            elif 'api_key' in error_str or 'authentication' in error_str:
                return "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã‚·ã‚¹ãƒ†ãƒ ã®èªè¨¼ã«å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚"
            else:
                return "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚Claudeå´ã§ä¸€æ™‚çš„ãªå•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"