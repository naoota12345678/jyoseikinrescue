# 2025-09-18 å°‚é–€å®¶ç›¸è«‡äºˆç´„ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆã‚»ãƒƒã‚·ãƒ§ãƒ³

## ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¦‚è¦
- **æ—¥æ™‚**: 2025-09-18
- **è¦æ±‚**: å°‚é–€å®¶ç›¸è«‡ï¼ˆ30åˆ†14,300å††ï¼‰ã®æ”¯æ‰•ã„ãƒ»äºˆç´„ãƒ•ãƒ­ãƒ¼æ§‹ç¯‰
- **æ–¹é‡**: å††å±±å‹•ç‰©ç—…é™¢ã‚·ã‚¹ãƒ†ãƒ ã®æ‰‹æ³•ã‚’å‚è€ƒã«ã—ãŸå®Ÿè£…

## èª²é¡Œåˆ†æ

### ç¾åœ¨ã®çŠ¶æ³
- å°‚é–€å®¶ç›¸è«‡ã‚·ã‚¹ãƒ†ãƒ ã¯æ±ºæ¸ˆã®ã¿å®Ÿè£…æ¸ˆã¿
- æ±ºæ¸ˆå¾Œã®äºˆç´„ç®¡ç†æ©Ÿèƒ½ãŒæœªå®Ÿè£…
- é¡§å®¢ã¯æ±ºæ¸ˆå¾Œã«åˆ¥é€”äºˆç´„ã‚’å–ã‚‹å¿…è¦ãŒã‚ã‚‹

### è¦æ±‚ã•ã‚Œã‚‹æ©Ÿèƒ½
1. æ±ºæ¸ˆ â†’ äºˆç´„ã®ä¸€é€£ãƒ•ãƒ­ãƒ¼
2. Calendlyé€£æºã«ã‚ˆã‚‹äºˆç´„ç®¡ç†
3. ç®¡ç†è€…ã«ã‚ˆã‚‹äºˆç´„ç¢ºèªæ©Ÿèƒ½
4. è‡ªå‹•åŒ–ã•ã‚ŒãŸZoom URLé€ä¿¡ï¼ˆå°†æ¥å®Ÿè£…ï¼‰

## è¨­è¨ˆæ¡ˆæ¤œè¨

### å‚è€ƒã‚·ã‚¹ãƒ†ãƒ : å††å±±å‹•ç‰©ç—…é™¢
**å„ªã‚ŒãŸç‚¹**:
1. æ±ºæ¸ˆ â†’ äºˆç´„ã®æ˜ç¢ºãª2æ®µéšãƒ•ãƒ­ãƒ¼
2. Calendlyé€£æºã«ã‚ˆã‚‹äºˆç´„ç®¡ç†
3. Firestoreã§ã®äºˆç´„æƒ…å ±ç®¡ç†
4. ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã®äºˆç´„ç¢ºèª

### ææ¡ˆã™ã‚‹3ã¤ã®å®Ÿè£…æ¡ˆ

#### æ¡ˆ1: æœ€å°é™å®Ÿè£…ï¼ˆæ¨å¥¨ï¼‰ ğŸ¯

**ãƒ•ãƒ­ãƒ¼**:
```
ç¾åœ¨: å°‚é–€å®¶ç›¸è«‡ãƒšãƒ¼ã‚¸ â†’ æ”¯æ‰•ã„ãƒ»ã”äºˆç´„ã«é€²ã‚€ â†’ Stripeæ±ºæ¸ˆ
     â†“
æ”¹è‰¯: å°‚é–€å®¶ç›¸è«‡ãƒšãƒ¼ã‚¸ â†’ æ”¯æ‰•ã„ãƒ»ã”äºˆç´„ã«é€²ã‚€ â†’ Stripeæ±ºæ¸ˆ â†’ Calendlyäºˆç´„ç”»é¢
```

**å®Ÿè£…æ–¹æ³•**:
```python
# æ—¢å­˜ã®æ±ºæ¸ˆæˆåŠŸãƒšãƒ¼ã‚¸ã‚’æ‹¡å¼µ
@app.route('/consultation/payment-success')
def consultation_payment_success():
    session_id = request.args.get('session_id')

    # æ±ºæ¸ˆæƒ…å ±ã‚’ç¢ºèª
    session = stripe.checkout.Session.retrieve(session_id)

    # äºˆç´„æƒ…å ±ã‚’Firestoreã«ä¿å­˜
    appointment_data = {
        'user_id': current_user['user_id'],
        'user_email': current_user['email'],
        'payment_session_id': session_id,
        'amount': 14300,
        'status': 'payment_completed',
        'booking_status': 'pending',  # äºˆç´„å¾…ã¡
        'created_at': datetime.now()
    }

    save_appointment_data(appointment_data)

    # Calendlyã®URLã‚’è¡¨ç¤º
    return render_template('consultation_payment_success.html',
                         calendly_url="https://calendly.com/your-account/30min",
                         appointment_id=appointment_data['id'])
```

#### æ¡ˆ2: å††å±±å‹•ç‰©ç—…é™¢æ–¹å¼ ğŸ¥

**ãƒ•ãƒ­ãƒ¼**:
```
1. æ±ºæ¸ˆå®Œäº†
   â†“
2. äºˆç´„æƒ…å ±ã‚’Firestoreã«ä¿å­˜
   â†“
3. CalendlyåŸ‹ã‚è¾¼ã¿ç”»é¢è¡¨ç¤º
   â†“
4. é¡§å®¢ãŒæ—¥æ™‚é¸æŠ
   â†“
5. Calendly Webhook â†’ äºˆç´„ç¢ºå®š
   â†“
6. Zoom URLè‡ªå‹•é€ä¿¡
```

**å®Ÿè£…æ–¹æ³•**:
```python
# Calendly Webhookå‡¦ç†
@app.route('/webhook/calendly', methods=['POST'])
def calendly_webhook():
    event = request.json

    if event['event'] == 'invitee.created':
        # äºˆç´„ç¢ºå®šå‡¦ç†
        invitee_email = event['payload']['email']
        event_start_time = event['payload']['start_time']

        # Firestoreã®appointmentã‚’Calendlyæƒ…å ±ã§æ›´æ–°
        update_appointment_with_calendly_data(
            invitee_email,
            event['payload']
        )

        # Zoom URLé€ä¿¡
        send_zoom_url_email(invitee_email, event_start_time)

    return jsonify({'status': 'success'})
```

#### æ¡ˆ3: ã‚·ãƒ³ãƒ—ãƒ«çµ±åˆç‰ˆ âš¡

**ãƒ•ãƒ­ãƒ¼**:
```
1. å°‚é–€å®¶ç›¸è«‡ãƒšãƒ¼ã‚¸
   â†“
2. ã€Œæ”¯æ‰•ã„ãƒ»ã”äºˆç´„ã«é€²ã‚€ã€
   â†“
3. Stripeæ±ºæ¸ˆ
   â†“
4. æ±ºæ¸ˆæˆåŠŸãƒšãƒ¼ã‚¸ã«CalendlyåŸ‹ã‚è¾¼ã¿è¡¨ç¤º
   â†“
5. ãã®å ´ã§äºˆç´„å®Œäº†
```

**UIè¨­è¨ˆ**:
```html
<!-- æ±ºæ¸ˆæˆåŠŸãƒšãƒ¼ã‚¸ã«è¿½åŠ  -->
<div class="payment-success-container">
    <h2>âœ… æ±ºæ¸ˆå®Œäº†</h2>
    <p>ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ç¶šã„ã¦é¢è«‡æ—¥æ™‚ã‚’ã”é¸æŠãã ã•ã„ã€‚</p>

    <!-- CalendlyåŸ‹ã‚è¾¼ã¿ -->
    <div class="calendly-inline-widget"
         data-url="https://calendly.com/your-account/30min"
         style="min-width:320px;height:700px;">
    </div>

    <script src="https://assets.calendly.com/assets/external/widget.js"></script>
</div>
```

## æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¸ã®å½±éŸ¿åˆ†æ

### âœ… æ—¢å­˜æ©Ÿèƒ½ã¸ã®å½±éŸ¿ã‚¼ãƒ­ã®ç†ç”±

1. **å®Œå…¨ã«ç‹¬ç«‹ã—ãŸæ–°æ©Ÿèƒ½è¿½åŠ **
```python
# æ—¢å­˜ï¼ˆå¤‰æ›´ãªã—ï¼‰
@app.route('/api/payment/consultation', methods=['POST'])  # æ—¢å­˜ã®æ±ºæ¸ˆAPI
@app.route('/consultation/payment-success')  # æ—¢å­˜ã®æˆåŠŸãƒšãƒ¼ã‚¸

# æ–°è¦è¿½åŠ ï¼ˆæ—¢å­˜ã¨åˆ†é›¢ï¼‰
@app.route('/webhook/calendly', methods=['POST'])  # æ–°è¦Webhook
@app.route('/admin/appointments')  # æ–°è¦ç®¡ç†ç”»é¢
```

2. **æ—¢å­˜ã®Stripeæ±ºæ¸ˆãƒ•ãƒ­ãƒ¼ã¯å®Œå…¨ä¿æŒ**
```
# ç¾åœ¨ã®å‹•ä½œï¼ˆå¤‰æ›´ãªã—ï¼‰
1. å°‚é–€å®¶ç›¸è«‡ãƒšãƒ¼ã‚¸
2. ã€Œæ”¯æ‰•ã„ãƒ»ã”äºˆç´„ã«é€²ã‚€ã€ãƒœã‚¿ãƒ³
3. Stripeæ±ºæ¸ˆï¼ˆ/api/payment/consultationï¼‰
4. æ±ºæ¸ˆæˆåŠŸãƒšãƒ¼ã‚¸è¡¨ç¤º

# æ–°è¦è¿½åŠ ï¼ˆæ—¢å­˜ãƒ•ãƒ­ãƒ¼ã®å¾Œã«è¿½åŠ ï¼‰
5. + Calendlyäºˆç´„ç”»é¢è¡¨ç¤º  # ğŸ‘ˆ æ–°æ©Ÿèƒ½ã®ã¿è¿½åŠ 
6. + äºˆç´„æƒ…å ±ã‚’Firestoreã«ä¿å­˜  # ğŸ‘ˆ æ–°æ©Ÿèƒ½ã®ã¿è¿½åŠ 
```

3. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ ã‚‚å®‰å…¨**
```
// æ—¢å­˜ã®Firestoreã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå¤‰æ›´ãªã—ï¼‰
users/        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
subscriptions/  // ã‚µãƒ–ã‚¹ã‚¯æƒ…å ±
payments/     // æ±ºæ¸ˆæƒ…å ±

// æ–°è¦è¿½åŠ ã®ã¿
appointments/  // ğŸ‘ˆ æ–°ã—ã„ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
```

## æ¨å¥¨å®Ÿè£…é †åº ğŸ“‹

### Phase 1: åŸºæœ¬äºˆç´„æ©Ÿèƒ½
1. æ±ºæ¸ˆæˆåŠŸãƒšãƒ¼ã‚¸ã«CalendlyåŸ‹ã‚è¾¼ã¿ï¼ˆæ¡ˆ3ï¼‰
2. äºˆç´„æƒ…å ±ã®Firestoreä¿å­˜
3. ç®¡ç†è€…äºˆç´„ç¢ºèªç”»é¢

### Phase 2: é«˜åº¦ãªæ©Ÿèƒ½
1. Calendly Webhooké€£æºï¼ˆæ¡ˆ2ï¼‰
2. è‡ªå‹•Zoom URLé€ä¿¡
3. äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ©Ÿèƒ½

### Phase 3: ç®¡ç†æ©Ÿèƒ½å¼·åŒ–
1. ç®¡ç†è€…ç”¨äºˆç´„ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
2. è¿½åŠ è«‹æ±‚ã‚·ã‚¹ãƒ†ãƒ é€£æº
3. äºˆç´„çµ±è¨ˆãƒ»ãƒ¬ãƒãƒ¼ãƒˆ

## çµè«–

**æ¨å¥¨**: æ¡ˆ3ï¼ˆã‚·ãƒ³ãƒ—ãƒ«çµ±åˆç‰ˆï¼‰ã‹ã‚‰å§‹ã‚ã¦ã€æ®µéšçš„ã«æ¡ˆ2ã®æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹æ–¹æ³•
- æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã‚’å£Šã•ãšã€ç¢ºå®Ÿã«å‹•ä½œ
- å††å±±å‹•ç‰©ç—…é™¢æ–¹å¼ã§ã‚‚æ—¢å­˜å®Ÿè£…ã¸ã®å½±éŸ¿ã¯100%ã‚¼ãƒ­
- å°†æ¥çš„ãªæ‹¡å¼µæ€§ã‚‚ç¢ºä¿

**å®‰å…¨æ€§**: ã©ã®æ¡ˆã§ã‚‚æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¯å®Œå…¨ã«ä¿è­·ã•ã‚Œã‚‹
1. æ—¢å­˜APIã‚’ä¸€åˆ‡å¤‰æ›´ã—ãªã„
2. æ–°ã—ã„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ã¿è¿½åŠ 
3. æ—¢å­˜ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æ–°ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ ã®ã¿
4. æ–°æ©Ÿèƒ½ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚æ—¢å­˜æ©Ÿèƒ½ã¯å‹•ä½œ
5. æ®µéšçš„å®Ÿè£…å¯èƒ½